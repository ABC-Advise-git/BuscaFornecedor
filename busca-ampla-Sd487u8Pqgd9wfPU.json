{"updatedAt":"2025-12-01T14:18:26.686Z","createdAt":"2025-10-02T13:45:36.031Z","id":"Sd487u8Pqgd9wfPU","name":"Busca-Ampla","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowInputs":{"values":[{"name":"_cnaes","type":"array"},{"name":"_uf_filtro","type":"array"},{"name":"_data_limite"},{"name":"_termos","type":"array"},{"name":"_porte_empresa","type":"array"},{"name":"_natureza_juridica","type":"array"},{"name":"_codigo_municipio","type":"array"},{"name":"escopo_segmento"},{"name":"tipo_busca"},{"name":"id_consulta"},{"name":"n_cnaes_buscados"},{"name":"range_busca","type":"number"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-4416,1728],"id":"3f685da0-ff49-46e9-a78c-46ad780111ec","name":"filtros_supabase"},{"parameters":{"content":"## Capital Social\n","height":224,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2960,1872],"id":"0d30e213-10a6-4b38-9273-24742f7ad5c0","name":"Sticky Note2"},{"parameters":{"workflowId":{"__rl":true,"value":"8wGQEu6ASkKw1oMS","mode":"list","cachedResultUrl":"/workflow/8wGQEu6ASkKw1oMS","cachedResultName":"Envia e-mail"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data.email_fornecedor":"={{ $json.correio_eletronico }}","data.cnpj_basico":"={{ $json.cnpj_basico }}","data.cnpj_ordem":"={{ $json.cnpj_ordem }}","data.cnpj_dv":"={{ $json.cnpj_dv }}","data.id_consulta":"={{ $('filtros_supabase').item.json.id_consulta }}","data.motivo":"capital_social"},"matchingColumns":[],"schema":[{"id":"data.email_fornecedor","displayName":"data.email_fornecedor","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.motivo","displayName":"data.motivo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_basico","displayName":"data.cnpj_basico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_dv","displayName":"data.cnpj_dv","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_ordem","displayName":"data.cnpj_ordem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.id_consulta","displayName":"data.id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-2896,1936],"id":"181c41a5-2992-4a7c-92fa-dd57f155324d","name":"Call 'Envia e-mail'"},{"parameters":{"content":"## Sem resumo","height":240,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1536,1616],"id":"2fbe3575-5fc4-4a07-b4bc-b5046bb81de5","name":"Sticky Note4"},{"parameters":{"workflowId":{"__rl":true,"value":"8wGQEu6ASkKw1oMS","mode":"list","cachedResultUrl":"/workflow/8wGQEu6ASkKw1oMS","cachedResultName":"Envia e-mail"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data.email_fornecedor":"={{ $json.email }}","data.cnpj_basico":"={{ $json.cnpj_basico }}","data.cnpj_ordem":"={{ $json.cnpj_ordem }}","data.cnpj_dv":"={{ $json.cnpj_dv }}","data.id_consulta":"={{ $('filtros_supabase').item.json.id_consulta }}","data.motivo":"sem_resumo"},"matchingColumns":[],"schema":[{"id":"data.email_fornecedor","displayName":"data.email_fornecedor","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.motivo","displayName":"data.motivo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_basico","displayName":"data.cnpj_basico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_dv","displayName":"data.cnpj_dv","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_ordem","displayName":"data.cnpj_ordem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.id_consulta","displayName":"data.id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-1472,1696],"id":"d91444b2-3127-497e-a2be-9a137ad10434","name":"Call 'Envia e-mail'2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"61a4723e-78ee-4df4-8f99-9cffb4fe9c9f","leftValue":"={{ $json.resumo_empresa }}","rightValue":"nao_encontrado","operator":{"type":"string","operation":"notEquals"}},{"id":"17fbec4b-c075-4ba0-9208-5cf438d90217","leftValue":"={{ $json.resumo_empresa }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1696,1360],"id":"76a81153-a2ca-4b31-ab2f-4a2ac98df59d","name":"tem resumo?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7135792c-07b2-47f5-bf01-1c87cf454916","leftValue":"={{ $json.capital_social_str.split(\",\").first().toNumber()}}","rightValue":2000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3152,1696],"id":"298309ad-96eb-458f-8098-a7778912774e","name":"+2000","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7135792c-07b2-47f5-bf01-1c87cf454916","leftValue":"={{ $json.capital_social_str.split(\",\").first().toNumber()}}","rightValue":2000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3792,1728],"id":"9d99e832-514a-4ed5-b7ca-b4b000b41b06","name":"+2001","alwaysOutputData":true},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-1920,1376],"id":"bd0a3da2-3345-40aa-8563-6c37bce51539","name":"Merge"},{"parameters":{"content":"## Banco de dados:\n- Busca Empresas na view materializada.\n- Filtra as com capital social <2000.","height":304,"width":384,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4032,1600],"id":"747a4159-03b1-47ec-a182-33abba069b2c","name":"Sticky Note22"},{"parameters":{"content":"## Banco de dados:\n- Busca empresas já enriquecidas no banco.\n- Filtra as que não possuem resumo.","height":432,"width":560,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2352,1168],"id":"d6c9b122-efc6-4db4-9cef-ca40301f36f0","name":"Sticky Note28"},{"parameters":{"content":"## Processamento:\n- Itera pelas empresas encontradas.\n- Gera análises sobre a compatibilidade das empresas para o escopo atual.\n- Gera uma nota de compatibilidade.\n-- Se a nota for 30+ insere no banco e mostra no front.","height":400,"width":912,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1776,1200],"id":"712b04dd-dc02-4c46-a8d3-228102f622de","name":"Sticky Note3"},{"parameters":{"fieldToSplitOut":"resultados","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-672,1312],"id":"53d02bbd-a9fa-42b0-b754-bc97031e91f6","name":"Split Out2","alwaysOutputData":true},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"nota"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-304,1312],"id":"8a6420f2-0ba0-418f-93ba-6fce9e151e1f","name":"Aggregate4","alwaysOutputData":true},{"parameters":{"aggregate":"aggregateAllItemData","include":"specifiedFields","fieldsToInclude":"razao_social, nome_fantasia, resumo_empresa, clientes, segmentos_industriais, tipo_fornecedor, especialidades, exemplo_servico, categorias_materais, cnpj_basico, cnpj_ordem, telefone, instagram, email, site","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-1232,1392],"id":"8682bdde-e649-4a42-9420-60b8b5a29591","name":"Aggregate5","alwaysOutputData":true},{"parameters":{"batchSize":10,"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-1456,1376],"id":"68c455ac-21b7-4513-954e-06f947cf3a12","name":"Loop Over Items4"},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"get","tableId":"consultas","filters":{"conditions":[{"keyName":"id","keyValue":"={{ $('filtros_supabase').item.json.id_consulta }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-832,1312],"id":"b3670df3-23a6-4b7c-a928-00629ff6aacf","name":"get_result","executeOnce":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"update","tableId":"consultas","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('get_result').item.json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"concluida"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[128,1200],"id":"058181fd-ba75-45ad-84c4-87d8a14a30cb","name":"concluído1","credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv($1, $2, $3, $4, $5, $6, $7, $8, $9);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n  $('filtros_supabase').first().json._data_limite,\n  (typeof $('filtros_supabase').first().json._termos === 'string') ? JSON.parse($('filtros_supabase').first().json._termos) : $('filtros_supabase').first().json._termos,\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio\n,$('filtros_supabase').item.json.range_busca,$('filtros_supabase').item.json.n_cnaes_buscados.toNumber()]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3968,1728],"id":"c3d2281b-da06-4103-9e29-6911d5f2cd79","name":"busca_view_materializada1","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"content":"## Regra de Negócio:\n- Caso a consulta já tenha pelo menos 4 resultados 70+, ela é marcada como concluída.\n- Caso contrário, uma busca mais ampla é iniciada.\n\n","height":368,"width":1152,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-848,1168],"id":"615b773b-15e8-4976-9414-0fc5afefa694","name":"Sticky Note5"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"77df7537-a8a5-49d3-a4f7-6b1b4eb16bf5","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3440,1776],"id":"34eaa3cb-19fb-4c47-9ff8-5c647d99ff03","name":"vazio?3"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv_sem_termos($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n\n  $('filtros_supabase').first().json._data_limite,\n\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ?JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio,\n\n$('filtros_supabase').item.json.range_busca,\n\n$('filtros_supabase').item.json.n_cnaes_buscados.toNumber()\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3552,1632],"id":"8b1b09bd-88de-416d-b68f-777abd4796c7","name":"busca_view_sem_termos1","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"77df7537-a8a5-49d3-a4f7-6b1b4eb16bf5","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3360,1632],"id":"95f89003-1024-4cb6-83c4-f2e195fdc5c8","name":"vazio_ainda?1"},{"parameters":{"content":"## Tratativa\n- Realiza uma segunda busca sem aplicar termos.","height":368,"width":656},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3632,1536],"id":"afad4a0f-cc83-4ee0-aa98-fdecaec5a813","name":"Sticky Note37"},{"parameters":{"useCustomSchema":true,"schema":"cnpj_db","operation":"get","tableId":"estabelecimento","filters":{"conditions":[{"keyName":"cnpj_basico","keyValue":"={{ $('set_parametros2').item.json.data.cnpj_basico }}"},{"keyName":"cnpj_dv","keyValue":"={{ $('set_parametros2').item.json.data.cnpj_dv }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2112,1456],"id":"a4f2b091-b60e-40ed-b033-9c8be204fed4","name":"get_estabelecimento1","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"useCustomSchema":true,"schema":"cnpj_db","operation":"get","tableId":"empresas","filters":{"conditions":[{"keyName":"cnpj_basico","keyValue":"={{ $('set_parametros2').item.json.data.cnpj_basico }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2112,1296],"id":"8beccd45-85cc-4667-9b64-1c965dc4cc72","name":"get_empresas1","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"amount":120},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-1136,1280],"id":"06b2cf45-e123-4470-9cbb-060afe467986","name":"wait_2min1","webhookId":"818699c7-aa32-4a84-b4c2-a1f041ab3598"},{"parameters":{"operation":"get","key":"={{ $json.id_consulta }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4224,1728],"id":"1516065e-f7bf-4780-a077-40993d349686","name":"get","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"operation":"push","list":"={{ $('filtros_supabase').item.json.id_consulta }}","messageData":"={{ $json.razao_social || \"\" }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2512,1696],"id":"adff32fd-599f-4a08-a3d6-553b7885de98","name":"put1","alwaysOutputData":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"content":"## Tratativa\n- Filtra cnpjs que já apareceram em consultas anteriores.\n- Adiciona os cnpjs processados em uma fila.","height":288,"width":592},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2960,1568],"id":"35b4dc06-c59c-48e1-acfa-93ed62e8f603","name":"Sticky Note38"},{"parameters":{"content":"## Tratativa\n- Busca fila com todos os cnpjs já usados nessa consulta","height":256},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4288,1616],"id":"a3be5568-dfed-4f4d-9add-bb38e979c555","name":"Sticky Note39"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"632881b3-acbb-465e-ba03-0931e4bbdee8","leftValue":"={{ $('get').item.json.propertyName }}","rightValue":"={{ $json.razao_social }}","operator":{"type":"array","operation":"notContains","rightType":"any"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-2912,1696],"id":"24505185-7822-4222-ad05-2c536236bc1f","name":"cnpj_ja_usado1","alwaysOutputData":true},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"empresas","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-3536,2064],"id":"addec16d-e33e-4bec-992c-82d9cc1ac574","name":"Aggregate1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7c5a7467-a8ea-4580-bf9d-762cd595e883","leftValue":"={{ $json.empresas.length}}","rightValue":100,"operator":{"type":"number","operation":"lte"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3376,2064],"id":"7d9e3b65-cbba-42b4-8687-f47311e73837","name":"length<100?1"},{"parameters":{"fieldToSplitOut":"empresas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-3152,2000],"id":"e2d83807-907f-4757-8f44-d2f3f71c60c3","name":"Split Out3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"77df7537-a8a5-49d3-a4f7-6b1b4eb16bf5","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2736,1696],"id":"20bdb149-b849-4e4f-b9f0-23c542153b5e","name":"vazio?4","alwaysOutputData":false},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[128,1376],"id":"fa07aa56-6cc4-4d7d-aa82-fc63eae7bcf8","name":"No Operation, do nothing2"},{"parameters":{"content":"## Processamento:\n- Enriquece as empresas que passam do filtro.","height":240,"width":592,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2144,1616],"id":"a4c751b6-76fa-4167-bf47-30a68b2b7092","name":"Sticky Note29"},{"parameters":{"assignments":{"assignments":[{"id":"3edec4ec-bf65-452c-8d80-d25f8d29c3c9","name":"data.cnpj","value":"={{ $json.cnpj }}","type":"string"},{"id":"0798b63f-e5b8-4a86-92b9-a69b743031e7","name":"data.razao_social","value":"={{ $json.razao_social }}","type":"string"},{"id":"486ecd29-cdc6-45f6-97d7-28cd8c009e97","name":"data.nome_fantasia","value":"={{ $json.nome_fantasia }}","type":"string"},{"id":"590dd63e-366f-436b-9744-26e6ae1c0f3a","name":"data.matriz_filial","value":"={{ $json.matriz_filial }}","type":"string"},{"id":"ff9a0ec8-94f5-4e55-a04d-0ea2af759259","name":"data.situacao_cadastral","value":"={{ $json.situacao_cadastral }}","type":"string"},{"id":"ff06f725-ba26-45bc-85d7-7da962366c5d","name":"data.data_inicio_atividades","value":"={{ $json.data_inicio_atividades }}","type":"string"},{"id":"d5d2fb79-f093-4e09-9d5c-aa525b54711f","name":"data.natureza_juridica","value":"={{ $json.natureza_juridica }}","type":"string"},{"id":"07fd73c5-121e-466b-a3c1-7ac9895b6ce6","name":"data.porte_empresa","value":"={{ $json.porte_empresa }}","type":"string"},{"id":"cce1a3b3-b23a-4777-a7b1-7a20e05c8eb4","name":"data.cnae_fiscal_principal_codigo","value":"={{ $json.cnae_fiscal_principal_codigo }}","type":"string"},{"id":"0516c15e-9966-4047-9c19-2b369b3dcda3","name":"data.cnae_fiscal_principal_nome","value":"={{ $json.cnae_fiscal_principal_nome }}","type":"string"},{"id":"0690363a-a589-4bee-8d46-9e9c1966db99","name":"data.uf","value":"={{ $json.uf }}","type":"string"},{"id":"d1142f5a-99f5-4b4d-800d-8f1c5fc4fd00","name":"data.nome_municipio","value":"={{ $json.nome_municipio }}","type":"string"},{"id":"0af5a445-8322-4682-b9ce-9c1bc7e9a1e2","name":"data.site","value":"={{ $json.site }}","type":"string"},{"id":"54eef589-85b1-46c4-a36f-7e8a861b3fd2","name":"data.todos_codigos_cnae","value":"={{ $json.todos_codigos_cnae }}","type":"string"},{"id":"28ff89f7-a272-40bb-9c2c-8bcfd837399b","name":"data.todos_nomes_cnae","value":"={{ $json.todos_nomes_cnae }}","type":"string"},{"id":"f0a9de01-ebb2-48a6-b09f-7ca13e08cdfe","name":"data.cnpj_basico","value":"={{ $json.cnpj_basico }}","type":"string"},{"id":"395e2ea9-9494-4d62-8953-91e290f9c514","name":"data.cnpj_ordem","value":"={{ $json.cnpj_ordem }}","type":"string"},{"id":"c94dde4d-09ed-4169-83c2-1f94fa5c1295","name":"data.cnpj_dv","value":"={{ $json.cnpj_dv }}","type":"string"},{"id":"a468d569-3d7e-4037-9560-3734845c3654","name":"data.cnae_fiscal_secundaria_str","value":"={{ $json.cnae_fiscal_secundaria_str }}","type":"string"},{"id":"04715313-4947-4e51-ba84-0eb2948df893","name":"data.clientes","value":"={{ $json.clientes }}","type":"string"},{"id":"f055cca1-2568-4b1c-8168-d104bf7a850d","name":"data.correio_eletronico","value":"={{ $json.correio_eletronico }}","type":"string"},{"id":"9c57165c-506b-4938-8df6-96feea7c6953","name":"data.capital_social_str","value":"={{ $json.capital_social_str }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2096,1696],"id":"1b27e489-7c19-44bc-a172-f946765aeac1","name":"set_parametros2"},{"parameters":{"url":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/3cb44ad0-3cd0-4ffa-8193-1d009acc8628","sendBody":true,"bodyParameters":{"parameters":[{"name":"data","value":"={{ $json.data }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1888,1696],"id":"603e796c-1586-439c-847d-fb20e6bd00e6","name":"enriquece_cnpj_sub2"},{"parameters":{"url":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/74b8dbdb-2fdd-44b5-a71e-88750862316f","sendBody":true,"bodyParameters":{"parameters":[{"name":"data","value":"={{ $json.data }}"},{"name":"filtro_supabase","value":"={{ $('filtros_supabase').item.json.escopo_segmento }}"},{"name":"consulta_id","value":"={{ $('filtros_supabase').item.json.id_consulta }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1040,1392],"id":"546c1305-3879-47ba-964d-203ca4a14b72","name":"processa_empresa_sub2","alwaysOutputData":false},{"parameters":{"amount":120},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-2304,1392],"id":"dcc88133-e9ed-41f5-a699-4e7890f9003a","name":"Wait_2min1","webhookId":"3152c98e-643b-4532-81bf-2e7da3fb5c76"},{"parameters":{"content":"## Tratativa\n- Verifica se houveram menos de 100 resultados.\n- Se sim: Realiza uma nova busca sem aplicar termos.\n- Se não: Segue com o fluxo.","height":320,"width":656},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3632,1920],"id":"4426188b-a12e-43aa-aac9-10996b126ace","name":"Sticky Note"},{"parameters":{"batchSize":500,"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-2304,1696],"id":"e4e5c1b8-26a8-4b33-83e1-5d4e43642d66","name":"Loop Over Items"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-1712,1696],"id":"993a78fa-3b8d-44ea-a61f-1a4610ea4d29","name":"Wait","webhookId":"19449239-1e4f-40bd-9efa-4450ef70009b"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fc20e47d-3914-48ba-824e-b88ef182ac5d","leftValue":"={{ $json.item.nota }}","rightValue":80,"operator":{"type":"number","operation":"gte"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-480,1312],"id":"5f157128-3113-41b9-bcc8-d2c7a199cf8b","name":"nota = 80 ou mais","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9cfd503a-d6fe-47a9-80f9-9da528338ebe","leftValue":"={{ $json.nota.length }}","rightValue":4,"operator":{"type":"number","operation":"gte"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-112,1312],"id":"bce64885-8677-4a7f-aae2-011730b95853","name":"resultados>limite_minimo"}],"connections":{"filtros_supabase":{"main":[[{"node":"get","type":"main","index":0}]]},"tem resumo?":{"main":[[{"node":"Loop Over Items4","type":"main","index":0}],[{"node":"Call 'Envia e-mail'2","type":"main","index":0}]]},"+2000":{"main":[[{"node":"cnpj_ja_usado1","type":"main","index":0}],[{"node":"Call 'Envia e-mail'","type":"main","index":0}]]},"+2001":{"main":[[{"node":"vazio?3","type":"main","index":0}],[{"node":"Call 'Envia e-mail'","type":"main","index":0}]]},"Merge":{"main":[[{"node":"tem resumo?","type":"main","index":0}]]},"Split Out2":{"main":[[{"node":"nota = 80 ou mais","type":"main","index":0}]]},"Aggregate4":{"main":[[{"node":"resultados>limite_minimo","type":"main","index":0}]]},"Aggregate5":{"main":[[{"node":"processa_empresa_sub2","type":"main","index":0}]]},"Loop Over Items4":{"main":[[{"node":"wait_2min1","type":"main","index":0}],[{"node":"Aggregate5","type":"main","index":0}]]},"get_result":{"main":[[{"node":"Split Out2","type":"main","index":0}]]},"busca_view_materializada1":{"main":[[{"node":"+2001","type":"main","index":0}]]},"vazio?3":{"main":[[{"node":"busca_view_sem_termos1","type":"main","index":0}],[{"node":"Aggregate1","type":"main","index":0}]]},"busca_view_sem_termos1":{"main":[[{"node":"vazio_ainda?1","type":"main","index":0}]]},"vazio_ainda?1":{"main":[[],[{"node":"+2000","type":"main","index":0}]]},"get_estabelecimento1":{"main":[[{"node":"Merge","type":"main","index":1}]]},"get_empresas1":{"main":[[{"node":"Merge","type":"main","index":0}]]},"wait_2min1":{"main":[[{"node":"get_result","type":"main","index":0}]]},"get":{"main":[[{"node":"busca_view_materializada1","type":"main","index":0}]]},"put1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"cnpj_ja_usado1":{"main":[[{"node":"vazio?4","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"length<100?1","type":"main","index":0}]]},"length<100?1":{"main":[[{"node":"busca_view_sem_termos1","type":"main","index":0}],[{"node":"Split Out3","type":"main","index":0}]]},"Split Out3":{"main":[[{"node":"+2000","type":"main","index":0}]]},"vazio?4":{"main":[[{"node":"No Operation, do nothing2","type":"main","index":0}],[{"node":"put1","type":"main","index":0}]]},"set_parametros2":{"main":[[{"node":"enriquece_cnpj_sub2","type":"main","index":0}]]},"enriquece_cnpj_sub2":{"main":[[{"node":"Wait","type":"main","index":0}]]},"processa_empresa_sub2":{"main":[[{"node":"Loop Over Items4","type":"main","index":0}]]},"Wait_2min1":{"main":[[{"node":"get_empresas1","type":"main","index":0},{"node":"get_estabelecimento1","type":"main","index":0}]]},"Loop Over Items":{"main":[[{"node":"Wait_2min1","type":"main","index":0}],[{"node":"set_parametros2","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"nota = 80 ou mais":{"main":[[{"node":"Aggregate4","type":"main","index":0}]]},"resultados>limite_minimo":{"main":[[{"node":"concluído1","type":"main","index":0}],[{"node":"No Operation, do nothing2","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"filtros_supabase":[{"json":{"_cnaes":["4120400","4299599","4329199","4399199","4330402","4330404","4330499","4399102","4330405","4213800"],"_uf_filtro":["RJ"],"_data_limite":"20230101\n","_termos":["instpis","pisotatil","piso","tátil","adesivopiso","revistinst","pisotactil","instalpis","pisoade","tactilpis","pisinstal","revistpiso","tátilinst","pisoacess","insttátil","pisoades","revisttátil","pisoacessivel","instalação","pisos"],"_porte_empresa":["00","01","05","03"],"_natureza_juridica":["2062"],"escopo_segmento":"Instalação de piso , Serviço de instalação de piso tátil adesivo ","tipo_busca":"generalista","id_consulta":"318227fa-2a92-4055-82a9-01a13bcd55fb","n_cnaes_buscados":"2"}}]},"versionId":"ced00d4d-0c26-46db-a3d2-684af9559641","triggerCount":0,"shared":[{"updatedAt":"2025-10-02T13:45:36.031Z","createdAt":"2025-10-02T13:45:36.031Z","role":"workflow:owner","workflowId":"Sd487u8Pqgd9wfPU","projectId":"jk0yZKautC5L7CBp"}],"tags":[{"updatedAt":"2025-10-02T13:53:47.318Z","createdAt":"2025-10-02T13:53:47.318Z","id":"El7C2Bp08WUbNazn","name":"Subworkflow"}]}