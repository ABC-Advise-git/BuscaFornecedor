{"updatedAt":"2025-10-28T16:58:19.903Z","createdAt":"2025-10-14T19:48:05.747Z","id":"5RAAO9O35SiHZKx6","name":"Busca-Ampla copy","active":false,"isArchived":false,"nodes":[{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-2016,656],"id":"f271035f-90b0-4859-a132-029d3e449729","name":"Loop Over Items"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-1856,336],"id":"ba6c09b7-44fe-4b5f-8910-1d3b8465dcea","name":"Merge1"},{"parameters":{"content":"## Banco de dados:\n- Busca Empresas na view materializada.\n- Filtra as com capital social <2000.","height":304,"width":384,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3696,560],"id":"129b9b9b-4888-431b-9bd1-0bc006d61b8c","name":"Sticky Note21"},{"parameters":{"content":"## Processamento:\n- Enriquece as empresas que passam do filtro.","height":288,"width":800,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2288,576],"id":"48ef6e22-0796-496e-a4a7-c3266a68a223","name":"Sticky Note25"},{"parameters":{"content":"## Banco de dados:\n- Busca empresas já enriquecidas no banco.\n- Filtra as que não possuem resumo.","height":432,"width":560,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2288,128],"id":"6560ffec-7570-4b7a-94bf-340faed09b70","name":"Sticky Note26"},{"parameters":{"content":"## Processamento:\n- Itera pelas empresas encontradas.\n- Gera análises sobre a compatibilidade das empresas para o escopo atual.\n- Gera uma nota de compatibilidade.\n-- Se a nota for 30+ insere no banco e mostra no front.","height":496,"width":912,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1712,64],"id":"4eed0011-6520-46ff-8bd2-6217aa58ac5b","name":"Sticky Note"},{"parameters":{"workflowInputs":{"values":[{"name":"_cnaes","type":"array"},{"name":"_uf_filtro","type":"array"},{"name":"_data_limite"},{"name":"_termos","type":"array"},{"name":"_porte_empresa","type":"array"},{"name":"_natureza_juridica","type":"array"},{"name":"_codigo_municipio","type":"array"},{"name":"escopo_segmento"},{"name":"tipo_busca"},{"name":"id_consulta"},{"name":"n_cnaes_buscados"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-4064,688],"id":"9d911407-c7c9-4b7f-a445-1fc313b0e1a2","name":"filtros_supabase"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9cfd503a-d6fe-47a9-80f9-9da528338ebe","leftValue":"={{ $json.nota.length }}","rightValue":4,"operator":{"type":"number","operation":"gte"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-48,272],"id":"37617ab4-6eb7-456b-962d-f9f90a335f29","name":"resultados+70>4"},{"parameters":{"fieldToSplitOut":"resultados","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-608,272],"id":"0745a20a-f4bc-4ff5-aa74-b11b144c9f30","name":"Split Out1"},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"nota"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-240,272],"id":"c30a051c-f11e-46d0-8df2-ba7843bd8766","name":"Aggregate2"},{"parameters":{"aggregate":"aggregateAllItemData","include":"specifiedFields","fieldsToInclude":"razao_social, nome_fantasia, resumo_empresa, clientes, segmentos_industriais, tipo_fornecedor, especialidades, exemplo_servico, categorias_materais, cnpj_basico, cnpj_ordem, telefone, instagram, email, site","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-1168,384],"id":"c4a9c20a-e033-4e75-ab9e-f9e2698ff897","name":"Aggregate3","alwaysOutputData":true},{"parameters":{"batchSize":10,"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-1392,368],"id":"03949ea3-c425-431f-8867-ff921577b966","name":"Loop Over Items3"},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"get","tableId":"consultas","filters":{"conditions":[{"keyName":"id","keyValue":"={{ $('filtros_supabase').item.json.id_consulta }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-768,272],"id":"08bf6de6-770a-4175-aa83-f3821939dc8f","name":"get_result1","executeOnce":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"update","tableId":"consultas","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('get_result1').item.json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"concluida"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[192,160],"id":"2a62063f-42c6-4f4f-b0c2-6b6ccb4dfcf0","name":"concluído","credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv($1, $2, $3, $4, $5, $6, $7, $8, $9);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n  $('filtros_supabase').first().json._data_limite,\n  (typeof $('filtros_supabase').first().json._termos === 'string') ? JSON.parse($('filtros_supabase').first().json._termos) : $('filtros_supabase').first().json._termos,\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio\n,200,$('filtros_supabase').item.json.n_cnaes_buscados.toNumber()]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3632,688],"id":"3d26994c-a73d-4088-8faf-cdcc5e214c6e","name":"busca_view_materializada","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"3edec4ec-bf65-452c-8d80-d25f8d29c3c9","name":"data.cnpj","value":"={{ $json.cnpj }}","type":"string"},{"id":"0798b63f-e5b8-4a86-92b9-a69b743031e7","name":"data.razao_social","value":"={{ $json.razao_social }}","type":"string"},{"id":"486ecd29-cdc6-45f6-97d7-28cd8c009e97","name":"data.nome_fantasia","value":"={{ $json.nome_fantasia }}","type":"string"},{"id":"590dd63e-366f-436b-9744-26e6ae1c0f3a","name":"data.matriz_filial","value":"={{ $json.matriz_filial }}","type":"string"},{"id":"ff9a0ec8-94f5-4e55-a04d-0ea2af759259","name":"data.situacao_cadastral","value":"={{ $json.situacao_cadastral }}","type":"string"},{"id":"ff06f725-ba26-45bc-85d7-7da962366c5d","name":"data.data_inicio_atividades","value":"={{ $json.data_inicio_atividades }}","type":"string"},{"id":"d5d2fb79-f093-4e09-9d5c-aa525b54711f","name":"data.natureza_juridica","value":"={{ $json.natureza_juridica }}","type":"string"},{"id":"07fd73c5-121e-466b-a3c1-7ac9895b6ce6","name":"data.porte_empresa","value":"={{ $json.porte_empresa }}","type":"string"},{"id":"cce1a3b3-b23a-4777-a7b1-7a20e05c8eb4","name":"data.cnae_fiscal_principal_codigo","value":"={{ $json.cnae_fiscal_principal_codigo }}","type":"string"},{"id":"0516c15e-9966-4047-9c19-2b369b3dcda3","name":"data.cnae_fiscal_principal_nome","value":"={{ $json.cnae_fiscal_principal_nome }}","type":"string"},{"id":"0690363a-a589-4bee-8d46-9e9c1966db99","name":"data.uf","value":"={{ $json.uf }}","type":"string"},{"id":"d1142f5a-99f5-4b4d-800d-8f1c5fc4fd00","name":"data.nome_municipio","value":"={{ $json.nome_municipio }}","type":"string"},{"id":"0af5a445-8322-4682-b9ce-9c1bc7e9a1e2","name":"data.site","value":"={{ $json.site }}","type":"string"},{"id":"54eef589-85b1-46c4-a36f-7e8a861b3fd2","name":"data.todos_codigos_cnae","value":"={{ $json.todos_codigos_cnae }}","type":"string"},{"id":"28ff89f7-a272-40bb-9c2c-8bcfd837399b","name":"data.todos_nomes_cnae","value":"={{ $json.todos_nomes_cnae }}","type":"string"},{"id":"f0a9de01-ebb2-48a6-b09f-7ca13e08cdfe","name":"data.cnpj_basico","value":"={{ $json.cnpj_basico }}","type":"string"},{"id":"395e2ea9-9494-4d62-8953-91e290f9c514","name":"data.cnpj_ordem","value":"={{ $json.cnpj_ordem }}","type":"string"},{"id":"c94dde4d-09ed-4169-83c2-1f94fa5c1295","name":"data.cnpj_dv","value":"={{ $json.cnpj_dv }}","type":"string"},{"id":"a468d569-3d7e-4037-9560-3734845c3654","name":"data.cnae_fiscal_secundaria_str","value":"={{ $json.cnae_fiscal_secundaria_str }}","type":"string"},{"id":"04715313-4947-4e51-ba84-0eb2948df893","name":"data.clientes","value":"={{ $json.clientes }}","type":"string"},{"id":"f055cca1-2568-4b1c-8168-d104bf7a850d","name":"data.correio_eletronico","value":"={{ $json.correio_eletronico }}","type":"string"},{"id":"9c57165c-506b-4938-8df6-96feea7c6953","name":"data.capital_social_str","value":"={{ $json.capital_social_str }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2208,656],"id":"a5fb6e32-86d9-4bd7-8629-a6d3a701fe18","name":"set_parametros"},{"parameters":{"url":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/enriquece-cnpj-teste","sendBody":true,"bodyParameters":{"parameters":[{"name":"data","value":"={{ $json.data }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1824,672],"id":"6eabf683-2163-4e8e-9222-aaf300d27a87","name":"enriquece_cnpj_sub"},{"parameters":{"content":"## Regra de Negócio:\n- Caso a consulta já tenha pelo menos 4 resultados 70+, ela é marcada como concluída.\n- Caso contrário, uma busca mais ampla é iniciada.\n\n","height":288,"width":1152,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-784,128],"id":"7c42871e-035b-4a4f-a2d0-f9c899aca281","name":"Sticky Note1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fc20e47d-3914-48ba-824e-b88ef182ac5d","leftValue":"={{ $json.item.nota }}","rightValue":70,"operator":{"type":"number","operation":"gte"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-416,272],"id":"d4636800-f941-4512-92f5-5784c4a44ecd","name":"nota = 70+"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"77df7537-a8a5-49d3-a4f7-6b1b4eb16bf5","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3120,768],"id":"e66bd482-d8d4-41b9-a4b6-eda0663d3c4b","name":"vazio?"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv_sem_termos($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n\n  $('filtros_supabase').first().json._data_limite,\n\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ?JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio,\n\n200,\n\n$('filtros_supabase').item.json.n_cnaes_buscados.toNumber()\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3232,592],"id":"45a0fee9-359a-4fff-beb3-8bd27c0d5d44","name":"busca_view_sem_termos","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"77df7537-a8a5-49d3-a4f7-6b1b4eb16bf5","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3040,592],"id":"28fe5a93-f887-4e84-aef9-6fb8782050f3","name":"vazio_ainda?"},{"parameters":{"content":"## Tratativa\n- Realiza uma segunda busca sem aplicar termos.","height":448,"width":576},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3296,496],"id":"8f83e8fb-3c7d-493a-9548-d432796a4954","name":"Sticky Note34"},{"parameters":{"amount":60},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-2240,352],"id":"b6cf591f-b64f-4311-bcbb-20c66349406e","name":"Wait_1min","webhookId":"3152c98e-643b-4532-81bf-2e7da3fb5c76"},{"parameters":{"useCustomSchema":true,"schema":"cnpj_db","operation":"get","tableId":"estabelecimento","filters":{"conditions":[{"keyName":"cnpj_basico","keyValue":"={{ $('set_parametros').item.json.data.cnpj_basico }}"},{"keyName":"cnpj_dv","keyValue":"={{ $('set_parametros').item.json.data.cnpj_dv }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2048,416],"id":"023c2e90-56cc-4a96-b11b-fe656e9e83ae","name":"get_estabelecimento","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"useCustomSchema":true,"schema":"cnpj_db","operation":"get","tableId":"empresas","filters":{"conditions":[{"keyName":"cnpj_basico","keyValue":"={{ $('set_parametros').item.json.data.cnpj_basico }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2048,256],"id":"e0753acb-592a-4693-9bda-c1cdb1c9ea75","name":"get_empresas","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"url":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/processa-empresa-copy","sendBody":true,"bodyParameters":{"parameters":[{"name":"data","value":"={{ $json.data }}"},{"name":"filtro_supabase","value":"={{ $('filtros_supabase').item.json.escopo_segmento }}"},{"name":"consulta_id","value":"={{ $('filtros_supabase').item.json.id_consulta }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-960,384],"id":"0b495f4c-2631-407a-b7f4-f5f954f78dcd","name":"processa_empresa_sub"},{"parameters":{"amount":120},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-1072,272],"id":"f5292741-1c8f-4f33-9845-4dfec1e94f37","name":"wait_2min","webhookId":"818699c7-aa32-4a84-b4c2-a1f041ab3598"},{"parameters":{"operation":"get","key":"={{ $json.id_consulta }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3888,688],"id":"de0606a8-5ac7-48a2-a9e1-ce13cc1eb263","name":"get1","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"operation":"push","list":"={{ $('filtros_supabase').item.json.id_consulta }}","messageData":"={{ $json.razao_social || \"\" }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2448,656],"id":"0760b6fc-ad05-4b31-a52c-a069d6e6dd34","name":"put","alwaysOutputData":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"content":"## Tratativa\n- Filtra cnpjs que já apareceram em consultas anteriores.\n- Adiciona os cnpjs processados em uma fila.","height":288,"width":400},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2704,528],"id":"0196ad2d-14f4-4dda-800b-642ad460344a","name":"Sticky Note35"},{"parameters":{"content":"## Tratativa\n- Busca fila com todos os cnpjs já usados nessa consulta","height":256},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3952,576],"id":"c6cf4ca5-ba33-46ad-a18a-460618d8191d","name":"Sticky Note36"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"632881b3-acbb-465e-ba03-0931e4bbdee8","leftValue":"={{ $('get1').item.json.propertyName }}","rightValue":"={{ $json.razao_social }}","operator":{"type":"array","operation":"notContains","rightType":"any"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-2656,656],"id":"42e5e8a5-b581-4068-b6ea-fd1bfe2f01d3","name":"cnpj_ja_usado","alwaysOutputData":true},{"parameters":{"amount":1},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-1648,672],"id":"c8f19d17-fee9-4512-b72e-9406a25f1241","name":"wait_1_sec","webhookId":"ba00f1a1-1062-4fed-826b-0ec8b49cc1a2"},{"parameters":{"content":"## Capital Social\n","height":224,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2704,832],"id":"592fc750-599d-479b-abdc-93aa5ab289f7","name":"Sticky Note2"},{"parameters":{"workflowId":{"__rl":true,"value":"8wGQEu6ASkKw1oMS","mode":"list","cachedResultUrl":"/workflow/8wGQEu6ASkKw1oMS","cachedResultName":"Envia e-mail"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data.email_fornecedor":"={{ $json.correio_eletronico }}","data.cnpj_basico":"={{ $json.cnpj_basico }}","data.cnpj_ordem":"={{ $json.cnpj_ordem }}","data.cnpj_dv":"={{ $json.cnpj_dv }}","data.id_consulta":"={{ $('filtros_supabase').item.json.id_consulta }}","data.motivo":"capital_social"},"matchingColumns":[],"schema":[{"id":"data.email_fornecedor","displayName":"data.email_fornecedor","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.motivo","displayName":"data.motivo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_basico","displayName":"data.cnpj_basico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_dv","displayName":"data.cnpj_dv","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_ordem","displayName":"data.cnpj_ordem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.id_consulta","displayName":"data.id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-2640,896],"id":"24c8a549-9c4f-40d4-819a-0f465ed044bf","name":"Call 'Envia e-mail'"},{"parameters":{"content":"## Sem resumo","height":240,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1472,576],"id":"b606dcdd-6a98-4df4-82b0-4ad4bde428f4","name":"Sticky Note4"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-1392,224],"id":"286be68a-2ecd-432c-9653-e401947f72e3","name":"No Operation, do nothing"},{"parameters":{"workflowId":{"__rl":true,"value":"8wGQEu6ASkKw1oMS","mode":"list","cachedResultUrl":"/workflow/8wGQEu6ASkKw1oMS","cachedResultName":"Envia e-mail"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data.email_fornecedor":"={{ $json.email }}","data.cnpj_basico":"={{ $json.cnpj_basico }}","data.cnpj_ordem":"={{ $json.cnpj_ordem }}","data.cnpj_dv":"={{ $json.cnpj_dv }}","data.id_consulta":"={{ $('filtros_supabase').item.json.id_consulta }}","data.motivo":"sem_resumo"},"matchingColumns":[],"schema":[{"id":"data.email_fornecedor","displayName":"data.email_fornecedor","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.motivo","displayName":"data.motivo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_basico","displayName":"data.cnpj_basico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_dv","displayName":"data.cnpj_dv","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_ordem","displayName":"data.cnpj_ordem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.id_consulta","displayName":"data.id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-1408,656],"id":"a73df954-70b6-40ef-97ac-aae8f19f8817","name":"Call 'Envia e-mail'2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"61a4723e-78ee-4df4-8f99-9cffb4fe9c9f","leftValue":"={{ $json.resumo_empresa }}","rightValue":"nao_encontrado","operator":{"type":"string","operation":"equals"}},{"id":"17fbec4b-c075-4ba0-9208-5cf438d90217","leftValue":"={{ $json.resumo_empresa }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1632,352],"id":"df8d1420-0d5c-4a95-b3d0-75a8e56d59ed","name":"tem resumo?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7135792c-07b2-47f5-bf01-1c87cf454916","leftValue":"={{ $json.capital_social_str.split(\",\").first().toNumber()}}","rightValue":2000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2832,656],"id":"c2802fb4-f28e-401c-8bf5-272f2c6864c2","name":"+2000","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7135792c-07b2-47f5-bf01-1c87cf454916","leftValue":"={{ $json.capital_social_str.split(\",\").first().toNumber()}}","rightValue":2000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3456,688],"id":"15329739-8ad4-4e22-b855-b3f57a974b48","name":"+2001","alwaysOutputData":true}],"connections":{"Loop Over Items":{"main":[[{"node":"Wait_1min","type":"main","index":0}],[{"node":"enriquece_cnpj_sub","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"tem resumo?","type":"main","index":0}]]},"filtros_supabase":{"main":[[{"node":"get1","type":"main","index":0}]]},"resultados+70>4":{"main":[[{"node":"concluído","type":"main","index":0}],[]]},"Split Out1":{"main":[[{"node":"nota = 70+","type":"main","index":0}]]},"Aggregate2":{"main":[[{"node":"resultados+70>4","type":"main","index":0}]]},"Aggregate3":{"main":[[{"node":"processa_empresa_sub","type":"main","index":0}]]},"Loop Over Items3":{"main":[[{"node":"wait_2min","type":"main","index":0}],[{"node":"Aggregate3","type":"main","index":0}]]},"get_result1":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"busca_view_materializada":{"main":[[{"node":"+2001","type":"main","index":0}]]},"set_parametros":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"enriquece_cnpj_sub":{"main":[[{"node":"wait_1_sec","type":"main","index":0}]]},"nota = 70+":{"main":[[{"node":"Aggregate2","type":"main","index":0}]]},"vazio?":{"main":[[{"node":"busca_view_sem_termos","type":"main","index":0}],[{"node":"cnpj_ja_usado","type":"main","index":0}]]},"busca_view_sem_termos":{"main":[[{"node":"vazio_ainda?","type":"main","index":0}]]},"vazio_ainda?":{"main":[[],[{"node":"+2000","type":"main","index":0}]]},"Wait_1min":{"main":[[{"node":"get_empresas","type":"main","index":0},{"node":"get_estabelecimento","type":"main","index":0}]]},"get_estabelecimento":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"get_empresas":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"processa_empresa_sub":{"main":[[{"node":"Loop Over Items3","type":"main","index":0}]]},"wait_2min":{"main":[[{"node":"get_result1","type":"main","index":0}]]},"get1":{"main":[[{"node":"busca_view_materializada","type":"main","index":0}]]},"put":{"main":[[{"node":"set_parametros","type":"main","index":0}]]},"cnpj_ja_usado":{"main":[[{"node":"put","type":"main","index":0}]]},"wait_1_sec":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"tem resumo?":{"main":[[{"node":"Loop Over Items3","type":"main","index":0}],[{"node":"Call 'Envia e-mail'2","type":"main","index":0}]]},"+2000":{"main":[[{"node":"cnpj_ja_usado","type":"main","index":0}],[{"node":"Call 'Envia e-mail'","type":"main","index":0}]]},"+2001":{"main":[[{"node":"vazio?","type":"main","index":0}],[{"node":"Call 'Envia e-mail'","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"filtros_supabase":[{"json":{"_cnaes":["7729200","7739000","3313900","3314700","7732202","7739001","7739002","7739099","7732201","7739003"],"_uf_filtro":["SP","MG"],"_data_limite":"20240101\n","_termos":["aluguel","ferramentas","manutencao","rede","eletrica","equip","locacao","util","consert","instal","elétrica","elétrico","ferra","manuten","redeelétrica","loc","alug","equipelétrica","ferreletrica","manutrede"],"_porte_empresa":["00","01","05","03"],"_natureza_juridica":["2062"],"_codigo_municipio":["7243","7145","6157","7007","6857","3065","6495","6669","6307","7113","6521","6579","6239","6913","7123","3067","6859","7005","6269","7273","2995","7181","5363","7171","6883","6331","6551","6361","7047","6601","6399","7191","6511","6625","6213","6581","6943","6309","6547","6285","5447","6313","6401","6333","0802","6545","6629","7105","0816","6789","6737","7157","6719","6619","6403","6647","7233","6851","7237","6281","6471","6429","7225","6427","6293","6981","2951","6911","6291","0936","5445","6347","7149","6699","3227","6845","6377","6769","6569","6605","7017","6567","6623","7107","7077","6131","6671","6831","6875","7075","6477","0516","7057","6237","6143","6853","6543","6741","6689","6181","6357","6723","6595","2999","6843","6305","7137","6529","6967","6823","2953","6145","6639","6983","6241","6415","6371","2955","6175","3057","6563","6897","6953","6251","6111","6749","6177","7151","0444","6137","6921","8271","7061","6349","1857","7121","2949","6335","1851","7109","6261","7035","7071","6867","8253","6725","6873","6249","6523","5887","6979","7037","9689","6713","6397","9173","6571","7133","2957","5563","6507","7041","6453","6817","6165","6475","6837","6717","2969","3063","6505","6825","6345","4501","6611","2965","6553","6641","6593","5381","7927","7143","6231","7195","6467","7103","6109","2967","6573","6355","0814","2959","6635"],"escopo_segmento":"TESTE, Aluguel de ferramentas para mautençaõ de rede elétrica","tipo_busca":"generalista","id_consulta":"6df7d165-d094-4e77-a9fe-5ee773bfb172","n_cnaes_buscados":"2"}}]},"versionId":"494f5cff-3512-41d4-97b1-acf8a05c88de","triggerCount":0,"shared":[{"updatedAt":"2025-10-14T19:48:05.747Z","createdAt":"2025-10-14T19:48:05.747Z","role":"workflow:owner","workflowId":"5RAAO9O35SiHZKx6","projectId":"jk0yZKautC5L7CBp"}],"tags":[{"updatedAt":"2025-10-02T13:53:47.318Z","createdAt":"2025-10-02T13:53:47.318Z","id":"El7C2Bp08WUbNazn","name":"Subworkflow"},{"updatedAt":"2025-10-14T19:47:01.394Z","createdAt":"2025-10-14T19:47:01.394Z","id":"cuEnFeSTWYUSoPc7","name":"test"}]}