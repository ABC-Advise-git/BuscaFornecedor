{"updatedAt":"2025-12-08T20:27:15.897Z","createdAt":"2025-10-14T19:48:05.747Z","id":"5RAAO9O35SiHZKx6","name":"Busca-Ampla copy","active":false,"isArchived":false,"nodes":[{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-1776,656],"id":"f271035f-90b0-4859-a132-029d3e449729","name":"Loop Over Items"},{"parameters":{"content":"## Banco de dados:\n- Busca Empresas na view materializada.\n- Filtra as com capital social <2000.","height":304,"width":384,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3696,560],"id":"129b9b9b-4888-431b-9bd1-0bc006d61b8c","name":"Sticky Note21"},{"parameters":{"content":"## Processamento:\n- Enriquece as empresas que passam do filtro.","height":288,"width":624,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2048,544],"id":"48ef6e22-0796-496e-a4a7-c3266a68a223","name":"Sticky Note25"},{"parameters":{"workflowInputs":{"values":[{"name":"_cnaes","type":"array"},{"name":"_uf_filtro","type":"array"},{"name":"_data_limite"},{"name":"_termos","type":"array"},{"name":"_porte_empresa","type":"array"},{"name":"_natureza_juridica","type":"array"},{"name":"_codigo_municipio","type":"array"},{"name":"escopo_segmento"},{"name":"tipo_busca"},{"name":"id_consulta"},{"name":"n_cnaes_buscados"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-4112,688],"id":"9d911407-c7c9-4b7f-a445-1fc313b0e1a2","name":"filtros_supabase"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv($1, $2, $3, $4, $5, $6, $7, $8, $9);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n  $('filtros_supabase').first().json._data_limite,\n  (typeof $('filtros_supabase').first().json._termos === 'string') ? JSON.parse($('filtros_supabase').first().json._termos) : $('filtros_supabase').first().json._termos,\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio\n,200,$('filtros_supabase').item.json.n_cnaes_buscados.toNumber()]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3632,688],"id":"3d26994c-a73d-4088-8faf-cdcc5e214c6e","name":"busca_view_materializada","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"3edec4ec-bf65-452c-8d80-d25f8d29c3c9","name":"data.cnpj","value":"={{ $json.cnpj }}","type":"string"},{"id":"0798b63f-e5b8-4a86-92b9-a69b743031e7","name":"data.razao_social","value":"={{ $json.razao_social }}","type":"string"},{"id":"486ecd29-cdc6-45f6-97d7-28cd8c009e97","name":"data.nome_fantasia","value":"={{ $json.nome_fantasia }}","type":"string"},{"id":"590dd63e-366f-436b-9744-26e6ae1c0f3a","name":"data.matriz_filial","value":"={{ $json.matriz_filial }}","type":"string"},{"id":"ff9a0ec8-94f5-4e55-a04d-0ea2af759259","name":"data.situacao_cadastral","value":"={{ $json.situacao_cadastral }}","type":"string"},{"id":"ff06f725-ba26-45bc-85d7-7da962366c5d","name":"data.data_inicio_atividades","value":"={{ $json.data_inicio_atividades }}","type":"string"},{"id":"d5d2fb79-f093-4e09-9d5c-aa525b54711f","name":"data.natureza_juridica","value":"={{ $json.natureza_juridica }}","type":"string"},{"id":"07fd73c5-121e-466b-a3c1-7ac9895b6ce6","name":"data.porte_empresa","value":"={{ $json.porte_empresa }}","type":"string"},{"id":"cce1a3b3-b23a-4777-a7b1-7a20e05c8eb4","name":"data.cnae_fiscal_principal_codigo","value":"={{ $json.cnae_fiscal_principal_codigo }}","type":"string"},{"id":"0516c15e-9966-4047-9c19-2b369b3dcda3","name":"data.cnae_fiscal_principal_nome","value":"={{ $json.cnae_fiscal_principal_nome }}","type":"string"},{"id":"0690363a-a589-4bee-8d46-9e9c1966db99","name":"data.uf","value":"={{ $json.uf }}","type":"string"},{"id":"d1142f5a-99f5-4b4d-800d-8f1c5fc4fd00","name":"data.nome_municipio","value":"={{ $json.nome_municipio }}","type":"string"},{"id":"0af5a445-8322-4682-b9ce-9c1bc7e9a1e2","name":"data.site","value":"={{ $json.site }}","type":"string"},{"id":"54eef589-85b1-46c4-a36f-7e8a861b3fd2","name":"data.todos_codigos_cnae","value":"={{ $json.todos_codigos_cnae }}","type":"string"},{"id":"28ff89f7-a272-40bb-9c2c-8bcfd837399b","name":"data.todos_nomes_cnae","value":"={{ $json.todos_nomes_cnae }}","type":"string"},{"id":"f0a9de01-ebb2-48a6-b09f-7ca13e08cdfe","name":"data.cnpj_basico","value":"={{ $json.cnpj_basico }}","type":"string"},{"id":"395e2ea9-9494-4d62-8953-91e290f9c514","name":"data.cnpj_ordem","value":"={{ $json.cnpj_ordem }}","type":"string"},{"id":"c94dde4d-09ed-4169-83c2-1f94fa5c1295","name":"data.cnpj_dv","value":"={{ $json.cnpj_dv }}","type":"string"},{"id":"a468d569-3d7e-4037-9560-3734845c3654","name":"data.cnae_fiscal_secundaria_str","value":"={{ $json.cnae_fiscal_secundaria_str }}","type":"string"},{"id":"04715313-4947-4e51-ba84-0eb2948df893","name":"data.clientes","value":"={{ $json.clientes }}","type":"string"},{"id":"f055cca1-2568-4b1c-8168-d104bf7a850d","name":"data.correio_eletronico","value":"={{ $json.correio_eletronico }}","type":"string"},{"id":"9c57165c-506b-4938-8df6-96feea7c6953","name":"data.capital_social_str","value":"={{ $json.capital_social_str }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2208,656],"id":"a5fb6e32-86d9-4bd7-8629-a6d3a701fe18","name":"set_parametros"},{"parameters":{"url":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/enriquece-cnpj-teste","sendBody":true,"bodyParameters":{"parameters":[{"name":"data","value":"={{ $json.data }}"},{"name":"id_consulta","value":"={{ $('filtros_supabase').item.json.id_consulta }}"},{"name":"escopo_segmento","value":"={{ $('filtros_supabase').item.json.escopo_segmento }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1552,672],"id":"6eabf683-2163-4e8e-9222-aaf300d27a87","name":"enriquece_cnpj_sub"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"77df7537-a8a5-49d3-a4f7-6b1b4eb16bf5","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3120,768],"id":"e66bd482-d8d4-41b9-a4b6-eda0663d3c4b","name":"vazio?"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv_sem_termos($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n\n  $('filtros_supabase').first().json._data_limite,\n\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ?JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio,\n\n200,\n\n$('filtros_supabase').item.json.n_cnaes_buscados.toNumber()\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3232,592],"id":"45a0fee9-359a-4fff-beb3-8bd27c0d5d44","name":"busca_view_sem_termos","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"77df7537-a8a5-49d3-a4f7-6b1b4eb16bf5","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3040,592],"id":"28fe5a93-f887-4e84-aef9-6fb8782050f3","name":"vazio_ainda?"},{"parameters":{"content":"## Tratativa\n- Realiza uma segunda busca sem aplicar termos.","height":448,"width":576},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3296,496],"id":"8f83e8fb-3c7d-493a-9548-d432796a4954","name":"Sticky Note34"},{"parameters":{"operation":"get","key":"={{ $json.id_consulta }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3888,688],"id":"de0606a8-5ac7-48a2-a9e1-ce13cc1eb263","name":"get1","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"operation":"push","list":"={{ $('filtros_supabase').item.json.id_consulta }}","messageData":"={{ $json.razao_social || \"\" }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2448,656],"id":"0760b6fc-ad05-4b31-a52c-a069d6e6dd34","name":"put","alwaysOutputData":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"content":"## Tratativa\n- Filtra cnpjs que já apareceram em consultas anteriores.\n- Adiciona os cnpjs processados em uma fila.","height":288,"width":400},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2704,528],"id":"0196ad2d-14f4-4dda-800b-642ad460344a","name":"Sticky Note35"},{"parameters":{"content":"## Tratativa\n- Busca fila com todos os cnpjs já usados nessa consulta","height":256},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3952,576],"id":"c6cf4ca5-ba33-46ad-a18a-460618d8191d","name":"Sticky Note36"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"632881b3-acbb-465e-ba03-0931e4bbdee8","leftValue":"={{ $('get1').item.json.propertyName }}","rightValue":"={{ $json.razao_social }}","operator":{"type":"array","operation":"notContains","rightType":"any"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-2656,656],"id":"42e5e8a5-b581-4068-b6ea-fd1bfe2f01d3","name":"cnpj_ja_usado","alwaysOutputData":true},{"parameters":{"content":"## Capital Social\n","height":224,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2624,1136],"id":"592fc750-599d-479b-abdc-93aa5ab289f7","name":"Sticky Note2"},{"parameters":{"workflowId":{"__rl":true,"value":"8wGQEu6ASkKw1oMS","mode":"list","cachedResultUrl":"/workflow/8wGQEu6ASkKw1oMS","cachedResultName":"Envia e-mail"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data.email_fornecedor":"={{ $json.correio_eletronico }}","data.cnpj_basico":"={{ $json.cnpj_basico }}","data.cnpj_ordem":"={{ $json.cnpj_ordem }}","data.cnpj_dv":"={{ $json.cnpj_dv }}","data.id_consulta":"={{ $('filtros_supabase').item.json.id_consulta }}","data.motivo":"capital_social"},"matchingColumns":[],"schema":[{"id":"data.email_fornecedor","displayName":"data.email_fornecedor","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.motivo","displayName":"data.motivo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_basico","displayName":"data.cnpj_basico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_dv","displayName":"data.cnpj_dv","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_ordem","displayName":"data.cnpj_ordem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.id_consulta","displayName":"data.id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-2560,1200],"id":"24c8a549-9c4f-40d4-819a-0f465ed044bf","name":"Call 'Envia e-mail'"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7135792c-07b2-47f5-bf01-1c87cf454916","leftValue":"={{ $json.capital_social_str.split(\",\").first().toNumber()}}","rightValue":2000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2832,656],"id":"c2802fb4-f28e-401c-8bf5-272f2c6864c2","name":"+2000","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7135792c-07b2-47f5-bf01-1c87cf454916","leftValue":"={{ $json.capital_social_str.split(\",\").first().toNumber()}}","rightValue":2000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3456,688],"id":"15329739-8ad4-4e22-b855-b3f57a974b48","name":"+2001","alwaysOutputData":true},{"parameters":{"maxItems":10},"type":"n8n-nodes-base.limit","typeVersion":1,"position":[-2000,656],"id":"41d61fdc-df81-463e-9a1f-4e9a2809baa5","name":"Limit"}],"connections":{"Loop Over Items":{"main":[[],[{"node":"enriquece_cnpj_sub","type":"main","index":0}]]},"filtros_supabase":{"main":[[{"node":"get1","type":"main","index":0}]]},"busca_view_materializada":{"main":[[{"node":"+2001","type":"main","index":0}]]},"set_parametros":{"main":[[{"node":"Limit","type":"main","index":0}]]},"enriquece_cnpj_sub":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"vazio?":{"main":[[{"node":"busca_view_sem_termos","type":"main","index":0}],[{"node":"cnpj_ja_usado","type":"main","index":0}]]},"busca_view_sem_termos":{"main":[[{"node":"vazio_ainda?","type":"main","index":0}]]},"vazio_ainda?":{"main":[[],[{"node":"+2000","type":"main","index":0}]]},"get1":{"main":[[{"node":"busca_view_materializada","type":"main","index":0}]]},"put":{"main":[[{"node":"set_parametros","type":"main","index":0}]]},"cnpj_ja_usado":{"main":[[{"node":"put","type":"main","index":0}]]},"+2000":{"main":[[{"node":"cnpj_ja_usado","type":"main","index":0}],[]]},"+2001":{"main":[[{"node":"vazio?","type":"main","index":0}],[]]},"Limit":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"filtros_supabase":[{"json":{"_cnaes":["4683400","0134200"],"_uf_filtro":["MG"],"_data_limite":"20240101\n","_termos":["agrotox","agroquim","defensiv","praguicid","fertiliz","cafeicult","lavouracaf","cafe","agricola","agronom","fitossani","inseticid","fungicid","herbicid","pulveriz","plantio","colheita","cultivocaf","agropecu","rural"],"_porte_empresa":["00","01","05","03"],"_natureza_juridica":["2062"],"escopo_segmento":"Agro, Compra de Agrotóxicos para lavoura de café","tipo_busca":"especifica","id_consulta":"751c95c2-900e-446a-99fc-8e4c667b9d22","n_cnaes_buscados":"1"}},{"json":{"_cnaes":["4683400","0134200"],"_uf_filtro":["MG"],"_data_limite":"20240101\n","_termos":["agrotox","agroquim","defensiv","praguicid","fertiliz","cafeicult","lavouracaf","cafe","agricola","agronom","fitossani","inseticid","fungicid","herbicid","pulveriz","plantio","colheita","cultivocaf","agropecu","rural"],"_porte_empresa":["00","01","05","03"],"_natureza_juridica":["2062"],"escopo_segmento":"Agro, Compra de Agrotóxicos para lavoura de café","tipo_busca":"especifica","id_consulta":"751c95c2-900e-446a-99fc-8e4c667b9d22","n_cnaes_buscados":"1"}}]},"versionId":"ec594766-3a86-4abb-b4c2-a730b03c30d2","triggerCount":0,"shared":[{"updatedAt":"2025-10-14T19:48:05.747Z","createdAt":"2025-10-14T19:48:05.747Z","role":"workflow:owner","workflowId":"5RAAO9O35SiHZKx6","projectId":"jk0yZKautC5L7CBp"}],"tags":[{"updatedAt":"2025-10-14T19:47:01.394Z","createdAt":"2025-10-14T19:47:01.394Z","id":"cuEnFeSTWYUSoPc7","name":"test"},{"updatedAt":"2025-10-02T13:53:47.318Z","createdAt":"2025-10-02T13:53:47.318Z","id":"El7C2Bp08WUbNazn","name":"Subworkflow"}]}