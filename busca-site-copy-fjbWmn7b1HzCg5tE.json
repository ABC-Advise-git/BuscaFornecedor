{"updatedAt":"2026-02-04T19:17:21.765Z","createdAt":"2025-10-14T19:47:50.582Z","id":"fjbWmn7b1HzCg5tE","name":"Busca-Site copy","active":true,"isArchived":false,"nodes":[{"parameters":{"aggregate":"aggregateAllItemData","include":"specifiedFields","fieldsToInclude":"razao_social, nome_fantasia, resumo_empresa, clientes, segmentos_industriais, tipo_fornecedor, especialidades, exemplo_servico, categorias_materais, cnpj_basico, cnpj_ordem, telefone, instagram, email, site","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[416,480],"id":"89d0e679-a668-4f9e-a8a3-54aeae44d179","name":"Aggregate","alwaysOutputData":true},{"parameters":{"fieldToSplitOut":"todos_codigos_cnae","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-1168,480],"id":"03df24d4-1f4a-46bb-b651-7d0d19e495e1","name":"Split Out","alwaysOutputData":true},{"parameters":{"assignments":{"assignments":[{"id":"cd49782f-f1cd-478e-b6b1-4297ab91adad","name":"concatenated_todos_codigos_cnae","value":"={{ $json.concatenated_todos_codigos_cnae.replaceAll(\" \", \"\").split(\",\").unique().sort()}}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-720,480],"id":"705f5478-6874-464b-9510-758a431adc27","name":"all_cnaes","alwaysOutputData":true},{"parameters":{"workflowId":{"__rl":true,"value":"5RAAO9O35SiHZKx6","mode":"list","cachedResultUrl":"/workflow/5RAAO9O35SiHZKx6","cachedResultName":"Busca-Ampla copy"},"workflowInputs":{"mappingMode":"defineBelow","value":{"_cnaes":"={{ $('filtros_supabase').item.json._cnaes }}","_uf_filtro":"={{ $('filtros_supabase').item.json._uf_filtro }}","_data_limite":"={{ $('filtros_supabase').item.json._data_limite }}","_termos":"={{ $('filtros_supabase').item.json._termos }}","_porte_empresa":"={{ $('filtros_supabase').item.json._porte_empresa }}","_natureza_juridica":"={{ $('filtros_supabase').item.json._natureza_juridica }}","_codigo_municipio":"={{ $('filtros_supabase').item.json._codigo_municipio }}","escopo_segmento":"={{ $('filtros_supabase').item.json.escopo_segmento }}","tipo_busca":"={{ $('filtros_supabase').item.json.tipo_busca }}","id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}","n_cnaes_buscados":"={{ $('filtros_supabase').item.json.n_cnaes_buscados }}"},"matchingColumns":[],"schema":[{"id":"_cnaes","displayName":"_cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_uf_filtro","displayName":"_uf_filtro","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_data_limite","displayName":"_data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"_termos","displayName":"_termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_porte_empresa","displayName":"_porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_natureza_juridica","displayName":"_natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_codigo_municipio","displayName":"_codigo_municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"escopo_segmento","displayName":"escopo_segmento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipo_busca","displayName":"tipo_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"id_consulta","displayName":"id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"n_cnaes_buscados","displayName":"n_cnaes_buscados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-1520,848],"id":"0f044f25-f7f6-480f-97b2-af2a8fae986d","name":"sub_busca_ampla"},{"parameters":{"content":"## Banco de dados:\n- Busca Empresas com site.","height":256,"width":272,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3120,720],"id":"18e8d569-95bd-4418-92b8-6a6e10e58efe","name":"Sticky Note21"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"982024bc-7c66-4c36-86f3-3937d5310db7","leftValue":"={{ $json.isEmpty() }}","rightValue":"={{ true }}","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2800,816],"id":"b1aa1fda-ab95-40a7-ab46-9f074d280109","name":"AchouAlgum?"},{"parameters":{"content":"## Banco de dados:\n- Busca outras Empresas com site que tenham cnaes presentes na lista.","height":320,"width":448,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-784,336],"id":"f870e364-dea0-40d5-b973-0cd4be44bf6c","name":"Sticky Note22"},{"parameters":{"content":"## Processamento:\n- Lista os cnaes das empresas achadas\n- Busca mais empresas que possuam esses cnaes.\n- Filtra apenas as que tenham resumo.","height":384,"width":1120,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1248,288],"id":"5206f4f7-2a89-495b-8735-1abfc2e2a137","name":"Sticky Note25"},{"parameters":{"content":"## Processamento:\n- Itera pelas empresas encontradas.\n- Gera análises sobre a compatibilidade das empresas para o escopo atual.\n- Gera uma nota de compatibilidade.\n-- Se a nota for 30+ insere no banco e mostra no front.","height":592,"width":688,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[160,96],"id":"0b2c6aed-a42d-4d82-97cb-0ede9ad363e8","name":"Sticky Note26"},{"parameters":{"content":"## Processamento:\n- Caso não encontre empresas com site, inicia uma busca mais ampla.\n- Varia a busca com base no tipo de consulta","height":496,"width":400,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1664,512],"id":"87abd676-51fd-474d-b9ec-380d818770b9","name":"Sticky Note28"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8999803c-322a-42ea-825d-6c946bd6feba","leftValue":"={{ $('filtros_supabase').item.json.tipo_busca }}","rightValue":"especifica","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1520,688],"id":"b2b2cf52-ce24-42a1-9e5a-f0cfb5cdd513","name":"tipo_de_consulta"},{"parameters":{"workflowInputs":{"values":[{"name":"_cnaes","type":"array"},{"name":"_uf_filtro","type":"array"},{"name":"_data_limite"},{"name":"_termos","type":"array"},{"name":"_porte_empresa","type":"array"},{"name":"_natureza_juridica","type":"array"},{"name":"_codigo_municipio","type":"array"},{"name":"escopo_segmento"},{"name":"tipo_busca"},{"name":"consulta_id"},{"name":"n_cnaes_buscados"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-3488,816],"id":"a2d872b7-4805-43c0-b161-3357e3989645","name":"filtros_supabase"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_filtrados_avancado_com_site($1, $2, $3, $4, $5, $6, $7, $8, $9);\n","options":{"connectionTimeout":500,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n  $('filtros_supabase').first().json._data_limite,\n  (typeof $('filtros_supabase').first().json._termos === 'string') ? JSON.parse($('filtros_supabase').first().json._termos) : $('filtros_supabase').first().json._termos,\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio\n,200,$('filtros_supabase').item.json.n_cnaes_buscados]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3040,816],"id":"f3b54029-d9ef-45e3-a4dd-60851297566c","name":"busca_filtro_site","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_filtrados_avancado_com_site($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":500,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n  $('filtros_supabase').first().json._data_limite,\n  (typeof $('filtros_supabase').first().json._termos === 'string') ? JSON.parse($('filtros_supabase').first().json._termos) : $('filtros_supabase').first().json._termos,\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio\n,200]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-496,480],"id":"da3801ad-46c2-4a78-8f1a-08d3af2d7ddd","name":"busca_filtro_site1","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"url":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/processa-empresa-copy","sendBody":true,"bodyParameters":{"parameters":[{"name":"data","value":"={{ $json.data }}"},{"name":"filtro_supabase","value":"={{ $('filtros_supabase').item.json.escopo_segmento }}"},{"name":"consulta_id","value":"={{ $('filtros_supabase').item.json.consulta_id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,480],"id":"3eb8a87d-a8f2-4919-82d6-248978753dda","name":"processa_empresa_sub","onError":"continueRegularOutput"},{"parameters":{"batchSize":10,"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[224,464],"id":"39071447-8bd2-4c30-aba7-3860cf394619","name":"Loop Over batch 10"},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"todos_codigos_cnae"}]},"fieldsToSplitBy":",","options":{"outputFormat":"singleItem"}},"type":"n8n-nodes-base.summarize","typeVersion":1.1,"position":[-944,480],"id":"f4e2d02d-7edd-4b47-bdeb-aeaa8bc26d95","name":"concatenate_cnaes","alwaysOutputData":true},{"parameters":{"content":"## Observar qual o valor ideal para esse wait.","height":256,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[448,240],"id":"9aac40e5-e4d4-454c-9e21-ba8203f45ac1","name":"Sticky Note1"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_filtrados_avancado_com_site_sem_termos($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n\n  $('filtros_supabase').first().json._data_limite,\n\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ?JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio,\n\n200,\n\n$('filtros_supabase').item.json.n_cnaes_buscados.toNumber()\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2608,880],"id":"5537416b-874a-4e56-953c-1d7742beca98","name":"busca_view_sem_termos","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"982024bc-7c66-4c36-86f3-3937d5310db7","leftValue":"={{ $json.isEmpty() }}","rightValue":"={{ true }}","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2432,880],"id":"a2522131-234b-4ea4-afe7-0062b9daa285","name":"AchouAlgumAgora?"},{"parameters":{"content":"## Tratativa\n- Realiza uma segunda busca sem aplicar termos.","height":336,"width":576},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2832,704],"id":"92e1fa4e-2cfe-4416-9a6f-efe2f6b6a4ad","name":"Sticky Note34"},{"parameters":{"operation":"get","key":"={{ $('filtros_supabase').item.json.consulta_id }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3296,816],"id":"0f0866f0-8aea-4d77-87aa-197089322f7b","name":"get","executeOnce":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"operation":"push","list":"={{ $('filtros_supabase').item.json.consulta_id }}","messageData":"={{ $json.razao_social || $runIndex.toString() }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1808,704],"id":"529513c8-2570-41f1-9301-b5f81c83164e","name":"put","alwaysOutputData":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"content":"## Tratativa\n- Filtra cnpjs que já apareceram em consultas anteriores.\n- Adiciona os cnpjs processados em uma fila.","height":288,"width":560},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2240,576],"id":"b4f289f3-ce7b-41f6-bb64-0d79817f265b","name":"Sticky Note35"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"04588737-d727-48f6-b126-0f5b7441ab45","leftValue":"={{ $('get').item.json.propertyName }}","rightValue":"={{ $('AchouAlgum?').item.json.razao_social || $('AchouAlgumAgora?').item.json.razao_social }}","operator":{"type":"array","operation":"notContains","rightType":"any"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-2208,720],"id":"81b9eea1-75c4-494f-b278-9ee75748d32f","name":"cnpj_ja_usado","alwaysOutputData":true},{"parameters":{"content":"## Tratativa\n- Busca fila com todos os cnpjs já usados nessa consulta","height":256,"width":224},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3360,704],"id":"273ece63-c85b-4704-808f-8753743ee4ab","name":"Sticky Note36"},{"parameters":{"workflowId":{"__rl":true,"value":"5RAAO9O35SiHZKx6","mode":"list","cachedResultUrl":"/workflow/5RAAO9O35SiHZKx6","cachedResultName":"Busca-Ampla copy"},"workflowInputs":{"mappingMode":"defineBelow","value":{"_cnaes":"={{ $('filtros_supabase').item.json._cnaes }}","_uf_filtro":"={{ $('filtros_supabase').item.json._uf_filtro }}","_data_limite":"={{ $('filtros_supabase').item.json._data_limite }}","_termos":"={{ $('filtros_supabase').item.json._termos }}","_porte_empresa":"={{ $('filtros_supabase').item.json._porte_empresa }}","_natureza_juridica":"={{ $('filtros_supabase').item.json._natureza_juridica }}","_codigo_municipio":"={{ $('filtros_supabase').item.json._codigo_municipio }}","escopo_segmento":"={{ $('filtros_supabase').item.json.escopo_segmento }}","tipo_busca":"={{ $('filtros_supabase').item.json.tipo_busca }}","id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}","n_cnaes_buscados":"={{ $('filtros_supabase').item.json.n_cnaes_buscados }}"},"matchingColumns":[],"schema":[{"id":"_cnaes","displayName":"_cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_uf_filtro","displayName":"_uf_filtro","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_data_limite","displayName":"_data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"_termos","displayName":"_termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_porte_empresa","displayName":"_porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_natureza_juridica","displayName":"_natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_codigo_municipio","displayName":"_codigo_municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"escopo_segmento","displayName":"escopo_segmento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipo_busca","displayName":"tipo_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"id_consulta","displayName":"id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"n_cnaes_buscados","displayName":"n_cnaes_buscados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[512,352],"id":"c1910af9-9cb9-4284-a86d-2ed48b5ddfd6","name":"sub_busca_ampla1","executeOnce":true},{"parameters":{"content":"## Empresas sem resumo","height":256,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-96,704],"id":"49e175a0-16dd-4124-98a6-16ebe9286f91","name":"Sticky Note3"},{"parameters":{"workflowId":{"__rl":true,"value":"8wGQEu6ASkKw1oMS","mode":"list","cachedResultUrl":"/workflow/8wGQEu6ASkKw1oMS","cachedResultName":"Envia e-mail"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data.email_fornecedor":"={{ $json.correio_eletronico }}","data.motivo":"=sem_resumo","data.cnpj_basico":"={{ $json.cnpj_basico }}","data.cnpj_dv":"={{ $json.cnpj_dv }}","data.cnpj_ordem":"={{ $json.cnpj_ordem }}","data.id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}"},"matchingColumns":[],"schema":[{"id":"data.email_fornecedor","displayName":"data.email_fornecedor","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.motivo","displayName":"data.motivo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_basico","displayName":"data.cnpj_basico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_dv","displayName":"data.cnpj_dv","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_ordem","displayName":"data.cnpj_ordem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.id_consulta","displayName":"data.id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-32,800],"id":"9a0f901f-69ad-4a63-900b-f73d2ef56fa8","name":"Call 'Envia e-mail'1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5a36694f-4a06-4db4-8ba9-0da6d42ffded","leftValue":"={{ $json.resumo_empresa }}","rightValue":"nao_encontrado","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-304,480],"id":"47f0c4f8-286b-4c84-8a9c-5eca285cd64f","name":"tem_resumo?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1313ca54-9699-477f-a14a-f95ea56a3b1e","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2016,720],"id":"e70c5efd-59ff-472e-9061-3acc96f87958","name":"vazio?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"441b89cc-cf3f-45c3-8f42-169665aae35c","leftValue":"={{ $json }}","rightValue":"","operator":{"type":"object","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-64,464],"id":"c6d3e342-0d03-4524-8658-e557559e0a8e","name":"If"}],"connections":{"Aggregate":{"main":[[{"node":"processa_empresa_sub","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"concatenate_cnaes","type":"main","index":0}]]},"all_cnaes":{"main":[[{"node":"busca_filtro_site1","type":"main","index":0}]]},"AchouAlgum?":{"main":[[{"node":"cnpj_ja_usado","type":"main","index":0}],[{"node":"busca_view_sem_termos","type":"main","index":0}]]},"tipo_de_consulta":{"main":[[{"node":"Split Out","type":"main","index":0}],[{"node":"tem_resumo?","type":"main","index":0}]]},"filtros_supabase":{"main":[[{"node":"get","type":"main","index":0}]]},"busca_filtro_site":{"main":[[{"node":"AchouAlgum?","type":"main","index":0}]]},"busca_filtro_site1":{"main":[[{"node":"tem_resumo?","type":"main","index":0}]]},"processa_empresa_sub":{"main":[[{"node":"Loop Over batch 10","type":"main","index":0}]]},"Loop Over batch 10":{"main":[[{"node":"sub_busca_ampla1","type":"main","index":0}],[{"node":"Aggregate","type":"main","index":0}]]},"concatenate_cnaes":{"main":[[{"node":"all_cnaes","type":"main","index":0}]]},"busca_view_sem_termos":{"main":[[{"node":"AchouAlgumAgora?","type":"main","index":0}]]},"AchouAlgumAgora?":{"main":[[{"node":"cnpj_ja_usado","type":"main","index":0}],[{"node":"sub_busca_ampla","type":"main","index":0}]]},"get":{"main":[[{"node":"busca_filtro_site","type":"main","index":0}]]},"put":{"main":[[{"node":"tipo_de_consulta","type":"main","index":0}]]},"cnpj_ja_usado":{"main":[[{"node":"vazio?","type":"main","index":0}]]},"tem_resumo?":{"main":[[{"node":"If","type":"main","index":0}],[{"node":"Call 'Envia e-mail'1","type":"main","index":0}]]},"vazio?":{"main":[[{"node":"sub_busca_ampla","type":"main","index":0}],[{"node":"put","type":"main","index":0}]]},"If":{"main":[[{"node":"sub_busca_ampla1","type":"main","index":0}],[{"node":"Loop Over batch 10","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timeSavedMode":"fixed","callerPolicy":"workflowsFromSameOwner","availableInMCP":false,"errorWorkflow":"KFeveZkBafvIC5xECfmBs"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"filtros_supabase":[{"json":{"_cnaes":["2813500","3314703","4329105","4330405","2091600","2073800","4330401"],"_uf_filtro":[],"_data_limite":"20210101\n","_termos":["ved","fence","cerc","port","grade","cerca","muro","barreir","diviso","seguranc","perim","enclausur","isolac","limite","protecc","vedac","fencing","garde","barri","enclo"],"_porte_empresa":["00","01","05","03"],"_natureza_juridica":["2062"],"_codigo_municipio":["1389","1373","1585","1455","1247","0991","1495","3197","1319","1251","1253","1549","1837","1267"],"escopo_segmento":"vedações, vedações","tipo_busca":"mista","consulta_id":"8f43f8e4-20e4-472c-96db-8261745fecfa","n_cnaes_buscados":"2"},"pairedItem":{"item":0}}]},"versionId":"64128c6f-4028-4948-a802-80b76a8d36f8","activeVersionId":"64128c6f-4028-4948-a802-80b76a8d36f8","triggerCount":0,"shared":[{"updatedAt":"2025-10-14T19:47:50.582Z","createdAt":"2025-10-14T19:47:50.582Z","role":"workflow:owner","workflowId":"fjbWmn7b1HzCg5tE","projectId":"jk0yZKautC5L7CBp"}],"activeVersion":{"updatedAt":"2026-02-04T19:17:24.378Z","createdAt":"2026-02-04T19:17:21.769Z","versionId":"64128c6f-4028-4948-a802-80b76a8d36f8","workflowId":"fjbWmn7b1HzCg5tE","nodes":[{"parameters":{"aggregate":"aggregateAllItemData","include":"specifiedFields","fieldsToInclude":"razao_social, nome_fantasia, resumo_empresa, clientes, segmentos_industriais, tipo_fornecedor, especialidades, exemplo_servico, categorias_materais, cnpj_basico, cnpj_ordem, telefone, instagram, email, site","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[416,480],"id":"89d0e679-a668-4f9e-a8a3-54aeae44d179","name":"Aggregate","alwaysOutputData":true},{"parameters":{"fieldToSplitOut":"todos_codigos_cnae","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-1168,480],"id":"03df24d4-1f4a-46bb-b651-7d0d19e495e1","name":"Split Out","alwaysOutputData":true},{"parameters":{"assignments":{"assignments":[{"id":"cd49782f-f1cd-478e-b6b1-4297ab91adad","name":"concatenated_todos_codigos_cnae","value":"={{ $json.concatenated_todos_codigos_cnae.replaceAll(\" \", \"\").split(\",\").unique().sort()}}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-720,480],"id":"705f5478-6874-464b-9510-758a431adc27","name":"all_cnaes","alwaysOutputData":true},{"parameters":{"workflowId":{"__rl":true,"value":"5RAAO9O35SiHZKx6","mode":"list","cachedResultUrl":"/workflow/5RAAO9O35SiHZKx6","cachedResultName":"Busca-Ampla copy"},"workflowInputs":{"mappingMode":"defineBelow","value":{"_cnaes":"={{ $('filtros_supabase').item.json._cnaes }}","_uf_filtro":"={{ $('filtros_supabase').item.json._uf_filtro }}","_data_limite":"={{ $('filtros_supabase').item.json._data_limite }}","_termos":"={{ $('filtros_supabase').item.json._termos }}","_porte_empresa":"={{ $('filtros_supabase').item.json._porte_empresa }}","_natureza_juridica":"={{ $('filtros_supabase').item.json._natureza_juridica }}","_codigo_municipio":"={{ $('filtros_supabase').item.json._codigo_municipio }}","escopo_segmento":"={{ $('filtros_supabase').item.json.escopo_segmento }}","tipo_busca":"={{ $('filtros_supabase').item.json.tipo_busca }}","id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}","n_cnaes_buscados":"={{ $('filtros_supabase').item.json.n_cnaes_buscados }}"},"matchingColumns":[],"schema":[{"id":"_cnaes","displayName":"_cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_uf_filtro","displayName":"_uf_filtro","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_data_limite","displayName":"_data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"_termos","displayName":"_termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_porte_empresa","displayName":"_porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_natureza_juridica","displayName":"_natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_codigo_municipio","displayName":"_codigo_municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"escopo_segmento","displayName":"escopo_segmento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipo_busca","displayName":"tipo_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"id_consulta","displayName":"id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"n_cnaes_buscados","displayName":"n_cnaes_buscados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-1520,848],"id":"0f044f25-f7f6-480f-97b2-af2a8fae986d","name":"sub_busca_ampla"},{"parameters":{"content":"## Banco de dados:\n- Busca Empresas com site.","height":256,"width":272,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3120,720],"id":"18e8d569-95bd-4418-92b8-6a6e10e58efe","name":"Sticky Note21"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"982024bc-7c66-4c36-86f3-3937d5310db7","leftValue":"={{ $json.isEmpty() }}","rightValue":"={{ true }}","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2800,816],"id":"b1aa1fda-ab95-40a7-ab46-9f074d280109","name":"AchouAlgum?"},{"parameters":{"content":"## Banco de dados:\n- Busca outras Empresas com site que tenham cnaes presentes na lista.","height":320,"width":448,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-784,336],"id":"f870e364-dea0-40d5-b973-0cd4be44bf6c","name":"Sticky Note22"},{"parameters":{"content":"## Processamento:\n- Lista os cnaes das empresas achadas\n- Busca mais empresas que possuam esses cnaes.\n- Filtra apenas as que tenham resumo.","height":384,"width":1120,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1248,288],"id":"5206f4f7-2a89-495b-8735-1abfc2e2a137","name":"Sticky Note25"},{"parameters":{"content":"## Processamento:\n- Itera pelas empresas encontradas.\n- Gera análises sobre a compatibilidade das empresas para o escopo atual.\n- Gera uma nota de compatibilidade.\n-- Se a nota for 30+ insere no banco e mostra no front.","height":592,"width":688,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[160,96],"id":"0b2c6aed-a42d-4d82-97cb-0ede9ad363e8","name":"Sticky Note26"},{"parameters":{"content":"## Processamento:\n- Caso não encontre empresas com site, inicia uma busca mais ampla.\n- Varia a busca com base no tipo de consulta","height":496,"width":400,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1664,512],"id":"87abd676-51fd-474d-b9ec-380d818770b9","name":"Sticky Note28"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8999803c-322a-42ea-825d-6c946bd6feba","leftValue":"={{ $('filtros_supabase').item.json.tipo_busca }}","rightValue":"especifica","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1520,688],"id":"b2b2cf52-ce24-42a1-9e5a-f0cfb5cdd513","name":"tipo_de_consulta"},{"parameters":{"workflowInputs":{"values":[{"name":"_cnaes","type":"array"},{"name":"_uf_filtro","type":"array"},{"name":"_data_limite"},{"name":"_termos","type":"array"},{"name":"_porte_empresa","type":"array"},{"name":"_natureza_juridica","type":"array"},{"name":"_codigo_municipio","type":"array"},{"name":"escopo_segmento"},{"name":"tipo_busca"},{"name":"consulta_id"},{"name":"n_cnaes_buscados"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-3488,816],"id":"a2d872b7-4805-43c0-b161-3357e3989645","name":"filtros_supabase"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_filtrados_avancado_com_site($1, $2, $3, $4, $5, $6, $7, $8, $9);\n","options":{"connectionTimeout":500,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n  $('filtros_supabase').first().json._data_limite,\n  (typeof $('filtros_supabase').first().json._termos === 'string') ? JSON.parse($('filtros_supabase').first().json._termos) : $('filtros_supabase').first().json._termos,\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio\n,200,$('filtros_supabase').item.json.n_cnaes_buscados]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3040,816],"id":"f3b54029-d9ef-45e3-a4dd-60851297566c","name":"busca_filtro_site","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_filtrados_avancado_com_site($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":500,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n  $('filtros_supabase').first().json._data_limite,\n  (typeof $('filtros_supabase').first().json._termos === 'string') ? JSON.parse($('filtros_supabase').first().json._termos) : $('filtros_supabase').first().json._termos,\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio\n,200]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-496,480],"id":"da3801ad-46c2-4a78-8f1a-08d3af2d7ddd","name":"busca_filtro_site1","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"url":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/processa-empresa-copy","sendBody":true,"bodyParameters":{"parameters":[{"name":"data","value":"={{ $json.data }}"},{"name":"filtro_supabase","value":"={{ $('filtros_supabase').item.json.escopo_segmento }}"},{"name":"consulta_id","value":"={{ $('filtros_supabase').item.json.consulta_id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,480],"id":"3eb8a87d-a8f2-4919-82d6-248978753dda","name":"processa_empresa_sub","onError":"continueRegularOutput"},{"parameters":{"batchSize":10,"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[224,464],"id":"39071447-8bd2-4c30-aba7-3860cf394619","name":"Loop Over batch 10"},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"todos_codigos_cnae"}]},"fieldsToSplitBy":",","options":{"outputFormat":"singleItem"}},"type":"n8n-nodes-base.summarize","typeVersion":1.1,"position":[-944,480],"id":"f4e2d02d-7edd-4b47-bdeb-aeaa8bc26d95","name":"concatenate_cnaes","alwaysOutputData":true},{"parameters":{"content":"## Observar qual o valor ideal para esse wait.","height":256,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[448,240],"id":"9aac40e5-e4d4-454c-9e21-ba8203f45ac1","name":"Sticky Note1"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_filtrados_avancado_com_site_sem_termos($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n\n  $('filtros_supabase').first().json._data_limite,\n\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ?JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio,\n\n200,\n\n$('filtros_supabase').item.json.n_cnaes_buscados.toNumber()\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2608,880],"id":"5537416b-874a-4e56-953c-1d7742beca98","name":"busca_view_sem_termos","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"982024bc-7c66-4c36-86f3-3937d5310db7","leftValue":"={{ $json.isEmpty() }}","rightValue":"={{ true }}","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2432,880],"id":"a2522131-234b-4ea4-afe7-0062b9daa285","name":"AchouAlgumAgora?"},{"parameters":{"content":"## Tratativa\n- Realiza uma segunda busca sem aplicar termos.","height":336,"width":576},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2832,704],"id":"92e1fa4e-2cfe-4416-9a6f-efe2f6b6a4ad","name":"Sticky Note34"},{"parameters":{"operation":"get","key":"={{ $('filtros_supabase').item.json.consulta_id }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3296,816],"id":"0f0866f0-8aea-4d77-87aa-197089322f7b","name":"get","executeOnce":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"operation":"push","list":"={{ $('filtros_supabase').item.json.consulta_id }}","messageData":"={{ $json.razao_social || $runIndex.toString() }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1808,704],"id":"529513c8-2570-41f1-9301-b5f81c83164e","name":"put","alwaysOutputData":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"content":"## Tratativa\n- Filtra cnpjs que já apareceram em consultas anteriores.\n- Adiciona os cnpjs processados em uma fila.","height":288,"width":560},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2240,576],"id":"b4f289f3-ce7b-41f6-bb64-0d79817f265b","name":"Sticky Note35"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"04588737-d727-48f6-b126-0f5b7441ab45","leftValue":"={{ $('get').item.json.propertyName }}","rightValue":"={{ $('AchouAlgum?').item.json.razao_social || $('AchouAlgumAgora?').item.json.razao_social }}","operator":{"type":"array","operation":"notContains","rightType":"any"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-2208,720],"id":"81b9eea1-75c4-494f-b278-9ee75748d32f","name":"cnpj_ja_usado","alwaysOutputData":true},{"parameters":{"content":"## Tratativa\n- Busca fila com todos os cnpjs já usados nessa consulta","height":256,"width":224},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3360,704],"id":"273ece63-c85b-4704-808f-8753743ee4ab","name":"Sticky Note36"},{"parameters":{"workflowId":{"__rl":true,"value":"5RAAO9O35SiHZKx6","mode":"list","cachedResultUrl":"/workflow/5RAAO9O35SiHZKx6","cachedResultName":"Busca-Ampla copy"},"workflowInputs":{"mappingMode":"defineBelow","value":{"_cnaes":"={{ $('filtros_supabase').item.json._cnaes }}","_uf_filtro":"={{ $('filtros_supabase').item.json._uf_filtro }}","_data_limite":"={{ $('filtros_supabase').item.json._data_limite }}","_termos":"={{ $('filtros_supabase').item.json._termos }}","_porte_empresa":"={{ $('filtros_supabase').item.json._porte_empresa }}","_natureza_juridica":"={{ $('filtros_supabase').item.json._natureza_juridica }}","_codigo_municipio":"={{ $('filtros_supabase').item.json._codigo_municipio }}","escopo_segmento":"={{ $('filtros_supabase').item.json.escopo_segmento }}","tipo_busca":"={{ $('filtros_supabase').item.json.tipo_busca }}","id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}","n_cnaes_buscados":"={{ $('filtros_supabase').item.json.n_cnaes_buscados }}"},"matchingColumns":[],"schema":[{"id":"_cnaes","displayName":"_cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_uf_filtro","displayName":"_uf_filtro","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_data_limite","displayName":"_data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"_termos","displayName":"_termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_porte_empresa","displayName":"_porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_natureza_juridica","displayName":"_natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_codigo_municipio","displayName":"_codigo_municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"escopo_segmento","displayName":"escopo_segmento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipo_busca","displayName":"tipo_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"id_consulta","displayName":"id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"n_cnaes_buscados","displayName":"n_cnaes_buscados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[512,352],"id":"c1910af9-9cb9-4284-a86d-2ed48b5ddfd6","name":"sub_busca_ampla1","executeOnce":true},{"parameters":{"content":"## Empresas sem resumo","height":256,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-96,704],"id":"49e175a0-16dd-4124-98a6-16ebe9286f91","name":"Sticky Note3"},{"parameters":{"workflowId":{"__rl":true,"value":"8wGQEu6ASkKw1oMS","mode":"list","cachedResultUrl":"/workflow/8wGQEu6ASkKw1oMS","cachedResultName":"Envia e-mail"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data.email_fornecedor":"={{ $json.correio_eletronico }}","data.motivo":"=sem_resumo","data.cnpj_basico":"={{ $json.cnpj_basico }}","data.cnpj_dv":"={{ $json.cnpj_dv }}","data.cnpj_ordem":"={{ $json.cnpj_ordem }}","data.id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}"},"matchingColumns":[],"schema":[{"id":"data.email_fornecedor","displayName":"data.email_fornecedor","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.motivo","displayName":"data.motivo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_basico","displayName":"data.cnpj_basico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_dv","displayName":"data.cnpj_dv","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_ordem","displayName":"data.cnpj_ordem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.id_consulta","displayName":"data.id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-32,800],"id":"9a0f901f-69ad-4a63-900b-f73d2ef56fa8","name":"Call 'Envia e-mail'1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5a36694f-4a06-4db4-8ba9-0da6d42ffded","leftValue":"={{ $json.resumo_empresa }}","rightValue":"nao_encontrado","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-304,480],"id":"47f0c4f8-286b-4c84-8a9c-5eca285cd64f","name":"tem_resumo?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1313ca54-9699-477f-a14a-f95ea56a3b1e","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2016,720],"id":"e70c5efd-59ff-472e-9061-3acc96f87958","name":"vazio?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"441b89cc-cf3f-45c3-8f42-169665aae35c","leftValue":"={{ $json }}","rightValue":"","operator":{"type":"object","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-64,464],"id":"c6d3e342-0d03-4524-8658-e557559e0a8e","name":"If"}],"connections":{"Aggregate":{"main":[[{"node":"processa_empresa_sub","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"concatenate_cnaes","type":"main","index":0}]]},"all_cnaes":{"main":[[{"node":"busca_filtro_site1","type":"main","index":0}]]},"AchouAlgum?":{"main":[[{"node":"cnpj_ja_usado","type":"main","index":0}],[{"node":"busca_view_sem_termos","type":"main","index":0}]]},"tipo_de_consulta":{"main":[[{"node":"Split Out","type":"main","index":0}],[{"node":"tem_resumo?","type":"main","index":0}]]},"filtros_supabase":{"main":[[{"node":"get","type":"main","index":0}]]},"busca_filtro_site":{"main":[[{"node":"AchouAlgum?","type":"main","index":0}]]},"busca_filtro_site1":{"main":[[{"node":"tem_resumo?","type":"main","index":0}]]},"processa_empresa_sub":{"main":[[{"node":"Loop Over batch 10","type":"main","index":0}]]},"Loop Over batch 10":{"main":[[{"node":"sub_busca_ampla1","type":"main","index":0}],[{"node":"Aggregate","type":"main","index":0}]]},"concatenate_cnaes":{"main":[[{"node":"all_cnaes","type":"main","index":0}]]},"busca_view_sem_termos":{"main":[[{"node":"AchouAlgumAgora?","type":"main","index":0}]]},"AchouAlgumAgora?":{"main":[[{"node":"cnpj_ja_usado","type":"main","index":0}],[{"node":"sub_busca_ampla","type":"main","index":0}]]},"get":{"main":[[{"node":"busca_filtro_site","type":"main","index":0}]]},"put":{"main":[[{"node":"tipo_de_consulta","type":"main","index":0}]]},"cnpj_ja_usado":{"main":[[{"node":"vazio?","type":"main","index":0}]]},"tem_resumo?":{"main":[[{"node":"If","type":"main","index":0}],[{"node":"Call 'Envia e-mail'1","type":"main","index":0}]]},"vazio?":{"main":[[{"node":"sub_busca_ampla","type":"main","index":0}],[{"node":"put","type":"main","index":0}]]},"If":{"main":[[{"node":"sub_busca_ampla1","type":"main","index":0}],[{"node":"Loop Over batch 10","type":"main","index":0}]]}},"authors":"ABC  advise","name":"Version 64128c6f","description":"","autosaved":false},"tags":[{"updatedAt":"2025-10-02T13:53:47.318Z","createdAt":"2025-10-02T13:53:47.318Z","id":"El7C2Bp08WUbNazn","name":"Subworkflow"},{"updatedAt":"2025-10-14T19:47:01.394Z","createdAt":"2025-10-14T19:47:01.394Z","id":"cuEnFeSTWYUSoPc7","name":"test"}]}