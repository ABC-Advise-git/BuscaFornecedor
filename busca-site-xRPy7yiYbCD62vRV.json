{"updatedAt":"2025-12-04T18:53:21.917Z","createdAt":"2025-10-02T13:44:57.914Z","id":"xRPy7yiYbCD62vRV","name":"Busca-Site","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowInputs":{"values":[{"name":"_cnaes","type":"array"},{"name":"_uf_filtro","type":"array"},{"name":"_data_limite"},{"name":"_termos","type":"array"},{"name":"_porte_empresa","type":"array"},{"name":"_natureza_juridica","type":"array"},{"name":"_codigo_municipio","type":"array"},{"name":"escopo_segmento"},{"name":"tipo_busca"},{"name":"consulta_id"},{"name":"n_cnaes_buscados"},{"name":"range_busca","type":"number"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-3760,1456],"id":"45dc7c16-7654-4f92-bbba-129336932a34","name":"filtros_supabase"},{"parameters":{"amount":60},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[688,976],"id":"e591740a-8ec5-46d3-a4ea-1f4a94c601f9","name":"wait_2min","webhookId":"c8dd8b69-328f-423d-836d-869c3c17b892"},{"parameters":{"workflowId":{"__rl":true,"value":"Sd487u8Pqgd9wfPU","mode":"list","cachedResultUrl":"/workflow/Sd487u8Pqgd9wfPU","cachedResultName":"Busca-Ampla"},"workflowInputs":{"mappingMode":"defineBelow","value":{"_cnaes":"={{ $('filtros_supabase').item.json._cnaes }}","_uf_filtro":"={{ $('filtros_supabase').item.json._uf_filtro }}","_data_limite":"={{ $('filtros_supabase').item.json._data_limite }}","_termos":"={{ $('filtros_supabase').item.json._termos }}","_porte_empresa":"={{ $('filtros_supabase').item.json._porte_empresa }}","_natureza_juridica":"={{ $('filtros_supabase').item.json._natureza_juridica }}","_codigo_municipio":"={{ $('filtros_supabase').item.json._codigo_municipio }}","escopo_segmento":"={{ $('filtros_supabase').item.json.escopo_segmento }}","tipo_busca":"={{ $('filtros_supabase').item.json.tipo_busca }}","id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}","n_cnaes_buscados":"={{ $('filtros_supabase').item.json.n_cnaes_buscados }}","range_busca":"={{ $('filtros_supabase').item.json.range_busca }}"},"matchingColumns":[],"schema":[{"id":"_cnaes","displayName":"_cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_uf_filtro","displayName":"_uf_filtro","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_data_limite","displayName":"_data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"_termos","displayName":"_termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_porte_empresa","displayName":"_porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_natureza_juridica","displayName":"_natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_codigo_municipio","displayName":"_codigo_municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"escopo_segmento","displayName":"escopo_segmento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipo_busca","displayName":"tipo_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"id_consulta","displayName":"id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"n_cnaes_buscados","displayName":"n_cnaes_buscados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"range_busca","displayName":"range_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1712,1072],"id":"e20eb89e-0e65-4c5c-b250-ee185611c489","name":"sub_busca_ampla1"},{"parameters":{"content":"## Empresas sem resumo","height":256,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1024,1248],"id":"fd64aab6-593c-4ed1-aa75-42fa145822ee","name":"Sticky Note3"},{"parameters":{"workflowId":{"__rl":true,"value":"8wGQEu6ASkKw1oMS","mode":"list","cachedResultUrl":"/workflow/8wGQEu6ASkKw1oMS","cachedResultName":"Envia e-mail"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data.email_fornecedor":"={{ $json.correio_eletronico }}","data.motivo":"=sem_resumo","data.cnpj_basico":"={{ $json.cnpj_basico }}","data.cnpj_dv":"={{ $json.cnpj_dv }}","data.cnpj_ordem":"={{ $json.cnpj_ordem }}","data.id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}"},"matchingColumns":[],"schema":[{"id":"data.email_fornecedor","displayName":"data.email_fornecedor","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.motivo","displayName":"data.motivo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_basico","displayName":"data.cnpj_basico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_dv","displayName":"data.cnpj_dv","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_ordem","displayName":"data.cnpj_ordem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.id_consulta","displayName":"data.id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1088,1344],"id":"ead91172-4881-4682-b1d5-65acf1eb069d","name":"Call 'Envia e-mail'1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5a36694f-4a06-4db4-8ba9-0da6d42ffded","leftValue":"={{ $json.resumo_empresa }}","rightValue":"nao_encontrado","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-16,1120],"id":"4d91ff84-3d94-44b6-9cd9-696a88a56d52","name":"tem_resumo?","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1313ca54-9699-477f-a14a-f95ea56a3b1e","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2288,1360],"id":"c82ca8c2-0ac8-40fd-9373-c36eb9930da3","name":"vazio?"},{"parameters":{"aggregate":"aggregateAllItemData","include":"specifiedFields","fieldsToInclude":"razao_social, nome_fantasia, resumo_empresa, clientes, segmentos_industriais, tipo_fornecedor, especialidades, exemplo_servico, categorias_materais, cnpj_basico, cnpj_ordem, telefone, instagram, email, site","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[576,1088],"id":"842b5d30-092d-48ef-9461-2f307183221a","name":"Aggregate1","alwaysOutputData":true},{"parameters":{"fieldToSplitOut":"todos_codigos_cnae","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-1440,1120],"id":"a18ed718-2e80-4586-a382-09cecc78df24","name":"Split Out2","alwaysOutputData":true},{"parameters":{"assignments":{"assignments":[{"id":"cd49782f-f1cd-478e-b6b1-4297ab91adad","name":"concatenated_todos_codigos_cnae","value":"={{ $json.concatenated_todos_codigos_cnae.replaceAll(\" \", \"\").split(\",\").unique().sort()}}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-992,1120],"id":"b83affa6-c969-40ef-8d11-483f191e6dfe","name":"all_cnaes1","alwaysOutputData":true},{"parameters":{"workflowId":{"__rl":true,"value":"Sd487u8Pqgd9wfPU","mode":"list","cachedResultUrl":"/workflow/Sd487u8Pqgd9wfPU","cachedResultName":"Busca-Ampla"},"workflowInputs":{"mappingMode":"defineBelow","value":{"_cnaes":"={{ $('filtros_supabase').item.json._cnaes }}","_uf_filtro":"={{ $('filtros_supabase').item.json._uf_filtro }}","_data_limite":"={{ $('filtros_supabase').item.json._data_limite }}","_termos":"={{ $('filtros_supabase').item.json._termos }}","_porte_empresa":"={{ $('filtros_supabase').item.json._porte_empresa }}","_natureza_juridica":"={{ $('filtros_supabase').item.json._natureza_juridica }}","_codigo_municipio":"={{ $('filtros_supabase').item.json._codigo_municipio }}","escopo_segmento":"={{ $('filtros_supabase').item.json.escopo_segmento }}","tipo_busca":"={{ $('filtros_supabase').item.json.tipo_busca }}","id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}","n_cnaes_buscados":"={{ $('filtros_supabase').item.json.n_cnaes_buscados }}","range_busca":"={{ $('filtros_supabase').item.json.range_busca }}"},"matchingColumns":[],"schema":[{"id":"_cnaes","displayName":"_cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_uf_filtro","displayName":"_uf_filtro","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_data_limite","displayName":"_data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"_termos","displayName":"_termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_porte_empresa","displayName":"_porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_natureza_juridica","displayName":"_natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_codigo_municipio","displayName":"_codigo_municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"escopo_segmento","displayName":"escopo_segmento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipo_busca","displayName":"tipo_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"id_consulta","displayName":"id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"n_cnaes_buscados","displayName":"n_cnaes_buscados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"range_busca","displayName":"range_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-1792,1488],"id":"cbe27443-13d4-42fa-ad56-92bfbd753d15","name":"sub_busca_ampla2"},{"parameters":{"content":"## Banco de dados:\n- Busca Empresas com site.","height":256,"width":272,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3392,1360],"id":"1a65c5eb-40c8-4ae0-941c-1624f43ddec6","name":"Sticky Note23"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"982024bc-7c66-4c36-86f3-3937d5310db7","leftValue":"={{ $json.isEmpty() }}","rightValue":"={{ true }}","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3072,1456],"id":"d5302a0e-f61f-4f6e-a452-4c6a110f9a20","name":"AchouAlgum?3"},{"parameters":{"content":"## Banco de dados:\n- Busca outras Empresas com site que tenham cnaes presentes na lista.","height":320,"width":448,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1056,976],"id":"fd58aee2-32a4-4aa3-8bd5-ee5663a1e240","name":"Sticky Note24"},{"parameters":{"content":"## Processamento:\n- Lista os cnaes das empresas achadas\n- Busca mais empresas que possuam esses cnaes.\n- Filtra apenas as que tenham resumo.","height":400,"width":1824,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1520,912],"id":"69473f23-18a5-4bef-b2b0-d2a09209909c","name":"Sticky Note27"},{"parameters":{"content":"## Processamento:\n- Itera pelas empresas encontradas.\n- Gera análises sobre a compatibilidade das empresas para o escopo atual.\n- Gera uma nota de compatibilidade.\n-- Se a nota for 30+ insere no banco e mostra no front.","height":592,"width":688,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[320,704],"id":"f363e861-c120-42f5-9ea1-115283aba645","name":"Sticky Note29"},{"parameters":{"content":"## Processamento:\n- Caso não encontre empresas com site, inicia uma busca mais ampla.\n- Varia a busca com base no tipo de consulta","height":496,"width":400,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1936,1152],"id":"4c52a370-3a88-41d4-a225-cafe3a76bb32","name":"Sticky Note30"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8999803c-322a-42ea-825d-6c946bd6feba","leftValue":"={{ $('filtros_supabase').item.json.tipo_busca }}","rightValue":"especifica","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1792,1328],"id":"10358a6c-6994-4c1f-aebe-2dabf3e44538","name":"tipo_de_consulta1"},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"get","tableId":"consultas","filters":{"conditions":[{"keyName":"id","keyValue":"={{ $('filtros_supabase').item.json.consulta_id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[880,976],"id":"f3522282-7c83-4dce-8845-f4e5b8997c21","name":"get_result1","executeOnce":true,"alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"content":"## Regra de Negócio:\n- Caso a consulta já tenha pelo menos 4 resultados 70+, ela é marcada como concluída.\n- Caso contrário, uma busca mais ampla é iniciada.\n\n","height":384,"width":864,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1024,848],"id":"dacdc001-3342-4ce5-a9c5-0f4e37b8d1d3","name":"Sticky Note2"},{"parameters":{"fieldToSplitOut":"resultados","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[1040,976],"id":"783e9921-3801-49ec-aaf5-5ab7f3c3599e","name":"Split Out3","alwaysOutputData":true},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"item.nota"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1360,976],"id":"dd87b76b-38ab-4817-b908-7a068e423b5d","name":"Aggregate3","alwaysOutputData":true},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_filtrados_avancado_com_site($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":500,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n  $('filtros_supabase').first().json._data_limite,\n  (typeof $('filtros_supabase').first().json._termos === 'string') ? JSON.parse($('filtros_supabase').first().json._termos) : $('filtros_supabase').first().json._termos,\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio\n,200]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-768,1120],"id":"8f29a7d5-e637-4db8-9c15-0c0cc26f54bb","name":"busca_filtro_site3","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"batchSize":10,"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[400,1072],"id":"e9f96c68-5467-4b28-ab07-d3a32a1fac25","name":"Loop Over batch "},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"todos_codigos_cnae"}]},"fieldsToSplitBy":",","options":{"outputFormat":"singleItem"}},"type":"n8n-nodes-base.summarize","typeVersion":1.1,"position":[-1216,1120],"id":"02b025a0-0eb8-46c5-937f-9f2b19e145aa","name":"concatenate_cnaes1","alwaysOutputData":true},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"update","tableId":"consultas","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('get_result1').item.json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"concluida"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1696,896],"id":"51b90165-9f0f-4c93-8eeb-631b9066ed15","name":"concluído1","credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"content":"## Observar qual o valor ideal para esse wait.","height":256,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[608,848],"id":"2a7e84cb-6fa2-4a55-909b-c4dc378cb426","name":"Sticky Note4"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"982024bc-7c66-4c36-86f3-3937d5310db7","leftValue":"={{ $json.isEmpty() }}","rightValue":"={{ true }}","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2704,1520],"id":"539cc629-f0a9-48b4-899a-2f80d824e758","name":"AchouAlgumAgora?1"},{"parameters":{"content":"## Tratativa\n- Realiza uma segunda busca sem aplicar termos.","height":336,"width":576},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3104,1344],"id":"63ae609d-ca04-4506-b40b-0db1099436be","name":"Sticky Note37"},{"parameters":{"operation":"get","key":"={{ $('filtros_supabase').item.json.consulta_id }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3568,1456],"id":"d666d37c-2252-4c1e-b827-5d73879287f7","name":"get1","executeOnce":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"operation":"push","list":"={{ $('filtros_supabase').item.json.consulta_id }}","messageData":"={{ $json.razao_social || $runIndex.toString() }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2080,1344],"id":"d0ede2a8-56a7-45a2-a5c4-3969b0f2b323","name":"put1","alwaysOutputData":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"content":"## Tratativa\n- Filtra cnpjs que já apareceram em consultas anteriores.\n- Adiciona os cnpjs processados em uma fila.","height":288,"width":560},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2512,1216],"id":"99b9f246-4f6e-440a-8e14-f6702242dcb2","name":"Sticky Note38"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"04588737-d727-48f6-b126-0f5b7441ab45","leftValue":"={{ $('get1').item.json.propertyName }}","rightValue":"={{ $('AchouAlgum?3').item.json.razao_social }}","operator":{"type":"array","operation":"notContains","rightType":"any"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-2480,1360],"id":"a2d9cc1c-9be0-4c31-a786-1b984c6b6748","name":"cnpj_ja_usado1","alwaysOutputData":true},{"parameters":{"content":"## Tratativa\n- Busca fila com todos os cnpjs já usados nessa consulta","height":256,"width":224},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3632,1344],"id":"10aeed31-8e3d-4197-8898-6976330f88f3","name":"Sticky Note39"},{"parameters":{"url":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/74b8dbdb-2fdd-44b5-a71e-88750862316f","sendBody":true,"bodyParameters":{"parameters":[{"name":"data","value":"={{ $json.data }}"},{"name":"filtro_supabase","value":"={{ $('filtros_supabase').item.json.escopo_segmento }}"},{"name":"consulta_id","value":"={{ $('filtros_supabase').item.json.consulta_id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[768,1088],"id":"f3faa14e-a7f0-4073-9065-0296fda04d28","name":"processa_empresa_sub1","onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3d0a4d93-d2a9-4518-a3e0-432ea2fce1bf","leftValue":"={{ $json }}","rightValue":"","operator":{"type":"object","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[160,992],"id":"d3aeb021-56bf-4246-bbd3-25e1b5cb3931","name":"vazio?1"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-576,1120],"id":"4f43544b-45fe-43ba-be2a-067c0d97852d","name":"Merge"},{"parameters":{"compare":"selectedFields","fieldsToCompare":"cnpj_basico, cnpj_ordem, cnpj_dv","options":{}},"type":"n8n-nodes-base.removeDuplicates","typeVersion":2,"position":[-192,1120],"id":"6c6d1f49-ea87-466b-b7be-c88bedcaa2a4","name":"Remove Duplicates"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2b232b91-51e5-4d02-b070-d31463e3eada","leftValue":"={{ $json.cnpj_basico }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"f4f56071-edb4-4894-ae3b-d58480d74990","leftValue":"={{ $json.cnpj_ordem }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"d6b9817c-132d-4622-a432-fb033c631640","leftValue":"={{ $json.cnpj_dv }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-368,1120],"id":"0b9b68d8-1924-4cb2-87c6-7bb29fc87db5","name":"Filter"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.busca_empresas_cnae_flexivel($1, $2, $3, $4, $5, $6, $7, $8, $9);\n","options":{"connectionTimeout":500,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n\n  $('filtros_supabase').first().json._data_limite,\n\n  (typeof $('filtros_supabase').first().json._termos === 'string') ? JSON.parse($('filtros_supabase').first().json._termos) : $('filtros_supabase').first().json._termos,\n\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio,\n\n$('filtros_supabase').item.json.range_busca,\n\n$('filtros_supabase').item.json.n_cnaes_buscados]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3312,1456],"id":"0122a608-a1ba-4504-bd8d-3592bb37efd5","name":"V2-busca_filtrada_com_site","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.v2_get_estabelecimentos_filtrados_avancado_com_site_sem_termos($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n\n  $('filtros_supabase').first().json._data_limite,\n\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ?JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio,\n\n$('filtros_supabase').item.json.range_busca,\n\n$('filtros_supabase').item.json.n_cnaes_buscados.toNumber()\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2880,1520],"id":"3e93081f-1483-4113-a39e-279011699000","name":"V2_get_estabelecimentos_com_site_sem_termos","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fc20e47d-3914-48ba-824e-b88ef182ac5d","leftValue":"={{ $json.item.nota }}","rightValue":80,"operator":{"type":"number","operation":"gte"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[1200,976],"id":"9273e1a0-2c3e-4758-98de-3472174454a8","name":"nota é 80 ou mais","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9cfd503a-d6fe-47a9-80f9-9da528338ebe","leftValue":"={{ $json.nota.length }}","rightValue":4,"operator":{"type":"number","operation":"gte"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1520,976],"id":"9ba44d2c-8e4c-4c59-b002-d907e9b3d99d","name":"resultados>minimo_aceitavel"}],"connections":{"filtros_supabase":{"main":[[{"node":"get1","type":"main","index":0}]]},"wait_2min":{"main":[[{"node":"get_result1","type":"main","index":0}]]},"tem_resumo?":{"main":[[{"node":"vazio?1","type":"main","index":0}],[{"node":"Call 'Envia e-mail'1","type":"main","index":0}]]},"vazio?":{"main":[[{"node":"sub_busca_ampla2","type":"main","index":0}],[{"node":"put1","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"processa_empresa_sub1","type":"main","index":0}]]},"Split Out2":{"main":[[{"node":"concatenate_cnaes1","type":"main","index":0}]]},"all_cnaes1":{"main":[[{"node":"busca_filtro_site3","type":"main","index":0}]]},"AchouAlgum?3":{"main":[[{"node":"cnpj_ja_usado1","type":"main","index":0}],[{"node":"V2_get_estabelecimentos_com_site_sem_termos","type":"main","index":0}]]},"tipo_de_consulta1":{"main":[[{"node":"Split Out2","type":"main","index":0},{"node":"Merge","type":"main","index":1}],[{"node":"tem_resumo?","type":"main","index":0}]]},"get_result1":{"main":[[{"node":"Split Out3","type":"main","index":0}]]},"Split Out3":{"main":[[{"node":"nota é 80 ou mais","type":"main","index":0}]]},"Aggregate3":{"main":[[{"node":"resultados>minimo_aceitavel","type":"main","index":0}]]},"busca_filtro_site3":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Loop Over batch ":{"main":[[{"node":"wait_2min","type":"main","index":0}],[{"node":"Aggregate1","type":"main","index":0}]]},"concatenate_cnaes1":{"main":[[{"node":"all_cnaes1","type":"main","index":0}]]},"AchouAlgumAgora?1":{"main":[[{"node":"cnpj_ja_usado1","type":"main","index":0}],[{"node":"sub_busca_ampla2","type":"main","index":0}]]},"get1":{"main":[[{"node":"V2-busca_filtrada_com_site","type":"main","index":0}]]},"put1":{"main":[[{"node":"tipo_de_consulta1","type":"main","index":0}]]},"cnpj_ja_usado1":{"main":[[{"node":"vazio?","type":"main","index":0}]]},"processa_empresa_sub1":{"main":[[{"node":"Loop Over batch ","type":"main","index":0}]]},"vazio?1":{"main":[[{"node":"sub_busca_ampla1","type":"main","index":0}],[{"node":"Loop Over batch ","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Filter","type":"main","index":0}]]},"Remove Duplicates":{"main":[[{"node":"tem_resumo?","type":"main","index":0}]]},"Filter":{"main":[[{"node":"Remove Duplicates","type":"main","index":0}]]},"V2-busca_filtrada_com_site":{"main":[[{"node":"AchouAlgum?3","type":"main","index":0}]]},"V2_get_estabelecimentos_com_site_sem_termos":{"main":[[{"node":"AchouAlgumAgora?1","type":"main","index":0}]]},"nota é 80 ou mais":{"main":[[{"node":"Aggregate3","type":"main","index":0}]]},"resultados>minimo_aceitavel":{"main":[[{"node":"concluído1","type":"main","index":0}],[{"node":"sub_busca_ampla1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"filtros_supabase":[{"json":{"_cnaes":["3099700","2822402","2930103","1610202","1622602","1629301","4744002","1621800","1623400"],"_uf_filtro":["MG"],"_data_limite":"20240101\n","_termos":["caixa madeira","embalagem","madeira","caixa","embalagem madeira","suporte v","apoio v","embalagem industrial","caixas madeira","palete madeira","caixa embalagem","madeira embalagem","caixa suporte","embalagem custom","caixa transporte","madeira custom","suporte industrial","caixa hidraulico","embalagem pesada","caixa robusta"],"_porte_empresa":["00","01","05","03"],"_natureza_juridica":["2062"],"escopo_segmento":"Não especificado, CAIXA DE MADEIRA COM TAMPA E APOIOS INTERNOS EM \"V\" PARA ACONDICIONAMENTO DE 01 CAMISA DE CILINDRO HIDRÁULICO COM AS CARACTERÍSTICAS INDICADAS ABAIXO:\n- PESO TOTAL DA CAMISA: 2924 kg;\n- COMPRIMENTO TOTAL DA CAMISA: 4293 mm;\n- LARGURA MÁXIMA DA CAMISA: 530 mm;\n- ALTURA MÁXIMA DA CAMISA: 521 mm;\n- DIÂMETRO DA CAMISA: 521 mm.\n\nOBS.:\n- FORNECER A EMBALAGEM COM 2 (DOIS) PARES DE APOIO EM \"V\" PARA APOIAR A CAMISA PELO DIÂMETRO DE 521 mm;\n- PREVER FOLGAS INTERNAS SUFICIENTES PARA O MANUEIO DA CAMISA, DURANTE O ACONDICIONAMENTO E RETIRADA DA EMBALAGEM.\n","tipo_busca":"generalista","consulta_id":"58ee5c7f-522b-4ff6-842b-c042aec2fb48","n_cnaes_buscados":"2","range_busca":1500}}]},"versionId":"9359488c-50e7-4a07-aeff-bb54f00f0c44","triggerCount":0,"shared":[{"updatedAt":"2025-10-02T13:44:57.914Z","createdAt":"2025-10-02T13:44:57.914Z","role":"workflow:owner","workflowId":"xRPy7yiYbCD62vRV","projectId":"jk0yZKautC5L7CBp"}],"tags":[{"updatedAt":"2025-10-02T13:53:47.318Z","createdAt":"2025-10-02T13:53:47.318Z","id":"El7C2Bp08WUbNazn","name":"Subworkflow"}]}