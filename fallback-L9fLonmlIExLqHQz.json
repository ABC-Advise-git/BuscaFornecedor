{"updatedAt":"2026-02-09T14:00:38.117Z","createdAt":"2025-12-08T14:18:13.809Z","id":"L9fLonmlIExLqHQz","name":"Fallback","active":true,"isArchived":false,"nodes":[{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"get","tableId":"consultas","filters":{"conditions":[{"keyName":"id","keyValue":"={{ $json.Id_consulta }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[128,-112],"id":"279d2a58-17fa-4c17-ae3a-632c0d2f1b1e","name":"get_status_consulta","alwaysOutputData":false,"executeOnce":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}},"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"f21f4e90-eabe-4adb-9858-eb0c9edf5812","name":"parametros.segmento","value":"={{ $json.parametros.segmento }}","type":"string"},{"id":"13333b48-eec0-4022-9f6f-f0b2927510a9","name":"parametros.descricao","value":"={{ $json.parametros.descricao }}","type":"string"},{"id":"e5ed1e49-5086-4bb7-b96f-ca2095d4828f","name":"parametros.tipo_busca","value":"={{ $json.parametros.tipo_busca }}","type":"string"},{"id":"69687634-3c37-4f36-a517-93a3415a1957","name":"parametros.ufs_selecionadas","value":"={{ $json.parametros.ufs_selecionadas }}","type":"array"},{"id":"ca2fe093-0626-4bb6-8524-3c9b0438058c","name":"comprador","value":"={{ $json.comprador }}","type":"string"},{"id":"2bdd3063-22a4-4f4f-ab31-b904134fb657","name":"status","value":"={{ $json.status }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[208,-656],"id":"393b0ca3-7a53-48af-85ad-91a9487b1191","name":"set_data"},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[2912,-240],"id":"1aa001cf-548a-4bea-97fa-da5e1b2e8357","name":"Loop Over Items"},{"parameters":{"content":"## Banco de dados:\n- Busca Empresas na view materializada.\n- Filtra as com capital social <2000.","height":304,"width":384,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1072,-256],"id":"70005c3e-b42d-4bab-a3d0-9cc41e56b082","name":"Sticky Note21"},{"parameters":{"content":"## Processamento:\n- Enriquece as empresas que passam do filtro.","height":320,"width":848,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2848,-352],"id":"6b9f15f9-409e-4eef-816f-3812cfe6a687","name":"Sticky Note25"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv($1, $2, $3, $4, $5, $6, $7, $8, $9);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  $('filtros_supabase').item.json.propertyName._cnaes ? $('filtros_supabase').item.json.propertyName._cnaes.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._uf_filtro ? $('filtros_supabase').item.json.propertyName._uf_filtro.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._data_limite ? $('filtros_supabase').item.json.propertyName._data_limite.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._termos ? $('filtros_supabase').item.json.propertyName._termos.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._porte_empresa ? $('filtros_supabase').item.json.propertyName._porte_empresa.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._natureza_juridica ? $('filtros_supabase').item.json.propertyName._natureza_juridica.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._codigo_municipio ? $('filtros_supabase').item.json.propertyName._codigo_municipio.toJsonString() : null,\n\n  1500,\n  1\n]\n}}\n"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[560,-656],"id":"14d6ce51-5242-44d5-a50d-3089e9384967","name":"busca_view_materializada","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"3edec4ec-bf65-452c-8d80-d25f8d29c3c9","name":"data.cnpj","value":"={{ $json.cnpj }}","type":"string"},{"id":"0798b63f-e5b8-4a86-92b9-a69b743031e7","name":"data.razao_social","value":"={{ $json.razao_social }}","type":"string"},{"id":"486ecd29-cdc6-45f6-97d7-28cd8c009e97","name":"data.nome_fantasia","value":"={{ $json.nome_fantasia }}","type":"string"},{"id":"590dd63e-366f-436b-9744-26e6ae1c0f3a","name":"data.matriz_filial","value":"={{ $json.matriz_filial }}","type":"string"},{"id":"ff9a0ec8-94f5-4e55-a04d-0ea2af759259","name":"data.situacao_cadastral","value":"={{ $json.situacao_cadastral }}","type":"string"},{"id":"ff06f725-ba26-45bc-85d7-7da962366c5d","name":"data.data_inicio_atividades","value":"={{ $json.data_inicio_atividades }}","type":"string"},{"id":"d5d2fb79-f093-4e09-9d5c-aa525b54711f","name":"data.natureza_juridica","value":"={{ $json.natureza_juridica }}","type":"string"},{"id":"07fd73c5-121e-466b-a3c1-7ac9895b6ce6","name":"data.porte_empresa","value":"={{ $json.porte_empresa }}","type":"string"},{"id":"cce1a3b3-b23a-4777-a7b1-7a20e05c8eb4","name":"data.cnae_fiscal_principal_codigo","value":"={{ $json.cnae_fiscal_principal_codigo }}","type":"string"},{"id":"0516c15e-9966-4047-9c19-2b369b3dcda3","name":"data.cnae_fiscal_principal_nome","value":"={{ $json.cnae_fiscal_principal_nome }}","type":"string"},{"id":"0690363a-a589-4bee-8d46-9e9c1966db99","name":"data.uf","value":"={{ $json.uf }}","type":"string"},{"id":"d1142f5a-99f5-4b4d-800d-8f1c5fc4fd00","name":"data.nome_municipio","value":"={{ $json.nome_municipio }}","type":"string"},{"id":"0af5a445-8322-4682-b9ce-9c1bc7e9a1e2","name":"data.site","value":"={{ $json.site }}","type":"string"},{"id":"54eef589-85b1-46c4-a36f-7e8a861b3fd2","name":"data.todos_codigos_cnae","value":"={{ $json.todos_codigos_cnae }}","type":"string"},{"id":"28ff89f7-a272-40bb-9c2c-8bcfd837399b","name":"data.todos_nomes_cnae","value":"={{ $json.todos_nomes_cnae }}","type":"string"},{"id":"f0a9de01-ebb2-48a6-b09f-7ca13e08cdfe","name":"data.cnpj_basico","value":"={{ $json.cnpj_basico }}","type":"string"},{"id":"395e2ea9-9494-4d62-8953-91e290f9c514","name":"data.cnpj_ordem","value":"={{ $json.cnpj_ordem }}","type":"string"},{"id":"c94dde4d-09ed-4169-83c2-1f94fa5c1295","name":"data.cnpj_dv","value":"={{ $json.cnpj_dv }}","type":"string"},{"id":"a468d569-3d7e-4037-9560-3734845c3654","name":"data.cnae_fiscal_secundaria_str","value":"={{ $json.cnae_fiscal_secundaria_str }}","type":"string"},{"id":"04715313-4947-4e51-ba84-0eb2948df893","name":"data.clientes","value":"={{ $json.clientes }}","type":"string"},{"id":"f055cca1-2568-4b1c-8168-d104bf7a850d","name":"data.correio_eletronico","value":"={{ $json.correio_eletronico }}","type":"string"},{"id":"9c57165c-506b-4938-8df6-96feea7c6953","name":"data.capital_social_str","value":"={{ $json.capital_social_str }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2704,-240],"id":"df99928b-851e-4a6a-a726-1d9f35a0dbe1","name":"set_parametros"},{"parameters":{"url":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/enriquece-cnpj-teste","sendBody":true,"bodyParameters":{"parameters":[{"name":"data","value":"={{ $json.data }}"},{"name":"id_consulta","value":"={{ $('filtros_supabase').item.json.id_consulta || $('Webhook').item.json.query.consultaId }}"},{"name":"escopo_segmento","value":"={{ $('filtros_supabase').item.json.escopo_segmento }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3328,-224],"id":"0ffadef4-12ad-4466-a1bd-48f645c60f78","name":"enriquece_cnpj_sub"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"77df7537-a8a5-49d3-a4f7-6b1b4eb16bf5","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1648,-128],"id":"6ae1cf0d-8332-4a17-9c37-02427f143283","name":"vazio?"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv_sem_termos($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n$('filtros_supabase').item.json.propertyName._cnaes,\n\n$('filtros_supabase').item.json.propertyName._uf_filtro,\n\n$('filtros_supabase').item.json.propertyName._data_limite,\n\n$('filtros_supabase').item.json.propertyName._porte_empresa,\n\n$('filtros_supabase').item.json.propertyName._natureza_juridica,\n\n$('filtros_supabase').item.json.propertyName._codigo_municipio,\n\n200,\n\n2\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1536,-304],"id":"f6ecc6f2-ccae-49a5-a00f-b6261801a416","name":"busca_view_sem_termos","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"77df7537-a8a5-49d3-a4f7-6b1b4eb16bf5","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1728,-304],"id":"8b10ed6c-27a0-4b77-a188-08eda63ac5a6","name":"vazio_ainda?"},{"parameters":{"content":"## Tratativa\n- Realiza uma segunda busca sem aplicar termos.","height":448,"width":576},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1472,-400],"id":"fb42e4af-d86f-447b-b18e-ac627b479289","name":"Sticky Note34"},{"parameters":{"operation":"get","key":"={{ $('set_id').item.json.Id_consulta }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[912,-128],"id":"4ddbd806-4774-440d-b237-24eda6a3a4d4","name":"get1","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"operation":"push","list":"={{ $('set_id').item.json.Id_consulta }}","messageData":"={{ $json.razao_social || \"\" }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2512,-240],"id":"82640ee7-e509-4ac4-8cd7-054f71587a91","name":"put","alwaysOutputData":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"content":"## Tratativa\n- Filtra cnpjs que j치 apareceram em consultas anteriores.\n- Adiciona os cnpjs processados em uma fila.","height":288,"width":768},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2064,-368],"id":"dfe55be7-2b90-4e75-8c1c-11c636377c68","name":"Sticky Note35"},{"parameters":{"content":"## Tratativa\n- Busca fila com todos os cnpjs j치 usados nessa consulta","height":256},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[816,-240],"id":"6a56cb39-78dd-4f52-9528-22a6319e0406","name":"Sticky Note36"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"632881b3-acbb-465e-ba03-0931e4bbdee8","leftValue":"={{ $('get1').item.json.propertyName }}","rightValue":"={{ $json.razao_social }}","operator":{"type":"array","operation":"notContains","rightType":"any"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[2112,-240],"id":"d031f1df-1599-4c57-a722-e1b422ce09bd","name":"cnpj_ja_usado","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7135792c-07b2-47f5-bf01-1c87cf454916","leftValue":"={{ $json.capital_social_str.split(\",\").first().toNumber()}}","rightValue":2000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1936,-240],"id":"038d3ae0-697a-49be-b06b-f32cc5dbdcb2","name":"+2000","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7135792c-07b2-47f5-bf01-1c87cf454916","leftValue":"={{ $json.capital_social_str.split(\",\").first().toNumber()}}","rightValue":2000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1312,-128],"id":"91e17476-995b-4f8b-8853-e57ce5a1463a","name":"+2001","alwaysOutputData":true},{"parameters":{"operation":"push","list":"={{ $('Webhook').item.json.body.consultaId }}-data","messageData":"={{ $json.data.toJsonString() }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[384,-656],"id":"f6adc511-ab3e-4277-8071-a70a9844314c","name":"put2","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"operation":"get","key":"={{ $json.id }}-data","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[352,-128],"id":"2e97f58a-d75e-4968-9240-2edfc9e8b8ea","name":"get","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"path":"reprocessamento","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-224,-176],"id":"a557d484-acd7-4893-868a-3d30a50e18b9","name":"Webhook","webhookId":"c7490d9d-268a-462b-a253-5da8901557c3"},{"parameters":{"assignments":{"assignments":[{"id":"be944724-f517-4eca-868a-75374d126e06","name":"Id_consulta","value":"={{ $json.consultaId || $json.query.consultaId}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-16,-112],"id":"501d936b-7d66-4486-b528-acb0643d7112","name":"set_id"},{"parameters":{"assignments":{"assignments":[{"id":"491dcef7-f9ff-4068-8eee-1a2e57cd73d3","name":"propertyName","value":"={{ $json.propertyName.first() }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[688,-128],"id":"05490d2d-f29e-4247-aba6-99b31e24da70","name":"filtros_supabase"},{"parameters":{"workflowInputs":{"values":[{"name":"consultaId"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-224,-16],"id":"9c76b708-d7e1-4623-a070-1f7a93442b93","name":"subwork"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv($1, $2, $3, $4, $5, $6, $7, $8, $9);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ( $('filtros_supabase').item.json.propertyName._cnaes|| $('filtros_supabase').item.json.propertyName._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').item.json.propertyName._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').item.json.propertyName._cnaes),\n\n  (typeof $('filtros_supabase').item.json.propertyName._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').item.json.propertyName._uf_filtro) : $('filtros_supabase').item.json.propertyName._uf_filtro,\n\n  $('filtros_supabase').item.json.propertyName._data_limite,\n\n  (typeof $('filtros_supabase').item.json.propertyName._termos === 'string') ? JSON.parse($('filtros_supabase').item.json.propertyName._termos) : $('filtros_supabase').item.json.propertyName._termos,\n\n  (typeof $('filtros_supabase').item.json.propertyName._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').item.json.propertyName._porte_empresa) : $('filtros_supabase').item.json.propertyName._porte_empresa,\n\n  (typeof $('filtros_supabase').item.json.propertyName._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').item.json.propertyName._natureza_juridica) : $('filtros_supabase').item.json.propertyName._natureza_juridica,\n\n  (typeof $('filtros_supabase').item.json.propertyName._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').item.json.propertyName._codigo_municipio) : $('filtros_supabase').item.json.propertyName._codigo_municipio,\n\n1500,\n\n\n1\n\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1136,-128],"id":"dba51e0b-2bac-43cc-902d-3cca2f69649c","name":"busca_view_materializada1","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"632881b3-acbb-465e-ba03-0931e4bbdee8","leftValue":"={{ $json }}","rightValue":"=","operator":{"type":"object","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[2320,-240],"id":"73bca0ed-e53c-4a82-9e15-a559c9f0156e","name":"cnpj_ja_usado1","alwaysOutputData":false},{"parameters":{"content":"## Capital Social\n","height":224,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2064,-64],"id":"79026109-84f9-4dec-b5f8-f71644559dfd","name":"Sticky Note2"},{"parameters":{"workflowId":{"__rl":true,"value":"8wGQEu6ASkKw1oMS","mode":"list","cachedResultUrl":"/workflow/8wGQEu6ASkKw1oMS","cachedResultName":"Insere_fila_emails/aparicao"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data.email_fornecedor":"={{ $json.correio_eletronico }}","data.cnpj_basico":"={{ $json.cnpj_basico }}","data.cnpj_ordem":"={{ $json.cnpj_ordem }}","data.cnpj_dv":"={{ $json.cnpj_dv }}","data.id_consulta":"={{ $('filtros_supabase').item.json.propertyName.body.consultaId }}","data.motivo":"capital_social"},"matchingColumns":[],"schema":[{"id":"data.email_fornecedor","displayName":"data.email_fornecedor","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.motivo","displayName":"data.motivo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_basico","displayName":"data.cnpj_basico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_dv","displayName":"data.cnpj_dv","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_ordem","displayName":"data.cnpj_ordem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.id_consulta","displayName":"data.id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"nota","displayName":"nota","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[2128,0],"id":"374879e5-4961-4477-bb5a-a029def4c1ea","name":"Call 'Envia e-mail'"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"afc217e4-808c-4e99-9484-f21b0029ebbc","leftValue":"={{ $json.propertyName.first() }}","rightValue":"","operator":{"type":"object","operation":"exists","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[496,-128],"id":"a2ea51b1-bad5-4983-98c7-8ce46bc23cb8","name":"If"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"0f276657-2d70-4b19-b163-c401c8a14b77","leftValue":"={{ $('filtros_supabase').item.json.id_consulta || $('Webhook').item.json.query.consultaId }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[3120,-224],"id":"ae2ffed8-4232-443a-a272-ce57f696070a","name":"id_faltando"},{"parameters":{"errorMessage":"ID CONSULTA VAZIO!!!! (FALBACK)"},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[3136,16],"id":"139e84c0-f804-4b1d-9069-90e40824d588","name":"Stop and Error"}],"connections":{"get_status_consulta":{"main":[[{"node":"get","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"id_faltando","type":"main","index":0}]]},"busca_view_materializada":{"main":[[]]},"set_parametros":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"enriquece_cnpj_sub":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"vazio?":{"main":[[{"node":"busca_view_sem_termos","type":"main","index":0}],[{"node":"cnpj_ja_usado","type":"main","index":0}]]},"busca_view_sem_termos":{"main":[[{"node":"vazio_ainda?","type":"main","index":0}]]},"vazio_ainda?":{"main":[[],[{"node":"+2000","type":"main","index":0}]]},"get1":{"main":[[{"node":"busca_view_materializada1","type":"main","index":0}]]},"put":{"main":[[{"node":"set_parametros","type":"main","index":0}]]},"cnpj_ja_usado":{"main":[[{"node":"cnpj_ja_usado1","type":"main","index":0}]]},"+2000":{"main":[[{"node":"cnpj_ja_usado","type":"main","index":0}],[{"node":"Call 'Envia e-mail'","type":"main","index":0}]]},"+2001":{"main":[[{"node":"vazio?","type":"main","index":0}],[{"node":"Call 'Envia e-mail'","type":"main","index":0}]]},"set_data":{"main":[[]]},"get":{"main":[[{"node":"If","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"set_id","type":"main","index":0}]]},"set_id":{"main":[[{"node":"get_status_consulta","type":"main","index":0}]]},"filtros_supabase":{"main":[[{"node":"get1","type":"main","index":0}]]},"busca_view_materializada1":{"main":[[{"node":"+2001","type":"main","index":0}]]},"subwork":{"main":[[{"node":"set_id","type":"main","index":0}]]},"cnpj_ja_usado1":{"main":[[{"node":"put","type":"main","index":0}]]},"If":{"main":[[{"node":"filtros_supabase","type":"main","index":0}],[{"node":"busca_view_materializada1","type":"main","index":0}]]},"id_faltando":{"main":[[{"node":"enriquece_cnpj_sub","type":"main","index":0}],[{"node":"Stop and Error","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timeSavedMode":"fixed","callerPolicy":"workflowsFromSameOwner","availableInMCP":false,"errorWorkflow":"KFeveZkBafvIC5xECfmBs"},"staticData":null,"meta":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"primary-kpc3-buscafornecedor.up.railway.app","user-agent":"Deno/2.1.4 (variant; SupabaseEdgeRuntime/1.70.1)","accept":"*/*","accept-encoding":"gzip,br","accept-language":"*","x-forwarded-for":"18.231.164.89","x-forwarded-host":"primary-kpc3-buscafornecedor.up.railway.app","x-forwarded-proto":"https","x-railway-edge":"railway/us-east4-eqdc4a","x-railway-request-id":"bvX6pmLtQ8im_Y0FCx5-qw","x-real-ip":"18.231.164.89","x-request-start":"1770405408901"},"params":{},"query":{"consultaId":"0dba6b64-a42e-422d-9fa4-fef6212f2124","timestamp":"2026-02-06T19:16:48.218Z"},"body":{},"webhookUrl":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/reprocessamento","executionMode":"production"},"pairedItem":{"item":0}}],"subwork":[{"json":{"consultaId":"d59fa887-c7ab-4181-a05e-545ffdb81ec2"},"pairedItem":{"item":0}}]},"versionId":"1b77277e-b76d-4a3b-b6f3-b3cc11227ad7","activeVersionId":"1b77277e-b76d-4a3b-b6f3-b3cc11227ad7","triggerCount":1,"shared":[{"updatedAt":"2025-12-08T14:18:13.809Z","createdAt":"2025-12-08T14:18:13.809Z","role":"workflow:owner","workflowId":"L9fLonmlIExLqHQz","projectId":"jk0yZKautC5L7CBp"}],"activeVersion":{"updatedAt":"2026-02-09T14:00:40.821Z","createdAt":"2026-02-09T14:00:38.115Z","versionId":"1b77277e-b76d-4a3b-b6f3-b3cc11227ad7","workflowId":"L9fLonmlIExLqHQz","nodes":[{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"get","tableId":"consultas","filters":{"conditions":[{"keyName":"id","keyValue":"={{ $json.Id_consulta }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[128,-112],"id":"279d2a58-17fa-4c17-ae3a-632c0d2f1b1e","name":"get_status_consulta","alwaysOutputData":false,"executeOnce":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}},"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"f21f4e90-eabe-4adb-9858-eb0c9edf5812","name":"parametros.segmento","value":"={{ $json.parametros.segmento }}","type":"string"},{"id":"13333b48-eec0-4022-9f6f-f0b2927510a9","name":"parametros.descricao","value":"={{ $json.parametros.descricao }}","type":"string"},{"id":"e5ed1e49-5086-4bb7-b96f-ca2095d4828f","name":"parametros.tipo_busca","value":"={{ $json.parametros.tipo_busca }}","type":"string"},{"id":"69687634-3c37-4f36-a517-93a3415a1957","name":"parametros.ufs_selecionadas","value":"={{ $json.parametros.ufs_selecionadas }}","type":"array"},{"id":"ca2fe093-0626-4bb6-8524-3c9b0438058c","name":"comprador","value":"={{ $json.comprador }}","type":"string"},{"id":"2bdd3063-22a4-4f4f-ab31-b904134fb657","name":"status","value":"={{ $json.status }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[208,-656],"id":"393b0ca3-7a53-48af-85ad-91a9487b1191","name":"set_data"},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[2912,-240],"id":"1aa001cf-548a-4bea-97fa-da5e1b2e8357","name":"Loop Over Items"},{"parameters":{"content":"## Banco de dados:\n- Busca Empresas na view materializada.\n- Filtra as com capital social <2000.","height":304,"width":384,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1072,-256],"id":"70005c3e-b42d-4bab-a3d0-9cc41e56b082","name":"Sticky Note21"},{"parameters":{"content":"## Processamento:\n- Enriquece as empresas que passam do filtro.","height":320,"width":848,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2848,-352],"id":"6b9f15f9-409e-4eef-816f-3812cfe6a687","name":"Sticky Note25"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv($1, $2, $3, $4, $5, $6, $7, $8, $9);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  $('filtros_supabase').item.json.propertyName._cnaes ? $('filtros_supabase').item.json.propertyName._cnaes.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._uf_filtro ? $('filtros_supabase').item.json.propertyName._uf_filtro.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._data_limite ? $('filtros_supabase').item.json.propertyName._data_limite.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._termos ? $('filtros_supabase').item.json.propertyName._termos.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._porte_empresa ? $('filtros_supabase').item.json.propertyName._porte_empresa.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._natureza_juridica ? $('filtros_supabase').item.json.propertyName._natureza_juridica.toJsonString() : null,\n\n  $('filtros_supabase').item.json.propertyName._codigo_municipio ? $('filtros_supabase').item.json.propertyName._codigo_municipio.toJsonString() : null,\n\n  1500,\n  1\n]\n}}\n"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[560,-656],"id":"14d6ce51-5242-44d5-a50d-3089e9384967","name":"busca_view_materializada","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"3edec4ec-bf65-452c-8d80-d25f8d29c3c9","name":"data.cnpj","value":"={{ $json.cnpj }}","type":"string"},{"id":"0798b63f-e5b8-4a86-92b9-a69b743031e7","name":"data.razao_social","value":"={{ $json.razao_social }}","type":"string"},{"id":"486ecd29-cdc6-45f6-97d7-28cd8c009e97","name":"data.nome_fantasia","value":"={{ $json.nome_fantasia }}","type":"string"},{"id":"590dd63e-366f-436b-9744-26e6ae1c0f3a","name":"data.matriz_filial","value":"={{ $json.matriz_filial }}","type":"string"},{"id":"ff9a0ec8-94f5-4e55-a04d-0ea2af759259","name":"data.situacao_cadastral","value":"={{ $json.situacao_cadastral }}","type":"string"},{"id":"ff06f725-ba26-45bc-85d7-7da962366c5d","name":"data.data_inicio_atividades","value":"={{ $json.data_inicio_atividades }}","type":"string"},{"id":"d5d2fb79-f093-4e09-9d5c-aa525b54711f","name":"data.natureza_juridica","value":"={{ $json.natureza_juridica }}","type":"string"},{"id":"07fd73c5-121e-466b-a3c1-7ac9895b6ce6","name":"data.porte_empresa","value":"={{ $json.porte_empresa }}","type":"string"},{"id":"cce1a3b3-b23a-4777-a7b1-7a20e05c8eb4","name":"data.cnae_fiscal_principal_codigo","value":"={{ $json.cnae_fiscal_principal_codigo }}","type":"string"},{"id":"0516c15e-9966-4047-9c19-2b369b3dcda3","name":"data.cnae_fiscal_principal_nome","value":"={{ $json.cnae_fiscal_principal_nome }}","type":"string"},{"id":"0690363a-a589-4bee-8d46-9e9c1966db99","name":"data.uf","value":"={{ $json.uf }}","type":"string"},{"id":"d1142f5a-99f5-4b4d-800d-8f1c5fc4fd00","name":"data.nome_municipio","value":"={{ $json.nome_municipio }}","type":"string"},{"id":"0af5a445-8322-4682-b9ce-9c1bc7e9a1e2","name":"data.site","value":"={{ $json.site }}","type":"string"},{"id":"54eef589-85b1-46c4-a36f-7e8a861b3fd2","name":"data.todos_codigos_cnae","value":"={{ $json.todos_codigos_cnae }}","type":"string"},{"id":"28ff89f7-a272-40bb-9c2c-8bcfd837399b","name":"data.todos_nomes_cnae","value":"={{ $json.todos_nomes_cnae }}","type":"string"},{"id":"f0a9de01-ebb2-48a6-b09f-7ca13e08cdfe","name":"data.cnpj_basico","value":"={{ $json.cnpj_basico }}","type":"string"},{"id":"395e2ea9-9494-4d62-8953-91e290f9c514","name":"data.cnpj_ordem","value":"={{ $json.cnpj_ordem }}","type":"string"},{"id":"c94dde4d-09ed-4169-83c2-1f94fa5c1295","name":"data.cnpj_dv","value":"={{ $json.cnpj_dv }}","type":"string"},{"id":"a468d569-3d7e-4037-9560-3734845c3654","name":"data.cnae_fiscal_secundaria_str","value":"={{ $json.cnae_fiscal_secundaria_str }}","type":"string"},{"id":"04715313-4947-4e51-ba84-0eb2948df893","name":"data.clientes","value":"={{ $json.clientes }}","type":"string"},{"id":"f055cca1-2568-4b1c-8168-d104bf7a850d","name":"data.correio_eletronico","value":"={{ $json.correio_eletronico }}","type":"string"},{"id":"9c57165c-506b-4938-8df6-96feea7c6953","name":"data.capital_social_str","value":"={{ $json.capital_social_str }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2704,-240],"id":"df99928b-851e-4a6a-a726-1d9f35a0dbe1","name":"set_parametros"},{"parameters":{"url":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/enriquece-cnpj-teste","sendBody":true,"bodyParameters":{"parameters":[{"name":"data","value":"={{ $json.data }}"},{"name":"id_consulta","value":"={{ $('filtros_supabase').item.json.id_consulta || $('Webhook').item.json.query.consultaId }}"},{"name":"escopo_segmento","value":"={{ $('filtros_supabase').item.json.escopo_segmento }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3328,-224],"id":"0ffadef4-12ad-4466-a1bd-48f645c60f78","name":"enriquece_cnpj_sub"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"77df7537-a8a5-49d3-a4f7-6b1b4eb16bf5","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1648,-128],"id":"6ae1cf0d-8332-4a17-9c37-02427f143283","name":"vazio?"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv_sem_termos($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n$('filtros_supabase').item.json.propertyName._cnaes,\n\n$('filtros_supabase').item.json.propertyName._uf_filtro,\n\n$('filtros_supabase').item.json.propertyName._data_limite,\n\n$('filtros_supabase').item.json.propertyName._porte_empresa,\n\n$('filtros_supabase').item.json.propertyName._natureza_juridica,\n\n$('filtros_supabase').item.json.propertyName._codigo_municipio,\n\n200,\n\n2\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1536,-304],"id":"f6ecc6f2-ccae-49a5-a00f-b6261801a416","name":"busca_view_sem_termos","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"77df7537-a8a5-49d3-a4f7-6b1b4eb16bf5","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1728,-304],"id":"8b10ed6c-27a0-4b77-a188-08eda63ac5a6","name":"vazio_ainda?"},{"parameters":{"content":"## Tratativa\n- Realiza uma segunda busca sem aplicar termos.","height":448,"width":576},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1472,-400],"id":"fb42e4af-d86f-447b-b18e-ac627b479289","name":"Sticky Note34"},{"parameters":{"operation":"get","key":"={{ $('set_id').item.json.Id_consulta }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[912,-128],"id":"4ddbd806-4774-440d-b237-24eda6a3a4d4","name":"get1","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"operation":"push","list":"={{ $('set_id').item.json.Id_consulta }}","messageData":"={{ $json.razao_social || \"\" }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2512,-240],"id":"82640ee7-e509-4ac4-8cd7-054f71587a91","name":"put","alwaysOutputData":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"content":"## Tratativa\n- Filtra cnpjs que j치 apareceram em consultas anteriores.\n- Adiciona os cnpjs processados em uma fila.","height":288,"width":768},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2064,-368],"id":"dfe55be7-2b90-4e75-8c1c-11c636377c68","name":"Sticky Note35"},{"parameters":{"content":"## Tratativa\n- Busca fila com todos os cnpjs j치 usados nessa consulta","height":256},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[816,-240],"id":"6a56cb39-78dd-4f52-9528-22a6319e0406","name":"Sticky Note36"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"632881b3-acbb-465e-ba03-0931e4bbdee8","leftValue":"={{ $('get1').item.json.propertyName }}","rightValue":"={{ $json.razao_social }}","operator":{"type":"array","operation":"notContains","rightType":"any"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[2112,-240],"id":"d031f1df-1599-4c57-a722-e1b422ce09bd","name":"cnpj_ja_usado","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7135792c-07b2-47f5-bf01-1c87cf454916","leftValue":"={{ $json.capital_social_str.split(\",\").first().toNumber()}}","rightValue":2000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1936,-240],"id":"038d3ae0-697a-49be-b06b-f32cc5dbdcb2","name":"+2000","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7135792c-07b2-47f5-bf01-1c87cf454916","leftValue":"={{ $json.capital_social_str.split(\",\").first().toNumber()}}","rightValue":2000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1312,-128],"id":"91e17476-995b-4f8b-8853-e57ce5a1463a","name":"+2001","alwaysOutputData":true},{"parameters":{"operation":"push","list":"={{ $('Webhook').item.json.body.consultaId }}-data","messageData":"={{ $json.data.toJsonString() }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[384,-656],"id":"f6adc511-ab3e-4277-8071-a70a9844314c","name":"put2","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"operation":"get","key":"={{ $json.id }}-data","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[352,-128],"id":"2e97f58a-d75e-4968-9240-2edfc9e8b8ea","name":"get","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"path":"reprocessamento","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-224,-176],"id":"a557d484-acd7-4893-868a-3d30a50e18b9","name":"Webhook","webhookId":"c7490d9d-268a-462b-a253-5da8901557c3"},{"parameters":{"assignments":{"assignments":[{"id":"be944724-f517-4eca-868a-75374d126e06","name":"Id_consulta","value":"={{ $json.consultaId || $json.query.consultaId}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-16,-112],"id":"501d936b-7d66-4486-b528-acb0643d7112","name":"set_id"},{"parameters":{"assignments":{"assignments":[{"id":"491dcef7-f9ff-4068-8eee-1a2e57cd73d3","name":"propertyName","value":"={{ $json.propertyName.first() }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[688,-128],"id":"05490d2d-f29e-4247-aba6-99b31e24da70","name":"filtros_supabase"},{"parameters":{"workflowInputs":{"values":[{"name":"consultaId"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-224,-16],"id":"9c76b708-d7e1-4623-a070-1f7a93442b93","name":"subwork"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.get_estabelecimentos_otimizada_com_mv($1, $2, $3, $4, $5, $6, $7, $8, $9);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ( $('filtros_supabase').item.json.propertyName._cnaes|| $('filtros_supabase').item.json.propertyName._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').item.json.propertyName._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').item.json.propertyName._cnaes),\n\n  (typeof $('filtros_supabase').item.json.propertyName._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').item.json.propertyName._uf_filtro) : $('filtros_supabase').item.json.propertyName._uf_filtro,\n\n  $('filtros_supabase').item.json.propertyName._data_limite,\n\n  (typeof $('filtros_supabase').item.json.propertyName._termos === 'string') ? JSON.parse($('filtros_supabase').item.json.propertyName._termos) : $('filtros_supabase').item.json.propertyName._termos,\n\n  (typeof $('filtros_supabase').item.json.propertyName._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').item.json.propertyName._porte_empresa) : $('filtros_supabase').item.json.propertyName._porte_empresa,\n\n  (typeof $('filtros_supabase').item.json.propertyName._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').item.json.propertyName._natureza_juridica) : $('filtros_supabase').item.json.propertyName._natureza_juridica,\n\n  (typeof $('filtros_supabase').item.json.propertyName._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').item.json.propertyName._codigo_municipio) : $('filtros_supabase').item.json.propertyName._codigo_municipio,\n\n1500,\n\n\n1\n\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1136,-128],"id":"dba51e0b-2bac-43cc-902d-3cca2f69649c","name":"busca_view_materializada1","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"632881b3-acbb-465e-ba03-0931e4bbdee8","leftValue":"={{ $json }}","rightValue":"=","operator":{"type":"object","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[2320,-240],"id":"73bca0ed-e53c-4a82-9e15-a559c9f0156e","name":"cnpj_ja_usado1","alwaysOutputData":false},{"parameters":{"content":"## Capital Social\n","height":224,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2064,-64],"id":"79026109-84f9-4dec-b5f8-f71644559dfd","name":"Sticky Note2"},{"parameters":{"workflowId":{"__rl":true,"value":"8wGQEu6ASkKw1oMS","mode":"list","cachedResultUrl":"/workflow/8wGQEu6ASkKw1oMS","cachedResultName":"Insere_fila_emails/aparicao"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data.email_fornecedor":"={{ $json.correio_eletronico }}","data.cnpj_basico":"={{ $json.cnpj_basico }}","data.cnpj_ordem":"={{ $json.cnpj_ordem }}","data.cnpj_dv":"={{ $json.cnpj_dv }}","data.id_consulta":"={{ $('filtros_supabase').item.json.propertyName.body.consultaId }}","data.motivo":"capital_social"},"matchingColumns":[],"schema":[{"id":"data.email_fornecedor","displayName":"data.email_fornecedor","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.motivo","displayName":"data.motivo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_basico","displayName":"data.cnpj_basico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_dv","displayName":"data.cnpj_dv","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_ordem","displayName":"data.cnpj_ordem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.id_consulta","displayName":"data.id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"nota","displayName":"nota","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[2128,0],"id":"374879e5-4961-4477-bb5a-a029def4c1ea","name":"Call 'Envia e-mail'"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"afc217e4-808c-4e99-9484-f21b0029ebbc","leftValue":"={{ $json.propertyName.first() }}","rightValue":"","operator":{"type":"object","operation":"exists","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[496,-128],"id":"a2ea51b1-bad5-4983-98c7-8ce46bc23cb8","name":"If"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"0f276657-2d70-4b19-b163-c401c8a14b77","leftValue":"={{ $('filtros_supabase').item.json.id_consulta || $('Webhook').item.json.query.consultaId }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[3120,-224],"id":"ae2ffed8-4232-443a-a272-ce57f696070a","name":"id_faltando"},{"parameters":{"errorMessage":"ID CONSULTA VAZIO!!!! (FALBACK)"},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[3136,16],"id":"139e84c0-f804-4b1d-9069-90e40824d588","name":"Stop and Error"}],"connections":{"get_status_consulta":{"main":[[{"node":"get","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"id_faltando","type":"main","index":0}]]},"busca_view_materializada":{"main":[[]]},"set_parametros":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"enriquece_cnpj_sub":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"vazio?":{"main":[[{"node":"busca_view_sem_termos","type":"main","index":0}],[{"node":"cnpj_ja_usado","type":"main","index":0}]]},"busca_view_sem_termos":{"main":[[{"node":"vazio_ainda?","type":"main","index":0}]]},"vazio_ainda?":{"main":[[],[{"node":"+2000","type":"main","index":0}]]},"get1":{"main":[[{"node":"busca_view_materializada1","type":"main","index":0}]]},"put":{"main":[[{"node":"set_parametros","type":"main","index":0}]]},"cnpj_ja_usado":{"main":[[{"node":"cnpj_ja_usado1","type":"main","index":0}]]},"+2000":{"main":[[{"node":"cnpj_ja_usado","type":"main","index":0}],[{"node":"Call 'Envia e-mail'","type":"main","index":0}]]},"+2001":{"main":[[{"node":"vazio?","type":"main","index":0}],[{"node":"Call 'Envia e-mail'","type":"main","index":0}]]},"set_data":{"main":[[]]},"get":{"main":[[{"node":"If","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"set_id","type":"main","index":0}]]},"set_id":{"main":[[{"node":"get_status_consulta","type":"main","index":0}]]},"filtros_supabase":{"main":[[{"node":"get1","type":"main","index":0}]]},"busca_view_materializada1":{"main":[[{"node":"+2001","type":"main","index":0}]]},"subwork":{"main":[[{"node":"set_id","type":"main","index":0}]]},"cnpj_ja_usado1":{"main":[[{"node":"put","type":"main","index":0}]]},"If":{"main":[[{"node":"filtros_supabase","type":"main","index":0}],[{"node":"busca_view_materializada1","type":"main","index":0}]]},"id_faltando":{"main":[[{"node":"enriquece_cnpj_sub","type":"main","index":0}],[{"node":"Stop and Error","type":"main","index":0}]]}},"authors":"ABC  advise","name":"Version 1b77277e","description":"","autosaved":false},"tags":[]}