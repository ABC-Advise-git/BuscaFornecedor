{"updatedAt":"2025-12-04T19:06:23.557Z","createdAt":"2025-12-04T15:13:57.378Z","id":"j1Ce5yGwjXAmS8RT","name":"Fluxo_tabela_nova","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowInputs":{"values":[{"name":"_cnaes","type":"array"},{"name":"_uf_filtro","type":"array"},{"name":"_data_limite"},{"name":"_termos","type":"array"},{"name":"_porte_empresa","type":"array"},{"name":"_natureza_juridica","type":"array"},{"name":"_codigo_municipio","type":"array"},{"name":"escopo_segmento"},{"name":"tipo_busca"},{"name":"consulta_id"},{"name":"n_cnaes_buscados"},{"name":"range_busca","type":"number"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-496,-176],"id":"825d9cff-3a2b-46f3-9725-ba92ef3646db","name":"filtros_supabase"},{"parameters":{"content":"## Banco de dados:\n- Busca Empresas com site.","height":256,"width":272,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-400,-16],"id":"49eaa504-b12e-47f7-826e-47e57bd0bb4b","name":"Sticky Note23"},{"parameters":{"operation":"get","key":"={{ $('filtros_supabase').item.json.consulta_id }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-304,-176],"id":"91a54fd5-db6b-4a9e-b9a2-46fbe5eecf71","name":"get1","executeOnce":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"content":"## Tratativa\n- Busca fila com todos os cnpjs já usados nessa consulta","height":256,"width":224},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-368,-288],"id":"c0c4d34d-cc3e-42a9-a1bf-6de5a0fc2862","name":"Sticky Note39"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.busca_empresas_cnae_flexivel($1, $2, $3, $4, $5, $6, $7, $8, $9);\n","options":{"connectionTimeout":500,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n\n  $('filtros_supabase').first().json._data_limite,\n\n  (typeof $('filtros_supabase').first().json._termos === 'string') ? JSON.parse($('filtros_supabase').first().json._termos) : $('filtros_supabase').first().json._termos,\n\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ? JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio,\n\n$('filtros_supabase').item.json.range_busca,\n\n$('filtros_supabase').item.json.n_cnaes_buscados]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-320,80],"id":"19e6c89a-9f5e-45a2-b045-8d6326355455","name":"V2-busca_filtrada_com_site","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.busca_empresas_processadas1($1::text[], $2::text[], $3::text, $4::text[], $5::text[], $6::text[], $7::text, $8::text, $9::jsonb);","options":{"connectionTimeout":500,"queryReplacement":"={{\n[\n  // $1: _cnaes (text[])\n  (\n    typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string'\n      ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes)\n      : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes)\n  ),\n\n  // $2: _uf_filtro (text[])\n  (\n    typeof $('filtros_supabase').first().json._uf_filtro === 'string'\n      ? JSON.parse($('filtros_supabase').first().json._uf_filtro)\n      : $('filtros_supabase').first().json._uf_filtro\n  ),\n\n  // $3: _data_limite (text)\n  String($('filtros_supabase').first().json._data_limite || ''),\n\n  // $4: _termos (text[])\n  (\n    typeof $('filtros_supabase').first().json._termos === 'string'\n      ? JSON.parse($('filtros_supabase').first().json._termos)\n      : $('filtros_supabase').first().json._termos\n  ),\n\n  // $5: _porte_empresa (text[])\n  (\n    typeof $('filtros_supabase').first().json._porte_empresa === 'string'\n      ? JSON.parse($('filtros_supabase').first().json._porte_empresa)\n      : $('filtros_supabase').first().json._porte_empresa\n  ),\n\n  // $6: _natureza_juridica (text[])\n  (\n    typeof $('filtros_supabase').first().json._natureza_juridica === 'string'\n      ? JSON.parse($('filtros_supabase').first().json._natureza_juridica)\n      : $('filtros_supabase').first().json._natureza_juridica\n  ),\n\n  // $7: escopo_segmento (text)\n  String($('filtros_supabase').first().json.escopo_segmento || ''),\n\n  // $8: tipo_busca (text)\n  String($('filtros_supabase').first().json.tipo_busca || ''),\n\n  // $9: controles (jsonb)\n  JSON.stringify({\n    _limite_retorno: Number($('filtros_supabase').first().json._limite_retorno ?? 50),\n    _min_cnaes_distintos_interesse: Number($('filtros_supabase').first().json._min_cnaes_distintos_interesse ?? 1)\n  })\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-112,-176],"id":"38659103-2af8-4905-895d-dc1637ecc818","name":"V2-busca_filtrada_empresas_processadas","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"amount":60},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[4048,-656],"id":"e93ba221-07d5-483a-af25-cbba019df076","name":"wait_2min","webhookId":"c8dd8b69-328f-423d-836d-869c3c17b892"},{"parameters":{"workflowId":{"__rl":true,"value":"Sd487u8Pqgd9wfPU","mode":"list","cachedResultUrl":"/workflow/Sd487u8Pqgd9wfPU","cachedResultName":"Busca-Ampla"},"workflowInputs":{"mappingMode":"defineBelow","value":{"_cnaes":"={{ $('filtros_supabase').item.json._cnaes }}","_uf_filtro":"={{ $('filtros_supabase').item.json._uf_filtro }}","_data_limite":"={{ $('filtros_supabase').item.json._data_limite }}","_termos":"={{ $('filtros_supabase').item.json._termos }}","_porte_empresa":"={{ $('filtros_supabase').item.json._porte_empresa }}","_natureza_juridica":"={{ $('filtros_supabase').item.json._natureza_juridica }}","_codigo_municipio":"={{ $('filtros_supabase').item.json._codigo_municipio }}","escopo_segmento":"={{ $('filtros_supabase').item.json.escopo_segmento }}","tipo_busca":"={{ $('filtros_supabase').item.json.tipo_busca }}","id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}","n_cnaes_buscados":"={{ $('filtros_supabase').item.json.n_cnaes_buscados }}","range_busca":"={{ $('filtros_supabase').item.json.range_busca }}"},"matchingColumns":[],"schema":[{"id":"_cnaes","displayName":"_cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_uf_filtro","displayName":"_uf_filtro","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_data_limite","displayName":"_data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"_termos","displayName":"_termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_porte_empresa","displayName":"_porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_natureza_juridica","displayName":"_natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_codigo_municipio","displayName":"_codigo_municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"escopo_segmento","displayName":"escopo_segmento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipo_busca","displayName":"tipo_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"id_consulta","displayName":"id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"n_cnaes_buscados","displayName":"n_cnaes_buscados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"range_busca","displayName":"range_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[5072,-560],"id":"c3f050b9-dd1e-4db1-82c1-5c88204d401f","name":"sub_busca_ampla1"},{"parameters":{"content":"## Empresas sem resumo","height":256,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[4384,-384],"id":"a31b4178-be73-4357-8f24-ece35b556e2e","name":"Sticky Note3"},{"parameters":{"workflowId":{"__rl":true,"value":"8wGQEu6ASkKw1oMS","mode":"list","cachedResultUrl":"/workflow/8wGQEu6ASkKw1oMS","cachedResultName":"Envia e-mail"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data.email_fornecedor":"={{ $json.correio_eletronico }}","data.motivo":"=sem_resumo","data.cnpj_basico":"={{ $json.cnpj_basico }}","data.cnpj_dv":"={{ $json.cnpj_dv }}","data.cnpj_ordem":"={{ $json.cnpj_ordem }}","data.id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}"},"matchingColumns":[],"schema":[{"id":"data.email_fornecedor","displayName":"data.email_fornecedor","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.motivo","displayName":"data.motivo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_basico","displayName":"data.cnpj_basico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_dv","displayName":"data.cnpj_dv","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.cnpj_ordem","displayName":"data.cnpj_ordem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data.id_consulta","displayName":"data.id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[4448,-288],"id":"8254a6a8-e009-458f-b0b1-eb13e29c9ac5","name":"Call 'Envia e-mail'1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5a36694f-4a06-4db4-8ba9-0da6d42ffded","leftValue":"={{ $json.resumo_empresa }}","rightValue":"nao_encontrado","operator":{"type":"string","operation":"notEquals"}},{"id":"cccdfdb2-378f-4528-92a8-08876f2e2401","leftValue":"={{ $json.resumo_empresa }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3344,-512],"id":"3c7c5ac3-1118-48d5-bda4-8e1430c08367","name":"tem_resumo?","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1313ca54-9699-477f-a14a-f95ea56a3b1e","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[880,-272],"id":"b613fc61-a3c1-4f6a-8dfc-50919f1eae4d","name":"vazio?"},{"parameters":{"aggregate":"aggregateAllItemData","include":"specifiedFields","fieldsToInclude":"razao_social, nome_fantasia, resumo_empresa, clientes, segmentos_industriais, tipo_fornecedor, especialidades, exemplo_servico, categorias_materais, cnpj_basico, cnpj_ordem, telefone, instagram, email, site","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[3936,-544],"id":"bd733d26-50f0-426c-9a5e-f60979d98403","name":"Aggregate1","alwaysOutputData":true},{"parameters":{"fieldToSplitOut":"todos_os_cnaes","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[1920,-512],"id":"59b17385-6f7b-42d3-8f82-60a713fe10ad","name":"Split Out2","alwaysOutputData":true},{"parameters":{"assignments":{"assignments":[{"id":"cd49782f-f1cd-478e-b6b1-4297ab91adad","name":"concatenated_todos_codigos_cnae","value":"={{ $json.concatenated_todos_os_cnaes.split(\",\") }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2368,-512],"id":"f2a6a933-39ed-45e2-b6f0-2741e1f7ae8f","name":"all_cnaes1","alwaysOutputData":true},{"parameters":{"workflowId":{"__rl":true,"value":"Sd487u8Pqgd9wfPU","mode":"list","cachedResultUrl":"/workflow/Sd487u8Pqgd9wfPU","cachedResultName":"Busca-Ampla"},"workflowInputs":{"mappingMode":"defineBelow","value":{"_cnaes":"={{ $('filtros_supabase').item.json._cnaes }}","_uf_filtro":"={{ $('filtros_supabase').item.json._uf_filtro }}","_data_limite":"={{ $('filtros_supabase').item.json._data_limite }}","_termos":"={{ $('filtros_supabase').item.json._termos }}","_porte_empresa":"={{ $('filtros_supabase').item.json._porte_empresa }}","_natureza_juridica":"={{ $('filtros_supabase').item.json._natureza_juridica }}","_codigo_municipio":"={{ $('filtros_supabase').item.json._codigo_municipio }}","escopo_segmento":"={{ $('filtros_supabase').item.json.escopo_segmento }}","tipo_busca":"={{ $('filtros_supabase').item.json.tipo_busca }}","id_consulta":"={{ $('filtros_supabase').item.json.consulta_id }}","n_cnaes_buscados":"={{ $('filtros_supabase').item.json.n_cnaes_buscados }}","range_busca":"={{ $('filtros_supabase').item.json.range_busca }}"},"matchingColumns":[],"schema":[{"id":"_cnaes","displayName":"_cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_uf_filtro","displayName":"_uf_filtro","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_data_limite","displayName":"_data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"_termos","displayName":"_termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_porte_empresa","displayName":"_porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_natureza_juridica","displayName":"_natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"_codigo_municipio","displayName":"_codigo_municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"},{"id":"escopo_segmento","displayName":"escopo_segmento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipo_busca","displayName":"tipo_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"id_consulta","displayName":"id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"n_cnaes_buscados","displayName":"n_cnaes_buscados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"range_busca","displayName":"range_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1376,-144],"id":"dd3783b9-ea65-4fbc-929c-098a2ce4355a","name":"sub_busca_ampla2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"982024bc-7c66-4c36-86f3-3937d5310db7","leftValue":"={{ $json.isEmpty() }}","rightValue":"={{ true }}","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[96,-176],"id":"be1cd25c-6328-4918-9af5-bec16122e94d","name":"AchouAlgum?3"},{"parameters":{"content":"## Banco de dados:\n- Busca outras Empresas com site que tenham cnaes presentes na lista.","height":320,"width":448,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2304,-656],"id":"6a8603bb-41eb-4e02-9499-ad85d891f947","name":"Sticky Note24"},{"parameters":{"content":"## Processamento:\n- Lista os cnaes das empresas achadas\n- Busca mais empresas que possuam esses cnaes.\n- Filtra apenas as que tenham resumo.","height":400,"width":1824,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1840,-720],"id":"1433cc4d-936c-4b84-b217-2d46cf7b4e33","name":"Sticky Note27"},{"parameters":{"content":"## Processamento:\n- Itera pelas empresas encontradas.\n- Gera análises sobre a compatibilidade das empresas para o escopo atual.\n- Gera uma nota de compatibilidade.\n-- Se a nota for 30+ insere no banco e mostra no front.","height":592,"width":688,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[3680,-944],"id":"ce5e64d5-37b1-493d-84fa-9475299c13c2","name":"Sticky Note29"},{"parameters":{"content":"## Processamento:\n- Caso não encontre empresas com site, inicia uma busca mais ampla.\n- Varia a busca com base no tipo de consulta","height":496,"width":400,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1232,-480],"id":"08aadb60-8076-4dc0-85b3-1c5f63d63a1e","name":"Sticky Note30"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8999803c-322a-42ea-825d-6c946bd6feba","leftValue":"={{ $('filtros_supabase').item.json.tipo_busca }}","rightValue":"especifica","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1376,-304],"id":"f4eb74a0-7185-41b4-9584-75c5c7ad42b9","name":"tipo_de_consulta1"},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"get","tableId":"consultas","filters":{"conditions":[{"keyName":"id","keyValue":"={{ $('filtros_supabase').item.json.consulta_id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[4240,-656],"id":"823e78d6-aee4-43e1-9dea-257c46ace046","name":"get_result1","executeOnce":true,"alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"content":"## Regra de Negócio:\n- Caso a consulta já tenha pelo menos 4 resultados 70+, ela é marcada como concluída.\n- Caso contrário, uma busca mais ampla é iniciada.\n\n","height":384,"width":864,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[4384,-784],"id":"663bea0a-b88e-45ef-a538-d976b7d1f899","name":"Sticky Note2"},{"parameters":{"fieldToSplitOut":"resultados","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[4400,-656],"id":"379f00b4-2b9c-4741-86cb-be0a0065cca2","name":"Split Out3","alwaysOutputData":true},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"item.nota"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[4720,-656],"id":"be643e45-43c0-478c-9c8f-bb8e055ca668","name":"Aggregate3","alwaysOutputData":true},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.busca_empresas_processadas1($1::text[], $2::text[], $3::text, $4::text[], $5::text[], $6::text[], $7::text, $8::text, $9::jsonb);\n","options":{"connectionTimeout":500,"queryReplacement":"={{\n[\n  // $1: _cnaes (text[])\n  (\n    typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string'\n      ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes)\n      : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes)\n  ),\n\n  // $2: _uf_filtro (text[])\n  (\n    typeof $('filtros_supabase').first().json._uf_filtro === 'string'\n      ? JSON.parse($('filtros_supabase').first().json._uf_filtro)\n      : $('filtros_supabase').first().json._uf_filtro\n  ),\n\n  // $3: _data_limite (text)\n  String($('filtros_supabase').first().json._data_limite || ''),\n\n  // $4: _termos (text[])\n  (\n    typeof $('filtros_supabase').first().json._termos === 'string'\n      ? JSON.parse($('filtros_supabase').first().json._termos)\n      : $('filtros_supabase').first().json._termos\n  ),\n\n  // $5: _porte_empresa (text[])\n  (\n    typeof $('filtros_supabase').first().json._porte_empresa === 'string'\n      ? JSON.parse($('filtros_supabase').first().json._porte_empresa)\n      : $('filtros_supabase').first().json._porte_empresa\n  ),\n\n  // $6: _natureza_juridica (text[])\n  (\n    typeof $('filtros_supabase').first().json._natureza_juridica === 'string'\n      ? JSON.parse($('filtros_supabase').first().json._natureza_juridica)\n      : $('filtros_supabase').first().json._natureza_juridica\n  ),\n\n  // $7: escopo_segmento (text)\n  String($('filtros_supabase').first().json.escopo_segmento || ''),\n\n  // $8: tipo_busca (text)\n  String($('filtros_supabase').first().json.tipo_busca || ''),\n\n  // $9: controles (jsonb)\n  JSON.stringify({\n    _limite_retorno: Number($('filtros_supabase').first().json._limite_retorno ?? 50),\n    _min_cnaes_distintos_interesse: Number($('filtros_supabase').first().json._min_cnaes_distintos_interesse ?? 1)\n  })\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2592,-512],"id":"42730ca4-d1d0-4d24-8d86-4a067cd4fe44","name":"busca_filtro_site3","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"batchSize":10,"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[3760,-560],"id":"2174d60e-00fc-4df5-81c6-6db6102bbc47","name":"Loop Over batch "},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"todos_os_cnaes"}]},"fieldsToSplitBy":",","options":{"outputFormat":"singleItem"}},"type":"n8n-nodes-base.summarize","typeVersion":1.1,"position":[2144,-512],"id":"dadbb616-0309-497e-a7ad-0f970fbe88fa","name":"concatenate_cnaes1","alwaysOutputData":true},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"update","tableId":"consultas","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('get_result1').item.json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"concluida"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5056,-736],"id":"ebd1109f-44f0-4294-906f-7e0618c2ce45","name":"concluído1","credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"content":"## Observar qual o valor ideal para esse wait.","height":256,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[3968,-784],"id":"5e731c0b-11fa-475a-a1a4-83702ecc64e3","name":"Sticky Note4"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"982024bc-7c66-4c36-86f3-3937d5310db7","leftValue":"={{ $json.isEmpty() }}","rightValue":"={{ true }}","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[464,-112],"id":"a9b7fe87-1402-4c61-a000-9347ef7d4726","name":"AchouAlgumAgora?1"},{"parameters":{"content":"## Tratativa\n- Realiza uma segunda busca sem aplicar termos.","height":336,"width":576},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[64,-288],"id":"03bd2714-7d17-48db-a1d2-a31300c2791c","name":"Sticky Note37"},{"parameters":{"operation":"push","list":"={{ $('filtros_supabase').item.json.consulta_id }}","messageData":"={{ $json.razao_social || $runIndex.toString() }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1088,-288],"id":"09095543-6cac-491f-8674-8addaaaa6c58","name":"put1","alwaysOutputData":true,"credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"content":"## Tratativa\n- Filtra cnpjs que já apareceram em consultas anteriores.\n- Adiciona os cnpjs processados em uma fila.","height":288,"width":560},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[656,-416],"id":"70a6a320-3bb3-4a16-bc0e-eee83ab5f43d","name":"Sticky Note38"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"04588737-d727-48f6-b126-0f5b7441ab45","leftValue":"={{ $('get1').item.json.propertyName }}","rightValue":"={{ $('AchouAlgum?3').item.json.razao_social }}","operator":{"type":"array","operation":"notContains","rightType":"any"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[688,-272],"id":"200120f8-26f1-42ae-92e9-d987559bfaeb","name":"cnpj_ja_usado1","alwaysOutputData":true},{"parameters":{"url":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/74b8dbdb-2fdd-44b5-a71e-88750862316f","sendBody":true,"bodyParameters":{"parameters":[{"name":"data","value":"={{ $json.data }}"},{"name":"filtro_supabase","value":"={{ $('filtros_supabase').item.json.escopo_segmento }}"},{"name":"consulta_id","value":"={{ $('filtros_supabase').item.json.consulta_id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4128,-544],"id":"e10b9e7a-58cc-42f3-bdce-28c2c2c078c3","name":"processa_empresa_sub1","onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3d0a4d93-d2a9-4518-a3e0-432ea2fce1bf","leftValue":"={{ $json }}","rightValue":"","operator":{"type":"object","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3520,-640],"id":"06362e51-4280-49e3-8e68-569fa5169e1d","name":"vazio?1"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2784,-512],"id":"65cff04d-e237-47e0-86dc-dc55bfbddf54","name":"Merge"},{"parameters":{"compare":"selectedFields","fieldsToCompare":"cnpj_basico, cnpj_ordem, cnpj_dv","options":{}},"type":"n8n-nodes-base.removeDuplicates","typeVersion":2,"position":[3168,-512],"id":"64792577-7954-473e-b47e-0bb03aefa025","name":"Remove Duplicates"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2b232b91-51e5-4d02-b070-d31463e3eada","leftValue":"={{ $json.cnpj_basico }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"f4f56071-edb4-4894-ae3b-d58480d74990","leftValue":"={{ $json.cnpj_ordem }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"d6b9817c-132d-4622-a432-fb033c631640","leftValue":"={{ $json.cnpj_dv }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[2992,-512],"id":"2375827f-4ee8-480f-8ac4-904cdf8d921a","name":"Filter"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM cnpj_db.v2_get_estabelecimentos_filtrados_avancado_com_site_sem_termos($1, $2, $3, $4, $5, $6, $7, $8);\n","options":{"connectionTimeout":1000,"queryReplacement":"={{\n[\n  (typeof ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) === 'string') ? JSON.parse($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes) : ($json.concatenated_todos_codigos_cnae || $('filtros_supabase').first().json._cnaes),\n\n  (typeof $('filtros_supabase').first().json._uf_filtro === 'string') ? JSON.parse($('filtros_supabase').first().json._uf_filtro) : $('filtros_supabase').first().json._uf_filtro,\n\n  $('filtros_supabase').first().json._data_limite,\n\n  (typeof $('filtros_supabase').first().json._porte_empresa === 'string') ? JSON.parse($('filtros_supabase').first().json._porte_empresa) : $('filtros_supabase').first().json._porte_empresa,\n\n  (typeof $('filtros_supabase').first().json._natureza_juridica === 'string') ? JSON.parse($('filtros_supabase').first().json._natureza_juridica) : $('filtros_supabase').first().json._natureza_juridica,\n\n  (typeof $('filtros_supabase').first().json._codigo_municipio === 'string') ?JSON.parse($('filtros_supabase').first().json._codigo_municipio) : $('filtros_supabase').first().json._codigo_municipio,\n\n$('filtros_supabase').item.json.range_busca,\n\n$('filtros_supabase').item.json.n_cnaes_buscados.toNumber()\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[288,-112],"id":"e860e329-4c4e-4720-97c7-5c14044486bd","name":"V2_get_estabelecimentos_com_site_sem_termos","alwaysOutputData":true,"credentials":{"postgres":{"id":"RYnJHwRNP94saMdt","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fc20e47d-3914-48ba-824e-b88ef182ac5d","leftValue":"={{ $json.item.nota }}","rightValue":80,"operator":{"type":"number","operation":"gte"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[4560,-656],"id":"74dda6bc-5be0-4276-9912-ad5a25b3f9bc","name":"nota é 80 ou mais","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9cfd503a-d6fe-47a9-80f9-9da528338ebe","leftValue":"={{ $json.nota.length }}","rightValue":4,"operator":{"type":"number","operation":"gte"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4880,-656],"id":"b7e0c807-2520-49ec-8766-421e177c4387","name":"resultados>minimo_aceitavel"},{"parameters":{"assignments":{"assignments":[{"id":"35e53e9a-03d0-43dd-8f70-8cd9be659c44","name":"todos_os_cnaes","value":"={{ $json.cnae_fiscal_secundaria.split(\",\").append($json.cnae_fiscal) }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1680,-448],"id":"a55f4797-0c2d-4ff9-9119-3add378ef669","name":"Edit Fields"}],"connections":{"filtros_supabase":{"main":[[{"node":"get1","type":"main","index":0}]]},"get1":{"main":[[{"node":"V2-busca_filtrada_empresas_processadas","type":"main","index":0}]]},"wait_2min":{"main":[[{"node":"get_result1","type":"main","index":0}]]},"tem_resumo?":{"main":[[{"node":"vazio?1","type":"main","index":0}],[{"node":"Call 'Envia e-mail'1","type":"main","index":0}]]},"vazio?":{"main":[[{"node":"sub_busca_ampla2","type":"main","index":0}],[{"node":"put1","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"processa_empresa_sub1","type":"main","index":0}]]},"Split Out2":{"main":[[{"node":"concatenate_cnaes1","type":"main","index":0}]]},"all_cnaes1":{"main":[[{"node":"busca_filtro_site3","type":"main","index":0}]]},"AchouAlgum?3":{"main":[[{"node":"cnpj_ja_usado1","type":"main","index":0}],[{"node":"V2_get_estabelecimentos_com_site_sem_termos","type":"main","index":0}]]},"tipo_de_consulta1":{"main":[[{"node":"Merge","type":"main","index":1},{"node":"Edit Fields","type":"main","index":0}],[{"node":"tem_resumo?","type":"main","index":0}]]},"get_result1":{"main":[[{"node":"Split Out3","type":"main","index":0}]]},"Split Out3":{"main":[[{"node":"nota é 80 ou mais","type":"main","index":0}]]},"Aggregate3":{"main":[[{"node":"resultados>minimo_aceitavel","type":"main","index":0}]]},"busca_filtro_site3":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Loop Over batch ":{"main":[[{"node":"wait_2min","type":"main","index":0}],[{"node":"Aggregate1","type":"main","index":0}]]},"concatenate_cnaes1":{"main":[[{"node":"all_cnaes1","type":"main","index":0}]]},"AchouAlgumAgora?1":{"main":[[{"node":"cnpj_ja_usado1","type":"main","index":0}],[{"node":"sub_busca_ampla2","type":"main","index":0}]]},"put1":{"main":[[{"node":"tipo_de_consulta1","type":"main","index":0}]]},"cnpj_ja_usado1":{"main":[[{"node":"vazio?","type":"main","index":0}]]},"processa_empresa_sub1":{"main":[[{"node":"Loop Over batch ","type":"main","index":0}]]},"vazio?1":{"main":[[{"node":"sub_busca_ampla1","type":"main","index":0}],[{"node":"Loop Over batch ","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Filter","type":"main","index":0}]]},"Remove Duplicates":{"main":[[{"node":"tem_resumo?","type":"main","index":0}]]},"Filter":{"main":[[{"node":"Remove Duplicates","type":"main","index":0}]]},"V2_get_estabelecimentos_com_site_sem_termos":{"main":[[{"node":"AchouAlgumAgora?1","type":"main","index":0}]]},"nota é 80 ou mais":{"main":[[{"node":"Aggregate3","type":"main","index":0}]]},"resultados>minimo_aceitavel":{"main":[[{"node":"concluído1","type":"main","index":0}],[{"node":"sub_busca_ampla1","type":"main","index":0}]]},"V2-busca_filtrada_empresas_processadas":{"main":[[{"node":"AchouAlgum?3","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Split Out2","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"filtros_supabase":[{"json":{"_cnaes":["4321500","4322301","4322302","4322303","4330404","4330499","4399103","7112000","8211300"],"_uf_filtro":["RS"],"_data_limite":"20240101","_termos":["excel engenharia","manutencao predial","manutenção predial","engenharia de manutencao","engenharia de manutenção","SIMP","Porto Alegre","CREA-RS"],"_porte_empresa":["00","01","03","05"],"_natureza_juridica":["2062"],"escopo_segmento":"Engenharia de manutenção predial com sistema SIMP, foco em manutenção preventiva, corretiva e de urgência em Porto Alegre e região.","tipo_busca":"generalista","consulta_id":"58ee5c7f-522b-4ff6-842b-c042aec2fb48","n_cnaes_buscados":"2","range_busca":1500,"_limite_retorno":1,"_min_cnaes_distintos_interesse":1}}]},"versionId":"aa4629a5-1fe2-495c-869d-bf97ffdbd265","triggerCount":0,"shared":[{"updatedAt":"2025-12-04T15:13:57.378Z","createdAt":"2025-12-04T15:13:57.378Z","role":"workflow:owner","workflowId":"j1Ce5yGwjXAmS8RT","projectId":"jk0yZKautC5L7CBp"}],"tags":[]}