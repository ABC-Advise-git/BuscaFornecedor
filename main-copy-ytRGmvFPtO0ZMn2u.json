{"updatedAt":"2025-12-08T20:27:19.098Z","createdAt":"2025-10-14T19:47:13.071Z","id":"ytRGmvFPtO0ZMn2u","name":"Main-copy","active":true,"isArchived":false,"nodes":[{"parameters":{"mode":"combine","combineBy":"combineByPosition","numberInputs":4,"options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-64,832],"id":"e82da788-4100-4379-b177-5d29ded50bd6","name":"Merge"},{"parameters":{"jsonSchemaExample":"{\n  \"termos\":[\"eng\",\"const\"],\n  \"Justificativa\":\"Justificativa\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-304,928],"id":"49ce3295-de02-4069-b63c-787be5b444f2","name":"Structured Output Parser2"},{"parameters":{"promptType":"define","text":"=Segmento: {{ $json.segmento }}\nProjeto: {{ $json.descricao }}\nExemplo: {{ $json.cnpjs }}","hasOutputParser":true,"options":{"systemMessage":"=Papel: Você é um agente gerador de termos ou partes de termos que podem estar contidos na Razão Social ou Nome Fantasia de empresas de um segmento. \n\n\nObjetivo: Retornar termos ou parte de um termo que possa estar contido em razao social ou nome fantasia de empresas de um segmento.\n\nTarefa: Você irá receber as variáveis Segmento, Projeto e exemplo de Nome Fantasia de empresas similares, utilize essas informações para montar 5 possíveis termos de razão social ou nome fantasia.\n\nPassos:\n1. Avaliar segmento de fornecedor e escopo do projeto.\n2. Pensar em uma estratégia de elaboração de termos que seja abrangente o suficiente para captar empresas e especifico o suficiente para não pegar empresas que sejam totalmente fora dos segmento e tipo de projeto.\n3. Crie abreviações inteligentes dos termos, exemplo: ao invés de Construtora utilize constru. \n4.Sempre utilize os termos com letra minusculas. \n5. Retornar uma lista dos 20 principais termos e uma justificativa para eles em formato JSON. \n\nFormato de Retorno: \nJSON\n{\n  \"termos\":[\"eng\",\"const\"],\n  \"Justificativa\":\"Justificativa\"\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-512,784],"id":"041ed2bf-f844-44f7-b45c-ab3531085c23","name":"termos_razao_social"},{"parameters":{"assignments":{"assignments":[{"id":"6a642483-615a-4845-a6ab-85d68be0b528","name":"_cnaes","value":"={{ $json.output.cnaes_especificos.lista_cnaes }}","type":"array"},{"id":"c19781ca-94a5-4b69-8769-42cd1760e6e4","name":"_uf_filtro","value":"={{ $json.ufs_unicas ||  $json.ufs_selecionadas}}","type":"array"},{"id":"7ae93f81-b936-4f53-a142-9825c69dd216","name":"_data_limite","value":"={{ $('get_ano_limite').item.json.quantidade_anos }}","type":"string"},{"id":"46d42ef3-766f-4875-b66d-76ad9bc68aa5","name":"_termos","value":"={{ $json.output.termos }}","type":"array"},{"id":"04c655fa-7d0f-4dda-99c8-fbf13bb7d6b7","name":"_porte_empresa","value":"=[\"00\",\"01\",\"05\",\"03\"]","type":"array"},{"id":"e864e0a0-f33b-4a16-9294-e4836b5b7151","name":"_natureza_juridica","value":"=[\"2062\"]","type":"array"},{"id":"731d5c01-3624-467e-a792-4e37fd015242","name":"_codigo_municipio","value":"={{ $json.codigo }}","type":"array"},{"id":"3f5d08af-bf0f-41f4-b3b9-a74b465a080c","name":"escopo_segmento","value":"={{ $('set_data').item.json.segmento }}, {{ $('set_data').item.json.descricao }}","type":"string"},{"id":"71c38000-701d-4b1d-88b7-bd27a98101cc","name":"body.consultaId","value":"={{ $('Webhook').item.json.body.consultaId }}","type":"string"},{"id":"c342f437-b546-480e-bd31-aa0e30e9fef4","name":"range_busca","value":"={{ \n  ({\n    normal: 400,\n    avancado: 1000,\n    especial: 1500\n  })[$('Webhook').item.json.body.tierBusca] || 0\n}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[160,864],"id":"9bb642ae-1ca8-4cba-8ea4-d5cdffb3b907","name":"filtros_supabase_especifica"},{"parameters":{"content":"## Busca Especifica\n- Utiliza a lista de cnaes específicos.\n- Passa o limite de 1 cnae para a consulta no banco de dados.","height":304,"width":1296,"color":7},"type":"n8n-nodes-base.stickyNote","position":[128,736],"typeVersion":1,"id":"835d909d-5120-4836-89a7-e7b71c600d08","name":"Sticky Note3"},{"parameters":{"content":"## Busca Mista\n- Utiliza a lista de cnaes específicos + lista de cnaes mistos.\n- Passa o limite de 2 cnaes para a consulta no banco de dados.","height":304,"width":768,"color":7},"type":"n8n-nodes-base.stickyNote","position":[1552,736],"typeVersion":1,"id":"1094914f-d138-43c7-8ccf-cc47745eccf7","name":"Sticky Note4"},{"parameters":{"content":"## Busca Generalista\n- Utiliza a lista de cnaes específicos + lista de cnaes mistos + lista de cnaes generalistas.\n- Passa o limite de 2 cnaes para a consulta no banco de dados.","height":304,"width":624,"color":7},"type":"n8n-nodes-base.stickyNote","position":[2336,736],"typeVersion":1,"id":"5edc3632-14d4-4090-bfe7-dce97eef2f7f","name":"Sticky Note5"},{"parameters":{"httpMethod":"POST","path":"cenario-teste","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-3456,896],"id":"bb18f4e2-4f8c-47d8-8903-02c425a4b928","name":"Webhook","webhookId":"1bdbd2c9-bf7e-47d8-b1b7-f00d17efe51b"},{"parameters":{"workflowId":{"__rl":true,"value":"fjbWmn7b1HzCg5tE","mode":"list","cachedResultUrl":"/workflow/fjbWmn7b1HzCg5tE","cachedResultName":"Busca-Site copy"},"workflowInputs":{"mappingMode":"defineBelow","value":{"_cnaes":"={{ $json._cnaes }}","_uf_filtro":"={{ $json._uf_filtro }}","_data_limite":"={{ $json._data_limite }}","_termos":"={{ $json._termos }}","_porte_empresa":"={{ $json._porte_empresa }}","_natureza_juridica":"={{ $json._natureza_juridica }}","_codigo_municipio":"={{ $json._codigo_municipio }}","escopo_segmento":"={{ $json.escopo_segmento }}","tipo_busca":"=especifica","consulta_id":"={{ $('Webhook').item.json.body.consultaId}}","n_cnaes_buscados":"1"},"matchingColumns":[],"schema":[{"id":"_cnaes","displayName":"_cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_uf_filtro","displayName":"_uf_filtro","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_data_limite","displayName":"_data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"_termos","displayName":"_termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_porte_empresa","displayName":"_porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_natureza_juridica","displayName":"_natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_codigo_municipio","displayName":"_codigo_municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"escopo_segmento","displayName":"escopo_segmento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"tipo_busca","displayName":"tipo_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"consulta_id","displayName":"consulta_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"n_cnaes_buscados","displayName":"n_cnaes_buscados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[736,864],"id":"ed8de900-9059-4111-8282-9a7845939002","name":"sub_busca_especifica","alwaysOutputData":true},{"parameters":{"workflowId":{"__rl":true,"value":"fjbWmn7b1HzCg5tE","mode":"list","cachedResultUrl":"/workflow/fjbWmn7b1HzCg5tE","cachedResultName":"Busca-Site copy"},"workflowInputs":{"mappingMode":"defineBelow","value":{"_cnaes":"={{ $('cnae').item.json.output.cnaes_mistos.lista_cnaes.concat($('cnae').item.json.output.cnaes_especificos.lista_cnaes) }}","_uf_filtro":"={{ $('filtros_supabase_especifica').item.json._uf_filtro }}","_data_limite":"={{ $('filtros_supabase_especifica').item.json._data_limite }}","_termos":"={{ $('filtros_supabase_especifica').item.json._termos }}","_porte_empresa":"={{ $('filtros_supabase_especifica').item.json._porte_empresa }}","_natureza_juridica":"={{ $('filtros_supabase_especifica').item.json._natureza_juridica }}","_codigo_municipio":"={{ $('filtros_supabase_especifica').item.json._codigo_municipio }}","escopo_segmento":"={{ $('filtros_supabase_especifica').item.json.escopo_segmento }}","tipo_busca":"=mista","consulta_id":"={{ $('Webhook').item.json.body.consultaId }}","n_cnaes_buscados":"2"},"matchingColumns":[],"schema":[{"id":"_cnaes","displayName":"_cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_uf_filtro","displayName":"_uf_filtro","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_data_limite","displayName":"_data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"_termos","displayName":"_termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_porte_empresa","displayName":"_porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_natureza_juridica","displayName":"_natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_codigo_municipio","displayName":"_codigo_municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"escopo_segmento","displayName":"escopo_segmento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"tipo_busca","displayName":"tipo_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"consulta_id","displayName":"consulta_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"n_cnaes_buscados","displayName":"n_cnaes_buscados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1600,880],"id":"6eab4964-3db9-4f88-9322-a7518b5b01bb","name":"sub_busca_mista","alwaysOutputData":true},{"parameters":{"workflowId":{"__rl":true,"value":"fjbWmn7b1HzCg5tE","mode":"list","cachedResultUrl":"/workflow/fjbWmn7b1HzCg5tE","cachedResultName":"Busca-Site copy"},"workflowInputs":{"mappingMode":"defineBelow","value":{"_cnaes":"={{ $('cnae').item.json.output.cnaes_generalistas.lista_cnaes.concat($('cnae').item.json.output.cnaes_mistos.lista_cnaes).concat($('cnae').item.json.output.cnaes_especificos.lista_cnaes)}}","_uf_filtro":"={{ $('filtros_supabase_especifica').item.json._uf_filtro }}","_data_limite":"={{ $('filtros_supabase_especifica').item.json._data_limite }}","_termos":"={{ $('filtros_supabase_especifica').item.json._termos }}","_porte_empresa":"={{ $('filtros_supabase_especifica').item.json._porte_empresa }}","_natureza_juridica":"={{ $('filtros_supabase_especifica').item.json._natureza_juridica }}","_codigo_municipio":"={{ $('filtros_supabase_especifica').item.json._codigo_municipio }}","escopo_segmento":"={{ $('filtros_supabase_especifica').item.json.escopo_segmento }}","tipo_busca":"=generalista","consulta_id":"={{ $('Webhook').item.json.body.consultaId }}","n_cnaes_buscados":"2"},"matchingColumns":[],"schema":[{"id":"_cnaes","displayName":"_cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_uf_filtro","displayName":"_uf_filtro","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_data_limite","displayName":"_data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"_termos","displayName":"_termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_porte_empresa","displayName":"_porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_natureza_juridica","displayName":"_natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"_codigo_municipio","displayName":"_codigo_municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false},{"id":"escopo_segmento","displayName":"escopo_segmento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"tipo_busca","displayName":"tipo_busca","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"consulta_id","displayName":"consulta_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"n_cnaes_buscados","displayName":"n_cnaes_buscados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[2384,880],"id":"3435de0b-64f1-4464-ac72-f7366220df11","name":"sub_busca_geral","alwaysOutputData":true},{"parameters":{"assignments":{"assignments":[{"id":"9a3fb15e-d23e-4170-a9aa-919f72b89b43","name":"consultaId","value":"={{ $('Webhook').item.json.body.consultaId }}","type":"string"},{"id":"1c8480b4-54ef-4915-82fc-42f33fba735f","name":"descricao","value":"={{ $('Webhook').item.json.body.parametros.descricao }}","type":"string"},{"id":"8eeeae95-c339-42d1-8f9b-34130e223c17","name":"segmento","value":"={{ $('Webhook').item.json.body.parametros.segmento }}","type":"string"},{"id":"ca3d3b97-99a4-4aeb-af8d-2bd29f4e2a1b","name":"tipo_busca","value":"={{ $('Webhook').item.json.body.parametros.tipo_busca }}","type":"string"},{"id":"b0b12974-635a-40b5-92b9-521b768d87c3","name":"ufs_selecionadas","value":"={{ $('Webhook').item.json.body.parametros.ufs_selecionadas }}","type":"array"},{"id":"3eda9636-b54b-40d7-9e84-a07531cee371","name":"tempo_minimo_empresa","value":"={{ $('Webhook').item.json.body.parametros.tempo_minimo_empresa === 'Não especificado' ? 1 : Number($('Webhook').item.json.body.parametros.tempo_minimo_empresa) }}\n","type":"string"},{"id":"0c560477-bf1c-4bfe-94bf-6b90679ad0c6","name":"cidade_origem","value":"={{ $('Webhook').item.json.body.parametros.cidade_origem }}","type":"string"},{"id":"6c7347cd-dff7-4084-ae18-1801814cd0f3","name":"raio_km","value":"={{ $json.body.parametros.raio_km === 'Não especificado' ? 200 : $json.body.parametros.raio_km }}\n","type":"string"},{"id":"f4b02ac4-bd91-4577-9303-fefcfb66c238","name":"cnpjs","value":"={{ $json.empresa ? $json.empresa.toJsonString() : '' }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1216,896],"id":"ea3d07be-8c44-4a9f-bcaf-34ec4cc19832","name":"set_data"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.tipo_busca }}","rightValue":"=uf","operator":{"type":"string","operation":"equals"},"id":"5ae05424-95d0-4255-9143-db06a0b77429"}],"combinator":"and"},"renameOutput":true,"outputKey":"busca_uf"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"df4e5915-07cc-4afb-99a3-2ff13636335c","leftValue":"={{ $json.tipo_busca }}","rightValue":"city","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"busca_cidade"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[-592,1488],"id":"bdffd915-9ac9-421b-a81f-03953c80f871","name":"tipo_busca"},{"parameters":{"assignments":{"assignments":[{"id":"f329918a-6399-4baf-aae7-a49c5edbe9f9","name":"quantidade_anos","value":"={{\n(() => {\n  const anos = parseInt($json.tempo_minimo_empresa);\n  const anoLimite = new Date().getFullYear() - anos;\n  return `${anoLimite}0101`;\n})()\n}}\n","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-80,624],"id":"42f26397-353f-4e67-a52e-636cc863546d","name":"get_ano_limite"},{"parameters":{"fieldToSplitOut":"nearby_cities","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-144,1488],"id":"b68025e9-1e5f-47b4-a2eb-0b72422b23f6","name":"Split Out"},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"codigo"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[736,1232],"id":"bf255a04-477f-444f-8a09-978364fa838a","name":"Aggregate"},{"parameters":{"assignments":{"assignments":[{"id":"3b606833-d2df-4174-a8f3-8bd57c8fffcf","name":"cidades","value":"={{ $('Split Out').item.json.name.normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\").replace(/~/g, \"\").toUpperCase() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[96,1232],"id":"af83f6a8-2f24-421c-a02c-f889f132d7e2","name":"lista_cidades"},{"parameters":{"useCustomSchema":true,"schema":"cnpj_db","operation":"get","tableId":"municipio","filters":{"conditions":[{"keyName":"descricao","keyValue":"={{ $json.cidades }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[512,1232],"id":"2ef94cd9-ef1e-45be-a545-7018e3d91c17","name":"Get_codes","credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[912,1312],"id":"2a684520-fafb-4208-bf92-fda2b4688525","name":"Merge1"},{"parameters":{"jsCode":"// Mapa de código IBGE → sigla\nconst ufMap = {\n  \"12\": \"AC\", \"27\": \"AL\", \"13\": \"AM\", \"16\": \"AP\", \"29\": \"BA\",\n  \"23\": \"CE\", \"53\": \"DF\", \"32\": \"ES\", \"52\": \"GO\", \"21\": \"MA\",\n  \"31\": \"MG\", \"50\": \"MS\", \"51\": \"MT\", \"15\": \"PA\", \"25\": \"PB\",\n  \"26\": \"PE\", \"22\": \"PI\", \"41\": \"PR\", \"33\": \"RJ\", \"24\": \"RN\",\n  \"43\": \"RS\", \"11\": \"RO\", \"14\": \"RR\", \"42\": \"SC\", \"28\": \"SE\",\n  \"35\": \"SP\", \"17\": \"TO\"\n};\n\n// Pega todos os items recebidos\nconst items = $input.all();\n\n// Extrai as UFs (convertendo código → sigla)\nconst ufs = items\n  .map(item => ufMap[item.json.uf])\n  .filter(Boolean); // remove undefined\n\n// Remove duplicados\nconst ufsUnicas = [...new Set(ufs)];\n\n// Retorna em um único item JSON\nreturn [\n  {\n    json: {\n      ufs_unicas: ufsUnicas\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[240,1552],"id":"290964f7-2927-4b3b-9653-47dd04afb68a","name":"set_ufs_unicas"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c51e1c96-4523-4ce8-9cd6-bfcfa96d7c32","leftValue":"={{ $json.status }}","rightValue":"concluida","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1968,880],"id":"da08faf2-50c1-49ac-a8bb-41f09712ff0b","name":"concluido?-2"},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"update","tableId":"consultas","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('Webhook').item.json.body.consultaId }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"concluida"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3600,736],"id":"226bee53-399d-4364-b856-a7a25f4dceab","name":"conclui_busca","executeOnce":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"content":"## IA: Exemplos de termos para razão social.\n- Analisa: \n-- segmento\n-- projeto \n-- exemplos de CNPJ\n- Baseado nisso gera uma lista de possíveis termos que podem estar presentes na razão social de fornecedores.","height":528,"width":448,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-624,544],"id":"b2c76c66-304c-44c9-9958-ca1a2c0ed4a2","name":"Sticky Note30"},{"parameters":{"content":"## IA: Exemplos de cnaes.\n- Analisa: \n-- segmento\n-- projeto \n-- exemplos de CNPJ\n- Baseado nisso gera uma lista de possíveis cnaes que podem estar presentes em forncedores.","height":816,"width":464,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1104,688],"id":"fbad7295-80c9-4252-be48-368c56ac48ad","name":"Sticky Note31"},{"parameters":{"content":"## Calcula data limite","height":208,"width":246,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-160,560],"id":"4bf2af9d-4923-4ef5-b01b-4df604f7da72","name":"Sticky Note28"},{"parameters":{"content":"## Processamento: Encontra cidades dentro de um raio.\n- Atende busca por raio e busca por UF.\n### Busca por raio:\n- Leva em conta uma cidade como ponto de partida.\n- Consulta na api as cidades dentro daquele raio.\n- Lista cidades e UFs presente no raio.\n### Busca por UF:\n- Retorna a lista de UFs especificadas na consulta.","height":608,"width":1702,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-624,1104],"id":"23a923b5-77c5-4271-aa4b-e9fa56720d6b","name":"Sticky Note29"},{"parameters":{"content":"## API própria:\n- Encontra cidades dentro de um raio pré-definido","height":256,"color":6},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-432,1376],"id":"dbc8bd65-0767-45a6-8a79-0389339fce55","name":"Sticky Note32"},{"parameters":{"url":"https://api-busca-cidades-buscafornecedor.up.railway.app/api/cities/nearby","sendQuery":true,"queryParameters":{"parameters":[{"name":"city_name","value":"={{ $json.cidade_origem.replace(/\\s*-\\s*[A-Z]{2}$/, '') }}"},{"name":"radius_km","value":"={{ $json.raio_km.toNumber()+1 }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-368,1488],"id":"2c1dd822-2231-4359-987c-226fd747a3d9","name":"acha_cidade"},{"parameters":{"content":"## Regra de Negócio: Tipos de Busca.\n\n- Separa as buscas em diferentes parâmetros.\n- Caso sejam encontrados 4 ou mais fornecedores com 70+ de nota a consulta é concluída.\n- Caso a consulta não seja concluída antes ela é concluída ao fim da busca mais geral.\n","height":512,"width":2896,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[112,560],"id":"f03d35a5-f3d0-4fe8-9a9e-cd243a23182d","name":"Sticky Note1"},{"parameters":{"content":"## Busca códigos para as cidades no supabase:","height":272,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[432,1120],"id":"e4c17486-4204-470e-8d4a-6b48f9c76945","name":"Sticky Note33"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"15299fb0-fbeb-4c7c-8614-b89fea9c3413","leftValue":"={{ $json.body.parametros.cnpjs_existentes }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2976,880],"id":"3fca574c-8445-45d7-9429-a089e8b13eae","name":"cnpj_vazio"},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"get","tableId":"consultas","filters":{"conditions":[{"keyName":"id","keyValue":"={{ $('Webhook').item.json.body.consultaId}}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1776,880],"id":"461cad80-272a-4bf9-9bb8-b44e922b1805","name":"get_status_consulta1","alwaysOutputData":false,"executeOnce":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}},"onError":"continueErrorOutput"},{"parameters":{"fieldToSplitOut":"cnpjs_formatados","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-2368,976],"id":"becdc090-b87a-44c6-bafb-9679c99f8003","name":"Split Out1"},{"parameters":{"jsCode":"// --- Entrada --------------------------------------------------\nconst input = $input.first().json.body?.parametros?.cnpjs_existentes || \"\";\n\n// --- Captura todos os CNPJs, formatados ou não ----------------\n// Pega qualquer padrão de 14 dígitos, com ou sem pontos, barras, traços\nconst candidatos = (input.match(/\\d{2}\\.?\\d{3}\\.?\\d{3}\\/?\\d{4}-?\\d{2}/g) || [])\n  .map(c => c.replace(/\\D/g, '')); // remove tudo que não é dígito\n\n// Caso também existam CNPJs sem formatação misturados no texto (14 dígitos corridos)\nconst candidatosExtras = (input.match(/\\b\\d{14}\\b/g) || [])\n  .map(c => c.replace(/\\D/g, ''));\n\n// Une e remove duplicados\nconst todos = [...new Set([...candidatos, ...candidatosExtras])];\n\n// --- Função de validação do CNPJ -------------------------------\nfunction validarCNPJ(cnpj) {\n  if (!cnpj || cnpj.length !== 14) return false;\n  if (/^(\\d)\\1+$/.test(cnpj)) return false; // ignora repetidos\n\n  let tamanho = cnpj.length - 2;\n  let numeros = cnpj.substring(0, tamanho);\n  let digitos = cnpj.substring(tamanho);\n  let soma = 0;\n  let pos = tamanho - 7;\n\n  for (let i = tamanho; i >= 1; i--) {\n    soma += numeros.charAt(tamanho - i) * pos--;\n    if (pos < 2) pos = 9;\n  }\n\n  let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);\n  if (resultado != digitos.charAt(0)) return false;\n\n  tamanho++;\n  numeros = cnpj.substring(0, tamanho);\n  soma = 0;\n  pos = tamanho - 7;\n\n  for (let i = tamanho; i >= 1; i--) {\n    soma += numeros.charAt(tamanho - i) * pos--;\n    if (pos < 2) pos = 9;\n  }\n\n  resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);\n  return resultado == digitos.charAt(1);\n}\n\n// --- Formata o CNPJ --------------------------------------------\nfunction formatCNPJ(cnpj) {\n  return cnpj.replace(/^(\\d{2})(\\d{3})(\\d{3})(\\d{4})(\\d{2})$/, '$1.$2.$3/$4-$5');\n}\n\n// --- Processa, valida e retorna --------------------------------\nconst cnpjsValidos = todos\n  .filter(validarCNPJ)\n  .map(formatCNPJ);\n\nreturn [\n  {\n    cnpjs_formatados: cnpjsValidos\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2768,1056],"id":"1d6017ca-f0a8-4002-ada7-9eb8f01ab648","name":"get_cnpjs"},{"parameters":{"mode":"combine","fieldsToMatchString":"cnpj_basico","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-2000,976],"id":"2e5c65f9-8c42-4d5d-829f-9fad43d96f21","name":"Merge2"},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"empresa"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-1392,976],"id":"6b92c975-978c-4982-8082-4961945e7d8d","name":"Aggregate1"},{"parameters":{"content":"## Processamento\n- Busca cnpjs listados no banco\n- Retorna informações sobre as empresas achadas\n- Insere em uma lista os cnpjs encontrados, evitando reprocessamento futuro.","height":480,"width":1878,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2992,736],"id":"0bf0cbb9-20e8-4eb9-854b-c8734f738a45","name":"Sticky Note27"},{"parameters":{"useCustomSchema":true,"schema":"cnpj_db","operation":"get","tableId":"estabelecimento","filters":{"conditions":[{"keyName":"cnpj_basico","keyValue":"={{ $json.cnpjs_formatados.match(/\\d+/g)?.join('').slice(0, 8) || '' }}"},{"keyName":"cnpj_dv","keyValue":"={{ $json.cnpjs_formatados.match(/\\d+/g)?.join('').slice(-2) || '' }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2176,864],"id":"fcb4314b-78c2-443a-bdb5-90a62493149f","name":"get_estabelecimento","credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"useCustomSchema":true,"schema":"cnpj_db","operation":"get","tableId":"empresas","filters":{"conditions":[{"keyName":"cnpj_basico","keyValue":"={{ $json.cnpjs_formatados.match(/\\d+/g)?.join('').slice(0, 8) || '' }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2176,1072],"id":"d1f424b1-3458-4973-b82a-2f9c7a864f07","name":"get_empresa","credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}}},{"parameters":{"assignments":{"assignments":[{"id":"3591c64b-80fc-4e25-a156-0774c77add61","name":"empresa.razao_social","value":"={{ $json.razao_social }}","type":"string"},{"id":"ef2171bd-93e5-4c35-8585-ab65644e7753","name":"empresa.cnpj","value":"={{ $json.cnpj_basico }}{{ $json.cnpj_ordem }}{{ $json.cnpj_dv }}","type":"string"},{"id":"f91a680c-4d00-4448-a692-deeaef2e16f6","name":"empresa.nome_fantasia","value":"={{ $json.nome_fantasia }}","type":"string"},{"id":"676a4454-529f-4d68-a61e-9633ad0ce409","name":"empresa.cnae_fiscal","value":"={{ $json.cnae_fiscal }}","type":"string"},{"id":"0636bbba-b479-413c-8b11-414c80b5caf5","name":"empresa.cnae_fiscal_secundaria","value":"={{ $json.cnae_fiscal_secundaria }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1824,976],"id":"ddb3cdfb-4478-4cb5-a8bd-6a724d16fb87","name":"set_empresa"},{"parameters":{"maxItems":500},"type":"n8n-nodes-base.limit","typeVersion":1,"position":[288,1232],"id":"3f617c93-9d8d-40e9-87b6-69090fcd59a8","name":"Limit500"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7bb3aac4-062b-4a3f-823a-864d1aae579d","leftValue":"={{ $json.cnpjs_formatados }}","rightValue":"","operator":{"type":"array","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2576,976],"id":"af31c18b-448f-4a7e-a57b-bf8ad97b72ed","name":"If"},{"parameters":{"content":"## Formata CNPJ.\n- Aplica um código regex.\n- Lista cnpjs formatando os que estão fora de formatação.","height":288,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2832,912],"id":"ba4c5dc0-3fc1-49a3-9966-bf9c2bbbbcec","name":"Sticky Note35"},{"parameters":{"content":"## Mapeia Ufs Únicas.\n- Aplica uma função map().\n- Transforma código em Uf.\n- Mapeia Ufs únicas.","height":288,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[160,1392],"id":"e11883d9-f670-42e5-99fb-26e5f0e07fad","name":"Sticky Note36"},{"parameters":{"operation":"push","list":"={{ $('Webhook').item.json.body.consultaId }}","messageData":"={{ $json.empresa.razao_social }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1616,976],"id":"411d9b3c-b2c8-437a-99f3-d13ddb510571","name":"put","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $('Webhook').item.json.body.consultaId }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2768,-288],"id":"6274e8a3-8d0b-49b8-8ada-50d2c65e6e3e","name":"Delete","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"content":"## Tratativa\n- Limpa a lista de cnpj usados na ultima consulta.","height":272,"width":208},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2816,-416],"id":"1b95274f-c08e-4005-a9be-01665ae5bace","name":"Sticky Note"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c1ae8d5c-3f67-4ce4-8db7-23675a4efe47","leftValue":"={{ $json.body.userId }}","rightValue":"41f1e113-5beb-4de9-860b-1b14375cfdf9","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3248,896],"id":"ed55ee65-28f0-463a-9c46-9ddd24cbbac6","name":"identifica_user_teste"},{"parameters":{"model":"grok-4-fast-non-reasoning","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatXAiGrok","typeVersion":1,"position":[-544,976],"id":"6964470c-2652-4a85-9ad5-1315e877f634","name":"xAI Grok Chat Model","credentials":{"xAiApi":{"id":"zcxLRMJuj2WFdlT7","name":"xAi account"}}},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"Esse banco contem codigos cnae e suas descrições completas, tudo que eles englobam.","tableName":"cnae_vector","topK":50,"options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[-960,1184],"id":"d5fd5d39-7f75-4e27-898a-86fb5dd24a65","name":"Postgres PGVector Store1","credentials":{"postgres":{"id":"MHRHdP7WLUhVnoIo","name":"pgvector"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.embeddingsGoogleGemini","typeVersion":1,"position":[-992,1312],"id":"245743a9-368a-4d5e-b761-c7d8a80957c2","name":"Embeddings Google Gemini1","credentials":{"googlePalmApi":{"id":"NFDJdyFl82zPlGi4","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"jsonSchemaExample":"{\n  \"cnaes_especificos\": {\n    \"lista_cnaes\": [\"4120400\", \"7112000\"],\n    \"justificativa\": \"Estes CNAEs representam a atividade principal de construção de edifícios e serviços de engenharia, que são o núcleo essencial para o projeto de um galpão logístico.\"\n  },\n  \"cnaes_mistos\": {\n    \"lista_cnaes\": [\"7119703\", \"4399101\", \"4292801\"],\n    \"justificativa\": \"Empresas de construção civil frequentemente possuem CNAEs secundários para serviços de desenho técnico, administração de obras e montagem de estruturas metálicas, que são atividades complementares e de apoio ao projeto principal.\"\n  },\n  \"cnaes_generalistas\": {\n    \"lista_cnaes\": [\"4299599\", \"8211300\"],\n    \"justificativa\": \"Estes CNAEs são mais abrangentes, como 'outras obras de engenharia civil' e 'serviços combinados de escritório e apoio administrativo', permitindo encontrar empresas maiores ou com um escopo de atuação mais diversificado que também podem executar o projeto.\"\n  }\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-736,1056],"id":"655d893b-c3fa-4a58-b27e-b29e2a773e28","name":"Structured Output Parser"},{"parameters":{"promptType":"define","text":"=Segmento: {{ $json.segmento }}\nProjeto: {{ $json.descricao }}\nExemplos_CNAES: {{ $json.cnpjs }}","hasOutputParser":true,"options":{"systemMessage":"=## Papel\n\nVocê é um **Especialista em Classificação Nacional de Atividades Econômicas (CNAE)** do Brasil, com domínio técnico da estrutura hierárquica e semântica das atividades econômicas.  \nSua função é **identificar e justificar** os CNAEs mais adequados para representar **fornecedores**, com base no **segmento** e no **escopo de um projeto**.\n\n---\n\n## Objetivo\n\nGerar **três listas de códigos CNAE** — **Específicos**, **Mistos** e **Generalistas** — **baseando-se exclusivamente em evidências retornadas pelo banco vetorial `cnae_vector`**.\n\n> **Regra obrigatória:**  \n> O agente **NÃO PODE INVENTAR, INFERIR, CRIAR OU ADICIONAR CNAEs** que não estejam entre os registros efetivamente retornados pela consulta vetorial.  \n> **Apenas CNAEs provenientes do resultado da busca no banco `cnae_vector` podem ser utilizados.**  \n> Qualquer código CNAE não presente nos registros consultados deve ser ignorado, mesmo que pareça logicamente relacionado.\n\nO banco contém embeddings dos textos oficiais do CNAE, com campos como:\n\n- `pageContent`: descrição textual detalhada  \n- `metadata`: inclui `cnae`, `denominacao`, `cnae_secao`, `cnae_divisao`, `cnae_grupo`\n\n---\n\n## Instruções de Execução (com RAG)\n\n### 1. Compreensão do contexto  \nLeia e compreenda:\n- **Segmento** → ramo principal de atuação do fornecedor  \n- **Projeto** → escopo detalhado do trabalho a ser executado  \n- **Exemplos_CNAES** (opcional) → lista de referência de CNAEs conhecidos\n\n---\n\n### 2. Consulta ao Banco Vetorizado (`cnae_vector`)  \nGere embeddings das variáveis `Segmento`, `Projeto` (e `Exemplos_CNAES`, se houver) e realize uma **busca vetorial** no banco `cnae_vector`.  \n\nRecupere os registros **mais semanticamente semelhantes**, priorizando aqueles cujo `pageContent` e `metadata.denominacao` descrevem atividades compatíveis com o projeto.\n\nCada registro retornado possui o formato:\n\n```json\n{\n  \"metadata\": {\n    \"source\": \"blob\",\n    \"blobType\": \"text/plain\",\n    \"loc\": {\n      \"lines\": {\n        \"from\": 1,\n        \"to\": 6\n      }\n    },\n    \"cnae\": \"01.11-3 Cultivo de cereais\",\n    \"denominacao\": \"Cultivo de arroz\",\n    \"cnae_secao\": \"PRODUÇÃO DE LAVOURAS TEMPORÁRIAS\",\n    \"cnae_divisao\": \"01\",\n    \"cnae_grupo\": \"01.1\"\n  },\n  \"pageContent\": \"codigo:01113/01 Cultivo de arroz\\ndenominacao:Cultivo de arroz\\nsecao:PRODUÇÃO DE LAVOURAS TEMPORÁRIAS\\nclasse:01.11-3 Cultivo de cereais\\nescopo:Compreende também: o beneficiamento de arroz em estabelecimento agrícola, quando atividade complementar ao cultivo; a produção de sementes de arroz, quando atividade complementar ao cultivo. Não compreende: a produção de sementes certificadas de arroz (0141-5/01), serviços sob contrato (0161-0/03), beneficiamento sob contrato (0163-6/00), produção de óleo de arroz (1041-4/00) e beneficiamento em estabelecimento não-agrícola (1061-9/01).\"\n}\n```\n\n---\n\n## Classificação dos CNAEs Recuperados\n\nO agente deve **classificar apenas** os CNAEs **existentes entre os registros retornados do banco vetorial**.  \nA classificação deve respeitar a **estrutura hierárquica oficial do CNAE**.\n\n| Nível | Descrição | Exemplo (CNAE 4723-7/00) |\n|-------|------------|---------------------------|\n| **Divisão** | Dois primeiros dígitos: representam o setor econômico mais amplo. | 47 — Comércio Varejista de Alimentos, Bebidas e Fumo |\n| **Grupo** | Três primeiros dígitos: definem o agrupamento de atividades relacionadas. | 472 — Comércio Varejista de Produtos Alimentícios, Bebidas e Fumo |\n| **Classe** | Quatro primeiros dígitos + dígito verificador: especificam a atividade principal. | 4723-7 — Comércio Varejista de Bebidas |\n| **Subclasse** | Sete dígitos completos: detalham o tipo específico de operação. | 4723-7/00 — Comércio Varejista de Bebidas |\n\n---\n\n### a) CNAEs Específicos\n\n* Correspondem às **subclasses ou classes** diretamente associadas à execução do projeto.  \n* Representam a **atividade-fim** do fornecedor, de forma direta e inequívoca.  \n* Identificáveis por descrições muito próximas à atividade central no `pageContent`.  \n* Exemplo: se o projeto envolve **instalação elétrica predial**, o CNAE específico seria `4321-5/00 - Instalações elétricas`.\n\n---\n\n### b) CNAEs Mistos\n\n* Correspondem a **atividades complementares ou auxiliares** que costumam ocorrer **dentro do mesmo grupo ou divisão** que o CNAE principal.  \n* São **atividades correlatas** que podem coexistir na mesma empresa, normalmente dentro da **mesma cadeia produtiva**.  \n* Identificáveis quando o `pageContent` descreve funções de apoio, preparação, acabamento ou serviços acessórios.  \n* Exemplo: em um projeto de **obras de construção**, CNAEs mistos podem incluir `4399-1/01 - Serviços de preparação de terreno` e `4322-3/01 - Instalações hidráulicas, sanitárias e de gás`.\n\n---\n\n### c) CNAEs Generalistas\n\n* Representam **categorias amplas**, normalmente localizadas em **níveis superiores (divisão ou grupo)** da hierarquia CNAE.  \n* Abrangem múltiplas classes ou subclasses e são usados quando o fornecedor possui **atuação diversificada**.  \n* Frequentemente contêm expressões genéricas como \"outros\" ou \"não especificados anteriormente\".  \n* Exemplo: `4299-5/99 - Outras obras de engenharia civil não especificadas anteriormente`.\n\n---\n\n## Limpeza e Normalização\n\n* Remova **duplicatas** entre as três listas (priorize CNAEs Específicos).  \n* Formate todos os códigos para conter apenas **números**, ex: `01.11-3` → `\"01113\"`.  \n* **Não adicione, não altere e não deduza CNAEs.**  \n  Todos os CNAEs incluídos no resultado **devem existir nos registros retornados pela busca vetorial.**\n\n---\n\n## Validação Final (Obrigatória)\n\nAntes de gerar a resposta final:\n1. Verifique se **todos os CNAEs listados** existem **dentro dos registros retornados do banco vetorial**.  \n2. Caso algum CNAE não esteja presente, **remova-o imediatamente**.  \n3. Se nenhum CNAE for encontrado, retorne listas vazias com justificativa correspondente, **sem criar ou sugerir novos códigos**.\n4. Garanta o envio do maior número de códigos possíveis em cada lista, quero que cnaes mistos e generalistas tenham pelo menos 4 códigos na lista e cnaes específicos tenham pelo menos 2.\n5. Garanta que os cnaes enviados manteram todos os seus 7 dígitos, incluindo a subclasse, cnaes com qualquer numero de dígitos diferente de 7 não serão aceitos.\n\n---\n\n## Retorno Formatado\n\nResponda **somente com JSON válido**, sem texto adicional fora da estrutura.  \nA resposta deve seguir **exatamente** o formato abaixo:\n\n```json\n{\n  \"cnaes_especificos\": {\n    \"lista_cnaes\": [\"4120400\", \"7112000\"],\n    \"justificativa\": \"Estes CNAEs representam a atividade principal e diretamente associada ao projeto descrito.\"\n  },\n  \"cnaes_mistos\": {\n    \"lista_cnaes\": [\"7119703\", \"4399101\", \"4292801\",\"4292803\"],\n    \"justificativa\": \"CNAEs que representam atividades complementares dentro da mesma cadeia produtiva ou grupo econômico do CNAE principal.\"\n  },\n  \"cnaes_generalistas\": {\n    \"lista_cnaes\": [\"4299599\", \"8211300\",\"8312399\",\"8514399\"],\n    \"justificativa\": \"CNAEs amplos, localizados em níveis superiores da hierarquia, usados para empresas de escopo mais abrangente.\"\n  }\n}\n```\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-960,912],"id":"ede95163-f3c3-43ad-8902-2aab5317d5b0","name":"cnae","retryOnFail":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c51e1c96-4523-4ce8-9cd6-bfcfa96d7c32","leftValue":"={{ $json.status }}","rightValue":"concluida","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1104,864],"id":"7c6fa20c-e900-4d1c-8d39-62aedc7c1e96","name":"concluido?"},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"get","tableId":"consultas","filters":{"conditions":[{"keyName":"id","keyValue":"={{ $('Webhook').item.json.body.consultaId}}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[912,864],"id":"50f4dde2-c1ab-445b-b508-0097ac391899","name":"get_status_consulta","alwaysOutputData":false,"executeOnce":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}},"onError":"continueErrorOutput"},{"parameters":{"modelName":"models/gemini-2.5-pro","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-1024,1088],"id":"bf298f9a-a0da-44a9-9d1e-970e0fadbef6","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"NFDJdyFl82zPlGi4","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"amount":120},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1280,880],"id":"bef010d9-d588-457a-9d0c-be4f4cf1866b","name":"Wait","webhookId":"51c540e0-675a-418e-bdb9-838cebc21238"},{"parameters":{"amount":120},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[2176,880],"id":"84946189-3eab-454c-87a1-e8f3b71da049","name":"Wait1","webhookId":"51c540e0-675a-418e-bdb9-838cebc21238"},{"parameters":{"amount":180},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[3232,896],"id":"ff7576a9-26b5-4cf4-97d3-0f60c9ba5141","name":"Wait2","webhookId":"51c540e0-675a-418e-bdb9-838cebc21238"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c51e1c96-4523-4ce8-9cd6-bfcfa96d7c32","leftValue":"={{ $json.status }}","rightValue":"concluida","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2752,880],"id":"779ec83a-ad64-4076-81b8-c46e5519749b","name":"concluido?-"},{"parameters":{"useCustomSchema":true,"schema":"busca_fornecedor","operation":"get","tableId":"consultas","filters":{"conditions":[{"keyName":"id","keyValue":"={{ $('Webhook').item.json.body.consultaId}}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2560,880],"id":"ea9ba5a3-c551-4ee4-acf9-d55d1d386cbd","name":"get_status_consulta2","alwaysOutputData":false,"executeOnce":true,"credentials":{"supabaseApi":{"id":"iSQjasVk6wzJgBch","name":"Supabase account"}},"onError":"continueErrorOutput"},{"parameters":{"workflowId":{"__rl":true,"value":"L9fLonmlIExLqHQz","mode":"list","cachedResultUrl":"/workflow/L9fLonmlIExLqHQz","cachedResultName":"Fallback"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Id_consulta":"={{ $json.id }}","termos":"={{ $('filtros_supabase_especifica').item.json._termos.toJsonString() }}","cnaes":"={{ $('filtros_supabase_especifica').item.json._cnaes.toJsonString() }}","uf":"={{ $('filtros_supabase_especifica').item.json._uf_filtro.toJsonString() }}","data_limite":"={{ $('filtros_supabase_especifica').item.json._data_limite }}","porte_empresa":"={{ $('filtros_supabase_especifica').item.json._porte_empresa.toJsonString() }}","natureza_juridica":"={{ $('filtros_supabase_especifica').item.json._natureza_juridica.toJsonString() }}","municipio":"={{ $('filtros_supabase_especifica').item.json._codigo_municipio }}","escopo":"={{ $('filtros_supabase_especifica').item.json.escopo_segmento }}"},"matchingColumns":[],"schema":[{"id":"Id_consulta","displayName":"Id_consulta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"termos","displayName":"termos","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"cnaes","displayName":"cnaes","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"uf","displayName":"uf","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"data_limite","displayName":"data_limite","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"porte_empresa","displayName":"porte_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"natureza_juridica","displayName":"natureza_juridica","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"municipio","displayName":"municipio","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"escopo","displayName":"escopo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[3408,752],"id":"8062a39b-3230-44c3-83d0-7265489e5d57","name":"Fallback"},{"parameters":{"operation":"push","list":"={{ $('Webhook').item.json.body.consultaId }}-data","messageData":"={{ $json.data.toJsonString() }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[560,864],"id":"2b9568ce-84cb-442d-97be-b58f07e2f4d5","name":"put1","credentials":{"redis":{"id":"e8TEVWEpT7yUTHVI","name":"Redis account"}}},{"parameters":{"assignments":{"assignments":[{"id":"dcc3e63e-44cd-4355-aae5-09d6f9346184","name":"data._cnaes","value":"={{ $json._cnaes }}","type":"array"},{"id":"07984747-0265-44d3-b863-ea404aa4873c","name":"data._uf_filtro","value":"={{ $json._uf_filtro }}","type":"array"},{"id":"bd616a7b-2e44-4b35-9867-6042d95855d8","name":"data._data_limite","value":"={{ $json._data_limite }}","type":"string"},{"id":"10e5bad0-e8d6-450c-9117-6bf58ca6ba6c","name":"data._termos","value":"={{ $json._termos }}","type":"array"},{"id":"5456b390-514d-440b-9881-dd0ca9887d37","name":"data._porte_empresa","value":"={{ $json._porte_empresa }}","type":"array"},{"id":"14448f50-cb44-4741-aa30-7fb5258df582","name":"data._natureza_juridica","value":"={{ $json._natureza_juridica }}","type":"array"},{"id":"832b166a-72c8-480b-bf39-4a3c07e6afac","name":"data._codigo_municipio","value":"={{ $json._codigo_municipio }}","type":"string"},{"id":"179177a3-e01f-4cc5-84c3-4f041ca46488","name":"data.escopo_segmento","value":"={{ $json.escopo_segmento }}","type":"string"},{"id":"6d510210-54dc-4127-af58-32334fbc28b0","name":"data.range_busca","value":"={{ $json.range_busca }}","type":"string"},{"id":"2602730d-a23d-49ed-8ab6-57fc5032a8da","name":"data.body.consultaId","value":"={{ $json.body.consultaId }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[368,864],"id":"ff0f497d-ab6d-4ad9-b1a2-61ed39171770","name":"set_data_redis"}],"connections":{"Merge":{"main":[[{"node":"filtros_supabase_especifica","type":"main","index":0}]]},"Structured Output Parser2":{"ai_outputParser":[[{"node":"termos_razao_social","type":"ai_outputParser","index":0}]]},"termos_razao_social":{"main":[[{"node":"Merge","type":"main","index":1}]]},"filtros_supabase_especifica":{"main":[[{"node":"set_data_redis","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"identifica_user_teste","type":"main","index":0}]]},"sub_busca_especifica":{"main":[[{"node":"get_status_consulta","type":"main","index":0}]]},"sub_busca_mista":{"main":[[{"node":"get_status_consulta1","type":"main","index":0}]]},"sub_busca_geral":{"main":[[{"node":"get_status_consulta2","type":"main","index":0}]]},"set_data":{"main":[[{"node":"tipo_busca","type":"main","index":0},{"node":"termos_razao_social","type":"main","index":0},{"node":"get_ano_limite","type":"main","index":0},{"node":"cnae","type":"main","index":0}]]},"get_ano_limite":{"main":[[{"node":"Merge","type":"main","index":0}]]},"tipo_busca":{"main":[[{"node":"Merge","type":"main","index":3}],[{"node":"acha_cidade","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"lista_cidades","type":"main","index":0},{"node":"set_ufs_unicas","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"lista_cidades":{"main":[[{"node":"Limit500","type":"main","index":0}]]},"Get_codes":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"Merge","type":"main","index":3}]]},"set_ufs_unicas":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"concluido?-2":{"main":[[],[{"node":"Wait1","type":"main","index":0}]]},"acha_cidade":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"cnpj_vazio":{"main":[[{"node":"set_data","type":"main","index":0}],[{"node":"get_cnpjs","type":"main","index":0}]]},"get_status_consulta1":{"main":[[{"node":"concluido?-2","type":"main","index":0}],[{"node":"concluido?-2","type":"main","index":0}]]},"Split Out1":{"main":[[{"node":"get_estabelecimento","type":"main","index":0},{"node":"get_empresa","type":"main","index":0}]]},"get_cnpjs":{"main":[[{"node":"If","type":"main","index":0}]]},"Merge2":{"main":[[{"node":"set_empresa","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"set_data","type":"main","index":0}]]},"get_estabelecimento":{"main":[[{"node":"Merge2","type":"main","index":0}]]},"get_empresa":{"main":[[{"node":"Merge2","type":"main","index":1}]]},"set_empresa":{"main":[[{"node":"put","type":"main","index":0}]]},"Limit500":{"main":[[{"node":"Get_codes","type":"main","index":0}]]},"If":{"main":[[{"node":"set_data","type":"main","index":0}],[{"node":"Split Out1","type":"main","index":0}]]},"put":{"main":[[{"node":"Aggregate1","type":"main","index":0}]]},"conclui_busca":{"main":[[]]},"identifica_user_teste":{"main":[[{"node":"cnpj_vazio","type":"main","index":0}],[]]},"xAI Grok Chat Model":{"ai_languageModel":[[{"node":"termos_razao_social","type":"ai_languageModel","index":0}]]},"Postgres PGVector Store1":{"ai_tool":[[{"node":"cnae","type":"ai_tool","index":0}]]},"Embeddings Google Gemini1":{"ai_embedding":[[{"node":"Postgres PGVector Store1","type":"ai_embedding","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"cnae","type":"ai_outputParser","index":0}]]},"cnae":{"main":[[{"node":"Merge","type":"main","index":2}]]},"concluido?":{"main":[[{"node":"Fallback","type":"main","index":0}],[{"node":"Wait","type":"main","index":0}]]},"get_status_consulta":{"main":[[{"node":"concluido?","type":"main","index":0}],[{"node":"concluido?","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"cnae","type":"ai_languageModel","index":0}]]},"Wait":{"main":[[{"node":"sub_busca_mista","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"sub_busca_geral","type":"main","index":0}]]},"get_status_consulta2":{"main":[[{"node":"concluido?-","type":"main","index":0}],[{"node":"concluido?-","type":"main","index":0}]]},"Wait2":{"main":[[]]},"concluido?-":{"main":[[],[{"node":"Wait2","type":"main","index":0}]]},"Fallback":{"main":[[{"node":"conclui_busca","type":"main","index":0}]]},"set_data_redis":{"main":[[{"node":"put1","type":"main","index":0}]]},"put1":{"main":[[{"node":"sub_busca_especifica","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"primary-kpc3-buscafornecedor.up.railway.app","user-agent":"Deno/2.1.4 (variant; SupabaseEdgeRuntime/1.69.25)","content-length":"363","accept":"application/json","accept-encoding":"gzip,br","accept-language":"*","content-type":"application/json","x-forwarded-for":"18.228.138.0","x-forwarded-host":"primary-kpc3-buscafornecedor.up.railway.app","x-forwarded-proto":"https","x-railway-edge":"railway/us-east4-eqdc4a","x-railway-request-id":"50W5hqZ5TKOHEWvmCx5-qw","x-real-ip":"18.228.138.0","x-request-start":"1765201313701"},"params":{},"query":{},"body":{"consultaId":"751c95c2-900e-446a-99fc-8e4c667b9d22","parametros":{"descricao":"Compra de Agrotóxicos para lavoura de café","segmento":"Agro","tipo_busca":"uf","ufs_selecionadas":["MG"],"cnpjs_existentes":"","tempo_minimo_empresa":"1"},"userId":"41f1e113-5beb-4de9-860b-1b14375cfdf9","sessionId":null,"tierBusca":"normal","timestamp":"2025-12-08T13:41:53.004Z"},"webhookUrl":"https://primary-kpc3-buscafornecedor.up.railway.app/webhook/cenario-teste","executionMode":"production"}}]},"versionId":"b9a94e4a-c1db-4007-8250-d73e5d132d97","triggerCount":1,"shared":[{"updatedAt":"2025-10-14T19:47:13.071Z","createdAt":"2025-10-14T19:47:13.071Z","role":"workflow:owner","workflowId":"ytRGmvFPtO0ZMn2u","projectId":"jk0yZKautC5L7CBp"}],"tags":[{"updatedAt":"2025-10-14T19:47:01.394Z","createdAt":"2025-10-14T19:47:01.394Z","id":"cuEnFeSTWYUSoPc7","name":"test"}]}